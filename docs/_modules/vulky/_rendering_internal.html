

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>vulky._rendering_internal &mdash; vulky 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=8d563738"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            vulky
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../generated/vulky.html">vulky</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">vulky</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">vulky._rendering_internal</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for vulky._rendering_internal</h1><div class="highlight"><pre>
<span></span><span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">imgui</span>
    <span class="n">__GUI_AVAILABLE__</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">__GUI_AVAILABLE__</span> <span class="o">=</span> <span class="kc">False</span>

<span class="kn">from</span> <span class="nn">._common</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">._vulkan_memory_allocator</span> <span class="kn">import</span> <span class="n">VulkanMemory</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">_vulkan_internal</span> <span class="k">as</span> <span class="n">_internal</span>
<span class="kn">from</span> <span class="nn">._vulkan_internal</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">ShaderHandlerWrapper</span> <span class="k">as</span> <span class="n">ShaderHandler</span><span class="p">,</span>
    <span class="n">FrameBufferWrapper</span> <span class="k">as</span> <span class="n">FrameBuffer</span><span class="p">,</span>
    <span class="n">SamplerWrapper</span> <span class="k">as</span> <span class="n">Sampler</span>
<span class="p">)</span>
<span class="kn">import</span> <span class="nn">torch</span> <span class="k">as</span> <span class="nn">_torch</span>
<span class="kn">import</span> <span class="nn">typing</span> <span class="k">as</span> <span class="nn">_typing</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">_np</span>


<span class="n">__TRACE_WRAP__</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="compile_shader_source">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.compile_shader_source">[docs]</a>
<span class="k">def</span> <span class="nf">compile_shader_source</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">stage</span><span class="p">,</span> <span class="n">include_dirs</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">subprocess</span>
    <span class="kn">import</span> <span class="nn">os</span>
    <span class="n">idirs</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot; -I</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">d</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2"> &quot;</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">include_dirs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;nt&#39;</span><span class="p">:</span>  <span class="c1"># Windows</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expandvars</span><span class="p">(</span>
                <span class="s1">&#39;%VULKAN_SDK%/Bin/glslangValidator.exe --stdin -r -Os -V --target-env vulkan1.2 &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
            <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;-S </span><span class="si">{</span><span class="n">stage</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">idirs</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span>
        <span class="p">)</span>
        <span class="n">outs</span><span class="p">,</span> <span class="n">errs</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">(</span><span class="n">code</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># Assuming Linux</span>
        <span class="c1"># Quick monkeyhack for linux based distribution</span>
        <span class="kn">import</span> <span class="nn">shlex</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>
            <span class="n">shlex</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expandvars</span><span class="p">(</span><span class="s1">&#39;/usr/bin/glslangValidator --stdin -r -V --target-env vulkan1.3 &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span>
                                                                                                      <span class="s2">&quot;/&quot;</span><span class="p">)</span>
                <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;-S </span><span class="si">{</span><span class="n">stage</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">idirs</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">),</span> <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span>
        <span class="p">)</span>
        <span class="n">outs</span><span class="p">,</span> <span class="n">errs</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">(</span><span class="n">code</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
    <span class="n">perr</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">perr</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">numbered_code</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="se">\t\t</span><span class="si">{</span><span class="n">l</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">code</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[ERROR] Compilation failed&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">outs</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot compile </span><span class="si">{</span><span class="n">numbered_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">stage</span><span class="si">}</span><span class="s1">.spv&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">binary_output</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># print(code)</span>
    <span class="c1"># print(f&#39;[INFO] Compiled code for {stage}&#39;)</span>
    <span class="k">return</span> <span class="n">binary_output</span></div>



<div class="viewcode-block" id="compile_shader_source_file">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.compile_shader_source_file">[docs]</a>
<span class="k">def</span> <span class="nf">compile_shader_source_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">stage</span><span class="p">,</span> <span class="n">binary_file_name</span><span class="p">,</span> <span class="n">include_dirs</span><span class="o">=</span><span class="p">[]):</span>
    <span class="kn">import</span> <span class="nn">subprocess</span>
    <span class="kn">import</span> <span class="nn">os</span>
    <span class="n">idirs</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;-I</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">d</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">include_dirs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;nt&#39;</span><span class="p">:</span>  <span class="c1"># Windows</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expandvars</span><span class="p">(</span>
                <span class="s1">&#39;%VULKAN_SDK%/Bin/glslangValidator.exe -r -V --target-env vulkan1.2 &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
            <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;-S </span><span class="si">{</span><span class="n">stage</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">idirs</span><span class="si">}</span><span class="s1"> </span><span class="se">\&quot;</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="se">\&quot;</span><span class="s1"> -o </span><span class="se">\&quot;</span><span class="si">{</span><span class="n">binary_file_name</span><span class="si">}</span><span class="se">\&quot;</span><span class="s1">&#39;</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># Assuming Linux</span>
        <span class="c1"># Quick monkeyhack for linux based distribution</span>
        <span class="kn">import</span> <span class="nn">shlex</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>
            <span class="n">shlex</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expandvars</span><span class="p">(</span><span class="s1">&#39;/usr/bin/glslangValidator -r -V --target-env vulkan1.2 &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span>
                                                                                                      <span class="s2">&quot;/&quot;</span><span class="p">)</span>
                <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;-S </span><span class="si">{</span><span class="n">stage</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">idirs</span><span class="si">}</span><span class="s1"> </span><span class="se">\&quot;</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="se">\&quot;</span><span class="s1"> -o </span><span class="se">\&quot;</span><span class="si">{</span><span class="n">binary_file_name</span><span class="si">}</span><span class="se">\&quot;</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot compile </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

    <span class="c1"># print(f&#39;[INFO] Compiled... {filename}&#39;)</span>


<span class="n">__HEADER_LAST_MODIFIED_TIME__</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">_get_last_modified_time_for_headers_at</span><span class="p">(</span><span class="n">d</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">os</span>
    <span class="k">if</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">__HEADER_LAST_MODIFIED_TIME__</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">__HEADER_LAST_MODIFIED_TIME__</span><span class="p">[</span><span class="n">d</span><span class="p">]</span>

    <span class="n">last_modified_time</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">d</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">f</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.h&#39;</span><span class="p">):</span> <span class="c1"># header</span>
                <span class="n">last_modified_time</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">last_modified_time</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">last_modified_time</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">last_modified_time</span><span class="p">,</span> <span class="n">_get_last_modified_time_for_headers_at</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
    <span class="n">__HEADER_LAST_MODIFIED_TIME__</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="n">last_modified_time</span>
    <span class="k">return</span> <span class="n">last_modified_time</span>


<span class="k">def</span> <span class="nf">_get_last_modified_time_for_headers_included</span><span class="p">(</span><span class="n">include_dirs</span><span class="p">:</span> <span class="n">_typing</span><span class="o">.</span><span class="n">List</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">_get_last_modified_time_for_headers_at</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">include_dirs</span><span class="p">)</span>


<div class="viewcode-block" id="compile_shader_file">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.compile_shader_file">[docs]</a>
<span class="k">def</span> <span class="nf">compile_shader_file</span><span class="p">(</span><span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">include_dirs</span><span class="p">:</span> <span class="n">_typing</span><span class="o">.</span><span class="n">List</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">os</span>
    <span class="n">filename_without_extension</span><span class="p">,</span> <span class="n">extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">binary_file</span> <span class="o">=</span> <span class="n">filename_without_extension</span> <span class="o">+</span> <span class="s2">&quot;.spv&quot;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">binary_file</span><span class="p">):</span>
        <span class="c1"># Check if it is valid</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="n">binary_file</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">max</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="n">_get_last_modified_time_for_headers_included</span><span class="p">(</span><span class="n">include_dirs</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">binary_file</span>  <span class="c1"># compiled and uptodate</span>
    <span class="k">assert</span> <span class="n">extension</span> <span class="o">==</span> <span class="s1">&#39;.glsl&#39;</span>
    <span class="n">stage</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename_without_extension</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>  <span class="c1"># [1:] for removing the dot .</span>
    <span class="n">compile_shader_source_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">stage</span><span class="p">,</span> <span class="n">binary_file</span><span class="p">,</span> <span class="n">include_dirs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">binary_file</span></div>



<div class="viewcode-block" id="compile_shader_sources">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.compile_shader_sources">[docs]</a>
<span class="k">def</span> <span class="nf">compile_shader_sources</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">force_all</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">os</span>
    <span class="k">def</span> <span class="nf">needs_to_update</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">binary</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="n">source</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
    <span class="n">directory</span> <span class="o">=</span> <span class="n">directory</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">directory</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">filename</span>
        <span class="n">filename_without_extension</span><span class="p">,</span> <span class="n">extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">extension</span> <span class="o">==</span> <span class="s1">&#39;.glsl&#39;</span><span class="p">:</span>
            <span class="n">stage</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename_without_extension</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>  <span class="c1"># [1:] for removing the dot .</span>
            <span class="n">binary_file</span> <span class="o">=</span> <span class="n">filename_without_extension</span> <span class="o">+</span> <span class="s2">&quot;.spv&quot;</span>
            <span class="k">if</span> <span class="n">needs_to_update</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">binary_file</span><span class="p">)</span> <span class="ow">or</span> <span class="n">force_all</span><span class="p">:</span>
                <span class="n">compile_shader_source_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">stage</span><span class="p">,</span> <span class="n">binary_file</span><span class="p">)</span></div>



<div class="viewcode-block" id="Resource">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.Resource">[docs]</a>
<span class="k">class</span> <span class="nc">Resource</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class of all vulky resources.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="Resource.__init__">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.Resource.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">w_resource</span><span class="p">:</span> <span class="n">_internal</span><span class="o">.</span><span class="n">ResourceWrapper</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_resource</span> <span class="o">=</span> <span class="n">w_resource</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span></div>


    <span class="nd">@lazy_constant</span>
    <span class="k">def</span> <span class="nf">is_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets if the resource is a buffer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_resource</span><span class="o">.</span><span class="n">resource_data</span><span class="o">.</span><span class="n">is_buffer</span>

    <span class="nd">@lazy_constant</span>
    <span class="k">def</span> <span class="nf">is_ads</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets if the resource is an acceleration data-structure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_resource</span><span class="o">.</span><span class="n">resource_data</span><span class="o">.</span><span class="n">is_ads</span>

    <span class="nd">@lazy_constant</span>
    <span class="k">def</span> <span class="nf">is_image</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets if the resource is an image.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_resource</span><span class="o">.</span><span class="n">resource_data</span><span class="o">.</span><span class="n">is_buffer</span>

    <span class="nd">@lazy_constant</span>
    <span class="k">def</span> <span class="nf">is_on_cpu</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets if the resource is located in host memory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_resource</span><span class="o">.</span><span class="n">resource_data</span><span class="o">.</span><span class="n">is_cpu</span>

    <span class="nd">@lazy_constant</span>
    <span class="k">def</span> <span class="nf">is_on_gpu</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets if the resource is located in device memory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_resource</span><span class="o">.</span><span class="n">resource_data</span><span class="o">.</span><span class="n">is_gpu</span>

<div class="viewcode-block" id="Resource.clear">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.Resource.clear">[docs]</a>
    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Resource&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clears current resource with 0 values. This operation is costly.</span>
<span class="sd">        Consider clearing the resources as part of a custom manager.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Return the same object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_resource</span><span class="o">.</span><span class="n">clear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">w_device</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="Resource.load">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.Resource.load">[docs]</a>
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads information from `src_data` if it is possible. Possibilities are:</span>
<span class="sd">        If `src_data` is another Resource then Buffer-Buffer, Buffer-Image, Image-Buffer or Image-Image copy is performed.</span>
<span class="sd">        If `src_data` is a list, then depending on the resource type list is cast to int or float.</span>
<span class="sd">        If `src_data` is a tensor or numpy array data is copied as a buffer.</span>
<span class="sd">        If `src_data` is another type, then conversion to numpy or torch is tried.</span>

<span class="sd">        Note</span>
<span class="sd">        ----</span>
<span class="sd">        If current resource is an image (with potential subresources), `src_data` size should</span>
<span class="sd">        match the linearized version of the image, not the real layout on GPU.</span>
<span class="sd">        Byte size should match. Different image formats can not be copied with this method.</span>
<span class="sd">        Use blit operation instead.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">src_data</span> <span class="ow">is</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">src_data</span><span class="p">,</span> <span class="n">Resource</span><span class="p">):</span>
            <span class="n">src_data</span> <span class="o">=</span> <span class="n">src_data</span><span class="o">.</span><span class="n">w_resource</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_resource</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">w_device</span><span class="p">,</span> <span class="n">src_data</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="Resource.save">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.Resource.save">[docs]</a>
    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dst_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Saves information to `dst_data` if it is possible. Possibilities are:</span>
<span class="sd">        If `dst_data` is another Resource then Buffer-Buffer, Buffer-Image, Image-Buffer or Image-Image copy is performed.</span>
<span class="sd">        If `dst_data` is a tensor or numpy array data is copied as a buffer.</span>
<span class="sd">        If `dst_data` is another type, then conversion to numpy or torch is tried whenever memory is direct.</span>

<span class="sd">        Note</span>
<span class="sd">        ----</span>
<span class="sd">        If current resource is an image (with potential subresources), `dst_data` size should</span>
<span class="sd">        match the linearized version of the image, not the real layout on GPU.</span>
<span class="sd">        Byte size should match. Different image formats can not be copied with this method.</span>
<span class="sd">        Use blit operation instead.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dst_data</span> <span class="ow">is</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dst_data</span><span class="p">,</span> <span class="n">Resource</span><span class="p">):</span>
            <span class="n">dst_data</span> <span class="o">=</span> <span class="n">dst_data</span><span class="o">.</span><span class="n">w_resource</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_resource</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">w_device</span><span class="p">,</span> <span class="n">dst_data</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>


    <span class="nd">@lazy_constant</span>
    <span class="k">def</span> <span class="nf">cuda_ptr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the pointer of this resource in the memory exported to cuda.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_resource</span><span class="o">.</span><span class="n">cuda_ptr</span>

    <span class="nd">@lazy_constant</span>
    <span class="k">def</span> <span class="nf">device_ptr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the pointer of this resource in the device memory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_resource</span><span class="o">.</span><span class="n">device_ptr</span>

    <span class="nd">@lazy_constant</span>
    <span class="k">def</span> <span class="nf">cpu_ptr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_resource</span><span class="o">.</span><span class="n">cpu_ptr</span>

    <span class="nd">@lazy_constant</span>
    <span class="k">def</span> <span class="nf">size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the size in bytes of this resource.</span>
<span class="sd">        In case of images the size is the linearized size.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Not implemented&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="ObjectBufferAccessor">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.ObjectBufferAccessor">[docs]</a>
<span class="k">class</span> <span class="nc">ObjectBufferAccessor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Auxiliar class to access resource mapped memory efficiently through dot notation</span>
<span class="sd">    and indexing.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    &gt;&gt;&gt; import vulky as vk</span>
<span class="sd">    &gt;&gt;&gt; b = vk.object_buffer(vk.Layout.from_structure(</span>
<span class="sd">    &gt;&gt;&gt;     light_position=vk.vec3,</span>
<span class="sd">    &gt;&gt;&gt;     light_intensity=vk.vec3,</span>
<span class="sd">    &gt;&gt;&gt; ))</span>
<span class="sd">    &gt;&gt;&gt; with b as data:</span>
<span class="sd">    &gt;&gt;&gt;     # data is an object buffer accessor</span>
<span class="sd">    &gt;&gt;&gt;     data.light_position = vk.vec3(0.0, 3.0, 0.0)</span>
<span class="sd">    &gt;&gt;&gt;     data.light_intensity = vk.vec3(1.0, 1.0, 0.0)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_rdv_memory</span><span class="p">:</span> <span class="nb">memoryview</span> <span class="o">=</span> <span class="kc">None</span>      <span class="c1"># memory of the whole object</span>
    <span class="n">_rdv_layout</span><span class="p">:</span> <span class="n">Layout</span> <span class="o">=</span> <span class="kc">None</span>      <span class="c1"># layout for the whole object</span>
    <span class="n">_rdv_fields</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span>      <span class="c1"># gets precomputed accessors, tensors or references</span>

<div class="viewcode-block" id="ObjectBufferAccessor.__init__">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.ObjectBufferAccessor.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">memory</span><span class="p">:</span> <span class="nb">memoryview</span><span class="p">,</span> <span class="n">layout</span><span class="p">:</span> <span class="n">Layout</span><span class="p">):</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_rdv_memory&#39;</span><span class="p">,</span> <span class="n">memory</span><span class="p">)</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_rdv_layout&#39;</span><span class="p">,</span> <span class="n">layout</span><span class="p">)</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_rdv_fields&#39;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_build</span><span class="p">()</span></div>


    <span class="k">def</span> <span class="nf">_collect_references</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="nb">set</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rdv_fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rdv_layout</span><span class="o">.</span><span class="n">is_structure</span><span class="p">:</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">layout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rdv_layout</span><span class="o">.</span><span class="n">fields_layout</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># is_array</span>
                <span class="n">layout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rdv_layout</span><span class="o">.</span><span class="n">element_layout</span>
            <span class="k">if</span> <span class="n">layout</span><span class="o">.</span><span class="n">scalar_format</span> <span class="o">==</span> <span class="s1">&#39;Q&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span> <span class="c1"># Reference without object</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">layout</span><span class="o">.</span><span class="n">is_structure</span> <span class="ow">or</span> <span class="n">layout</span><span class="o">.</span><span class="n">is_array</span><span class="p">:</span>
                <span class="n">v</span><span class="p">:</span> <span class="n">ObjectBufferAccessor</span>
                <span class="n">v</span><span class="o">.</span><span class="n">_collect_references</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

<div class="viewcode-block" id="ObjectBufferAccessor.references">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.ObjectBufferAccessor.references">[docs]</a>
    <span class="k">def</span> <span class="nf">references</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_collect_references</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">s</span></div>


    <span class="k">def</span> <span class="nf">_build</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rdv_layout</span><span class="o">.</span><span class="n">is_structure</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">item</span><span class="p">,</span> <span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">layout</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rdv_layout</span><span class="o">.</span><span class="n">fields_layout</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_build_element</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">layout</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1">#array</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rdv_layout</span><span class="o">.</span><span class="n">declaration</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">field_layout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rdv_layout</span><span class="o">.</span><span class="n">element_layout</span>
                <span class="n">offset</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">field_layout</span><span class="o">.</span><span class="n">aligned_size</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_build_element</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">field_layout</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_build_element</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">field_layout</span><span class="p">):</span>
        <span class="n">field_memory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rdv_memory</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">field_layout</span><span class="o">.</span><span class="n">aligned_size</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">field_layout</span><span class="o">.</span><span class="n">is_structure</span> <span class="ow">or</span> <span class="n">field_layout</span><span class="o">.</span><span class="n">is_array</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">ObjectBufferAccessor</span><span class="p">(</span><span class="n">field_memory</span><span class="p">,</span> <span class="n">field_layout</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rdv_fields</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span>
            <span class="k">return</span> <span class="n">s</span>
        <span class="k">if</span> <span class="n">field_layout</span><span class="o">.</span><span class="n">is_scalar</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">field_memory</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">field_layout</span><span class="o">.</span><span class="n">scalar_format</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">field_layout</span><span class="o">.</span><span class="n">scalar_format</span> <span class="o">==</span> <span class="s1">&#39;Q&#39;</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;Can not build a reference from non-null memory info&#39;</span>
                <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Special None case for reference types</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rdv_fields</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">_torch</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">field_memory</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">field_layout</span><span class="o">.</span><span class="n">element_layout</span><span class="o">.</span><span class="n">declaration</span><span class="p">)</span>
        <span class="n">tensor_type</span> <span class="o">=</span> <span class="n">field_layout</span><span class="o">.</span><span class="n">declaration</span>
        <span class="k">if</span> <span class="n">field_layout</span><span class="o">.</span><span class="n">is_vector</span><span class="p">:</span>  <span class="c1"># possible vec4 to vec3</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">tensor_type</span><span class="o">.</span><span class="n">tensor_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">field_layout</span><span class="o">.</span><span class="n">is_vector</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">tensor_type</span><span class="o">.</span><span class="n">tensor_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">:</span><span class="n">tensor_type</span><span class="o">.</span><span class="n">tensor_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">tensor_type</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rdv_fields</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_equal_values</span><span class="p">(</span><span class="n">field_layout</span><span class="p">:</span> <span class="n">Layout</span><span class="p">,</span> <span class="n">v1</span><span class="p">:</span> <span class="n">_typing</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span> <span class="n">v2</span><span class="p">:</span> <span class="n">_typing</span><span class="o">.</span><span class="n">Any</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">field_layout</span><span class="o">.</span><span class="n">is_scalar</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">field_layout</span><span class="o">.</span><span class="n">scalar_format</span> <span class="o">==</span> <span class="s1">&#39;Q&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">v1</span> <span class="ow">is</span> <span class="n">v2</span>
            <span class="k">return</span> <span class="n">v1</span> <span class="o">==</span> <span class="n">v2</span>
        <span class="k">return</span> <span class="n">v1</span> <span class="ow">is</span> <span class="n">v2</span> <span class="c1"># or _torch.all(v1 == v2).item()</span>

    <span class="k">def</span> <span class="nf">_set_element</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">field_layout</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">field_layout</span><span class="o">.</span><span class="n">is_structure</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">field_layout</span><span class="o">.</span><span class="n">is_array</span>
        <span class="n">current_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rdv_fields</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">ObjectBufferAccessor</span><span class="o">.</span><span class="n">_equal_values</span><span class="p">(</span><span class="n">field_layout</span><span class="p">,</span> <span class="n">current_value</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">field_layout</span><span class="o">.</span><span class="n">is_scalar</span><span class="p">:</span>
            <span class="n">field_memory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rdv_memory</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">field_layout</span><span class="o">.</span><span class="n">aligned_size</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">field_layout</span><span class="o">.</span><span class="n">scalar_format</span> <span class="o">==</span> <span class="s1">&#39;Q&#39;</span><span class="p">:</span>  <span class="c1">#reference type</span>
                <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">field_memory</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s1">&#39;Q&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_rdv_fields</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># save reference as a cached value</span>
                    <span class="k">return</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                    <span class="n">field_memory</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s1">&#39;Q&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_rdv_fields</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>  <span class="c1"># save reference as a cached value</span>
                    <span class="k">return</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">GPUPtr</span><span class="p">),</span> <span class="s1">&#39;Invalid type, bind a GPUPtr object&#39;</span>
                <span class="n">field_memory</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s1">&#39;Q&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">device_ptr</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_rdv_fields</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">return</span>
            <span class="n">field_memory</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">field_layout</span><span class="o">.</span><span class="n">scalar_format</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rdv_fields</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>  <span class="c1"># update cached value</span>
            <span class="k">return</span>
        <span class="c1"># else update tensor value</span>
        <span class="n">current_value</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rdv_layout</span><span class="o">.</span><span class="n">is_structure</span>
        <span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rdv_fields</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rdv_fields</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rdv_layout</span><span class="o">.</span><span class="n">is_structure</span>
        <span class="n">offset</span><span class="p">,</span> <span class="n">field_layout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rdv_layout</span><span class="o">.</span><span class="n">fields_layout</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_element</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">field_layout</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rdv_layout</span><span class="o">.</span><span class="n">is_array</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rdv_fields</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rdv_layout</span><span class="o">.</span><span class="n">is_array</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rdv_layout</span><span class="o">.</span><span class="n">aligned_size</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rdv_layout</span><span class="o">.</span><span class="n">array_stride</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rdv_layout</span><span class="o">.</span><span class="n">is_array</span>
        <span class="n">field_layout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rdv_layout</span><span class="o">.</span><span class="n">element_layout</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">key</span> <span class="o">*</span> <span class="n">field_layout</span><span class="o">.</span><span class="n">aligned_size</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_element</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">field_layout</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>



<div class="viewcode-block" id="Buffer">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.Buffer">[docs]</a>
<span class="k">class</span> <span class="nc">Buffer</span><span class="p">(</span><span class="n">Resource</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents a continuous memory on the device.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="Buffer.__init__">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.Buffer.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="p">:</span> <span class="s1">&#39;DeviceManager&#39;</span><span class="p">,</span> <span class="n">w_buffer</span><span class="p">:</span> <span class="n">_internal</span><span class="o">.</span><span class="n">ResourceWrapper</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">w_buffer</span><span class="p">)</span></div>


    <span class="c1"># def tensor(self, *shape: int, dtype: _torch.dtype = _torch.uint8, offset: int = 0):</span>
    <span class="c1">#     if len(shape) == 0:</span>
    <span class="c1">#         size = self.size() - offset</span>
    <span class="c1">#     else:</span>
    <span class="c1">#         type_size = Layout.scalar_size(dtype)</span>
    <span class="c1">#         size = math.prod(shape) * type_size</span>
    <span class="c1">#     return self.w_resource.slice_buffer(offset, size).as_tensor(dtype)</span>

<div class="viewcode-block" id="Buffer.slice">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.Buffer.slice">[docs]</a>
    <span class="k">def</span> <span class="nf">slice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets a new buffer referring to the region from `offset`, taking `size` bytes.</span>

<span class="sd">        Example</span>
<span class="sd">        -------</span>
<span class="sd">        &gt;&gt;&gt; import vulky as vk</span>
<span class="sd">        &gt;&gt;&gt; b = vk.buffer(4000, vk.BufferUsage.STORAGE, vk.MemoryLocation.GPU)</span>
<span class="sd">        &gt;&gt;&gt; b.slice(0, 500*4).load([0.1]*500)</span>
<span class="sd">        &gt;&gt;&gt; b.slice(500*4, 500*4).load([0.2]*500)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Buffer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_resource</span><span class="o">.</span><span class="n">slice_buffer</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span></div>


    <span class="nd">@lazy_constant</span>
    <span class="k">def</span> <span class="nf">size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_resource</span><span class="o">.</span><span class="n">size</span>

    <span class="nd">@lazy_constant</span>
    <span class="k">def</span> <span class="nf">memory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_resource</span><span class="o">.</span><span class="n">resource_data</span><span class="o">.</span><span class="n">is_cpu</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_resource</span><span class="o">.</span><span class="n">bytes</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_resource</span><span class="o">.</span><span class="n">resource_data</span><span class="o">.</span><span class="n">support_direct_tensor_map</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w_resource</span><span class="o">.</span><span class="n">as_tensor</span><span class="p">(</span><span class="n">_torch</span><span class="o">.</span><span class="n">uint8</span><span class="p">))</span>
        <span class="n">stag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">create_buffer</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="mi">32</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">BufferUsage</span><span class="o">.</span><span class="n">STAGING</span><span class="p">,</span> <span class="n">MemoryLocation</span><span class="o">.</span><span class="n">CPU</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">stag</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">stag</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">stag</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s1">&#39;f&#39;</span><span class="p">)))</span></div>



<div class="viewcode-block" id="ObjectBuffer">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.ObjectBuffer">[docs]</a>
<span class="k">class</span> <span class="nc">ObjectBuffer</span><span class="p">(</span><span class="n">Buffer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Buffer used to represent single objects.</span>
<span class="sd">    The buffer is automatically mapped if is on CPU.</span>
<span class="sd">    If the buffer is on GPU the memory must be updated via `update_gpu`.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    &gt;&gt;&gt; import vulky as vk</span>
<span class="sd">    &gt;&gt;&gt; b = vk.object_buffer(vk.Layout.from_structure(P=vk.vec3, L=float), memory=vk.MemoryLocation.GPU)</span>
<span class="sd">    &gt;&gt;&gt; with b as map:</span>
<span class="sd">    &gt;&gt;&gt;     map.P = vk.vec3(0.0, 1.0, 0.0)</span>
<span class="sd">    &gt;&gt;&gt;     map.L = 0.5</span>
<span class="sd">    &gt;&gt;&gt; b.update_gpu()</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="ObjectBuffer.__init__">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.ObjectBuffer.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="p">:</span> <span class="s1">&#39;DeviceManager&#39;</span><span class="p">,</span> <span class="n">w_buffer</span><span class="p">:</span> <span class="n">_internal</span><span class="o">.</span><span class="n">ResourceWrapper</span><span class="p">,</span> <span class="n">layout</span><span class="p">:</span> <span class="n">Layout</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ObjectBuffer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">w_buffer</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">layout</span><span class="o">.</span><span class="n">aligned_size</span> <span class="o">==</span> <span class="n">w_buffer</span><span class="o">.</span><span class="n">size</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">w_buffer</span><span class="o">.</span><span class="n">resource_data</span><span class="o">.</span><span class="n">is_cpu</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_staging</span> <span class="o">=</span> <span class="n">device</span><span class="o">.</span><span class="n">create_buffer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">BufferUsage</span><span class="o">.</span><span class="n">STAGING</span><span class="p">,</span> <span class="n">MemoryLocation</span><span class="o">.</span><span class="n">CPU</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_staging</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_staging</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">accessor</span> <span class="o">=</span> <span class="n">ObjectBufferAccessor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_staging</span><span class="o">.</span><span class="n">memory</span><span class="p">,</span> <span class="n">layout</span><span class="p">)</span></div>


<div class="viewcode-block" id="ObjectBuffer.update_gpu">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.ObjectBuffer.update_gpu">[docs]</a>
    <span class="k">def</span> <span class="nf">update_gpu</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_staging</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">accessor</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_staging</span><span class="p">)</span></div>



<div class="viewcode-block" id="StructuredBufferAccess">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.StructuredBufferAccess">[docs]</a>
<span class="k">class</span> <span class="nc">StructuredBufferAccess</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Auxiliary class to access structured buffers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="StructuredBufferAccess.__init__">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.StructuredBufferAccess.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">memory</span><span class="p">:</span> <span class="nb">memoryview</span><span class="p">,</span> <span class="n">structure_stride</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">structure_layout</span><span class="p">:</span> <span class="n">Layout</span><span class="p">):</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_rdv_memory&#39;</span><span class="p">,</span> <span class="n">memory</span><span class="p">)</span>  <span class="c1"># All buffer memory</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_rdv_layout&#39;</span><span class="p">,</span> <span class="n">structure_layout</span><span class="p">)</span>  <span class="c1"># the layout of a single element structure</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_rdv_structure_stride&#39;</span><span class="p">,</span> <span class="n">structure_stride</span><span class="p">)</span>  <span class="c1"># the structure stride</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_rdv_offset&#39;</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>  <span class="c1"># the offset for a specific element in the whole struct</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_rdv_fields&#39;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">())</span>  <span class="c1">#cached fields converted into tensors</span></div>


<div class="viewcode-block" id="StructuredBufferAccess.build_accessor">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.StructuredBufferAccess.build_accessor">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">build_accessor</span><span class="p">(</span><span class="n">memory</span><span class="p">:</span> <span class="nb">memoryview</span><span class="p">,</span> <span class="n">stride</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">layout</span><span class="p">:</span> <span class="n">Layout</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">layout</span><span class="o">.</span><span class="n">is_structure</span> <span class="ow">or</span> <span class="n">layout</span><span class="o">.</span><span class="n">is_array</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">StructuredBufferAccess</span><span class="p">(</span><span class="n">memory</span><span class="p">,</span> <span class="n">stride</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">layout</span><span class="p">)</span>
        <span class="n">scalar_format</span> <span class="o">=</span> <span class="n">layout</span><span class="o">.</span><span class="n">scalar_format</span> <span class="k">if</span> <span class="n">layout</span><span class="o">.</span><span class="n">is_scalar</span> <span class="k">else</span> <span class="n">layout</span><span class="o">.</span><span class="n">element_layout</span><span class="o">.</span><span class="n">scalar_format</span>
        <span class="n">torch_dtype</span> <span class="o">=</span> <span class="n">layout</span><span class="o">.</span><span class="n">declaration</span> <span class="k">if</span> <span class="n">layout</span><span class="o">.</span><span class="n">is_scalar</span> <span class="k">else</span> <span class="n">layout</span><span class="o">.</span><span class="n">element_layout</span><span class="o">.</span><span class="n">declaration</span>
        <span class="n">scalar_size</span> <span class="o">=</span> <span class="n">Layout</span><span class="o">.</span><span class="n">scalar_size</span><span class="p">(</span><span class="n">torch_dtype</span><span class="p">)</span>
        <span class="n">element_offset</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">//</span> <span class="n">scalar_size</span>
        <span class="n">element_count</span> <span class="o">=</span> <span class="n">layout</span><span class="o">.</span><span class="n">aligned_size</span> <span class="o">//</span> <span class="n">scalar_size</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">_torch</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">memory</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch_dtype</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">stride</span> <span class="o">//</span> <span class="n">scalar_size</span><span class="p">)[:,</span> <span class="n">element_offset</span><span class="p">:</span><span class="n">element_offset</span> <span class="o">+</span> <span class="n">element_count</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">layout</span><span class="o">.</span><span class="n">is_scalar</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">t</span>
        <span class="n">tensor_type</span> <span class="o">=</span> <span class="n">layout</span><span class="o">.</span><span class="n">declaration</span>
        <span class="k">if</span> <span class="n">layout</span><span class="o">.</span><span class="n">is_vector</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">tensor_type</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="n">tensor_type</span><span class="o">.</span><span class="n">tensor_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">:</span><span class="n">tensor_type</span><span class="o">.</span><span class="n">tensor_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="k">return</span> <span class="n">tensor_type</span><span class="p">(</span><span class="n">t</span><span class="p">)</span></div>

        <span class="c1"># dtype = layout.get_type() if layout.is_scalar else layout.element_layout.get_type()</span>
        <span class="c1"># t = w_buffer.as_tensor(dtype)</span>
        <span class="c1"># element_size = t.element_size()</span>
        <span class="c1"># start_element = offset // element_size</span>
        <span class="c1"># stride_element = stride // element_size</span>
        <span class="c1"># count_element = layout.aligned_size // element_size</span>
        <span class="c1"># t = t.view(-1, stride_element)[:, start_element:start_element + count_element]</span>
        <span class="c1"># if layout.is_scalar:</span>
        <span class="c1">#     return t</span>
        <span class="c1"># tensor_type = layout.get_type()</span>
        <span class="c1"># if layout.is_matrix:</span>
        <span class="c1">#     t = t.view(t.shape[0], tensor_type.tensor_shape[0], -1)[...,0:tensor_type.tensor_shape[1]]</span>
        <span class="c1"># return tensor_type(t)</span>

    <span class="k">def</span> <span class="nf">_get_subelement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">layout</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">offset</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rdv_fields</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rdv_fields</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span> <span class="o">=</span> <span class="n">StructuredBufferAccess</span><span class="o">.</span><span class="n">build_accessor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rdv_memory</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rdv_structure_stride</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rdv_offset</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">layout</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rdv_fields</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_set_subelement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">layout</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">layout</span><span class="o">.</span><span class="n">is_array</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">layout</span><span class="o">.</span><span class="n">is_structure</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_subelement</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">layout</span><span class="p">)</span>
        <span class="c1"># if isinstance(value, _torch.Tensor):  # and value.shape == t.shape:</span>
        <span class="c1">#    assert value.device.type == &#39;cpu&#39;</span>
        <span class="k">if</span> <span class="n">_np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="n">t</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">t</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="c1"># else:</span>
        <span class="c1">#     t[:] = value</span>
        <span class="c1">#     # _torch.fill_(t, value)</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rdv_layout</span><span class="o">.</span><span class="n">is_structure</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Trying to get </span><span class="si">{</span><span class="n">item</span><span class="si">}</span><span class="s1"> to a non-structured layout&#39;</span>
        <span class="n">offset</span><span class="p">,</span> <span class="n">layout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rdv_layout</span><span class="o">.</span><span class="n">fields_layout</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_subelement</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">layout</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rdv_layout</span><span class="o">.</span><span class="n">is_structure</span>
        <span class="n">offset</span><span class="p">,</span> <span class="n">layout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rdv_layout</span><span class="o">.</span><span class="n">fields_layout</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_subelement</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">layout</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rdv_layout</span><span class="o">.</span><span class="n">is_array</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span> <span class="s1">&#39;Can not index with slice or anything else.&#39;</span>
        <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rdv_layout</span><span class="o">.</span><span class="n">element_layout</span><span class="o">.</span><span class="n">aligned_size</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">size</span> <span class="o">*</span> <span class="n">item</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_subelement</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rdv_layout</span><span class="o">.</span><span class="n">element_layout</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span> <span class="s1">&#39;Can not index with slice or anything else&#39;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rdv_layout</span><span class="o">.</span><span class="n">is_array</span>
        <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rdv_layout</span><span class="o">.</span><span class="n">element_layout</span><span class="o">.</span><span class="n">aligned_size</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">size</span> <span class="o">*</span> <span class="n">key</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_subelement</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rdv_layout</span><span class="o">.</span><span class="n">element_layout</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>



<div class="viewcode-block" id="StructuredBuffer">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.StructuredBuffer">[docs]</a>
<span class="k">class</span> <span class="nc">StructuredBuffer</span><span class="p">(</span><span class="n">Buffer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Buffer used to represent structured arrays.</span>
<span class="sd">    Buffer can be mapped in mode `in`, `out` or `inout`.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    &gt;&gt;&gt; import vulky as vk</span>
<span class="sd">    &gt;&gt;&gt; b = vk.structured_buffer(5, dict(P=vk.vec3, L=float), memory=vk.MemoryLocation.GPU)</span>
<span class="sd">    &gt;&gt;&gt; with b.map(&#39;in&#39;) as map:</span>
<span class="sd">    &gt;&gt;&gt;     map.P = vk.vec3(0.0, 1.0, 0.0)</span>
<span class="sd">    &gt;&gt;&gt;     map.L = 0.5</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="StructuredBuffer.__init__">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.StructuredBuffer.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="p">:</span> <span class="s1">&#39;DeviceManager&#39;</span><span class="p">,</span> <span class="n">w_buffer</span><span class="p">:</span> <span class="n">_internal</span><span class="o">.</span><span class="n">ResourceWrapper</span><span class="p">,</span> <span class="n">layout</span><span class="p">:</span> <span class="n">Layout</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">w_buffer</span><span class="o">.</span><span class="n">size</span> <span class="o">%</span> <span class="n">layout</span><span class="o">.</span><span class="n">aligned_size</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">StructuredBuffer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">w_buffer</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layout</span> <span class="o">=</span> <span class="n">layout</span></div>


<div class="viewcode-block" id="StructuredBuffer.map">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.StructuredBuffer.map">[docs]</a>
    <span class="k">def</span> <span class="nf">map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="n">_typing</span><span class="o">.</span><span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="s1">&#39;out&#39;</span><span class="p">,</span> <span class="s1">&#39;inout&#39;</span><span class="p">],</span> <span class="n">clear</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a context to map the buffer in a specific mode.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mode: str</span>
<span class="sd">            If &#39;in&#39; the buffer is updated on the gpu after exit the context.</span>
<span class="sd">            If &#39;out&#39; the buffer is updated on the cpu before entering the context.</span>
<span class="sd">            If &#39;inout&#39; the buffer is updated on the cpu before entering the context and then back to the gpu.</span>
<span class="sd">        clear: bool</span>
<span class="sd">            Only applies if mode is &#39;in&#39;. Clears all the buffer before entering the context.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">clear</span> <span class="ow">or</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="s1">&#39;Can only clear when map in&#39;</span>
        <span class="n">_self</span><span class="p">:</span> <span class="n">StructuredBuffer</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_resource</span><span class="o">.</span><span class="n">resource_data</span><span class="o">.</span><span class="n">is_gpu</span><span class="p">:</span>
            <span class="n">staging</span> <span class="o">=</span> <span class="n">buffer_like</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">MemoryLocation</span><span class="o">.</span><span class="n">CPU</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">staging</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="n">clear</span><span class="p">:</span>
            <span class="n">staging</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">class</span> <span class="nc">Context</span><span class="p">:</span>
            <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;out&#39;</span> <span class="ow">or</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;inout&#39;</span><span class="p">:</span>
                    <span class="n">_self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">staging</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">StructuredBufferAccess</span><span class="p">(</span><span class="n">staging</span><span class="o">.</span><span class="n">memory</span><span class="p">,</span> <span class="n">_self</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">aligned_size</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">_self</span><span class="o">.</span><span class="n">layout</span><span class="p">)</span>
            <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;in&#39;</span> <span class="ow">or</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;inout&#39;</span><span class="p">:</span>
                    <span class="n">_self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">staging</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Context</span><span class="p">()</span></div>
</div>



<span class="c1"># class ResourceAccess:</span>
<span class="c1">#     def __init__(self, w_buffer: ResourceWrapper, offset: int, stride: int, layout: Layout, is_structured_buffer: bool = False):</span>
<span class="c1">#         assert w_buffer.support_direct_tensor_map()</span>
<span class="c1">#         object.__setattr__(self, &#39;w_buffer&#39;, w_buffer)</span>
<span class="c1">#         object.__setattr__(self, &#39;layout&#39;, layout)</span>
<span class="c1">#         object.__setattr__(self, &#39;offset&#39;, offset)</span>
<span class="c1">#         object.__setattr__(self, &#39;stride&#39;, stride)</span>
<span class="c1">#         object.__setattr__(self, &#39;is_structured_buffer&#39;, is_structured_buffer)</span>
<span class="c1">#         object.__setattr__(self, &#39;_cached&#39;, dict())</span>
<span class="c1">#</span>
<span class="c1">#     @staticmethod</span>
<span class="c1">#     def build_accessor(w_buffer: ResourceWrapper, offset: int, stride: int, layout: Layout, is_structured_buffer: bool = False):</span>
<span class="c1">#         if layout.is_structure or layout.is_array:</span>
<span class="c1">#             return ResourceAccess(w_buffer, offset, stride, layout, is_structured_buffer)</span>
<span class="c1">#         return w_buffer.as_bytes()[offset: offset + layout.aligned_size]</span>
<span class="c1">#         # dtype = layout.get_type() if layout.is_scalar else layout.element_layout.get_type()</span>
<span class="c1">#         # t = w_buffer.as_tensor(dtype)</span>
<span class="c1">#         # element_size = t.element_size()</span>
<span class="c1">#         # start_element = offset // element_size</span>
<span class="c1">#         # stride_element = stride // element_size</span>
<span class="c1">#         # count_element = layout.aligned_size // element_size</span>
<span class="c1">#         # t = t.view(-1, stride_element)[:, start_element:start_element + count_element]</span>
<span class="c1">#         # if layout.is_scalar:</span>
<span class="c1">#         #     return t</span>
<span class="c1">#         # tensor_type = layout.get_type()</span>
<span class="c1">#         # if layout.is_matrix:</span>
<span class="c1">#         #     t = t.view(t.shape[0], tensor_type.tensor_shape[0], -1)[...,0:tensor_type.tensor_shape[1]]</span>
<span class="c1">#         # return tensor_type(t)</span>
<span class="c1">#</span>
<span class="c1">#     def _get_subelement(self, offset, layout):</span>
<span class="c1">#         if offset not in self._cached:</span>
<span class="c1">#             self._cached[offset] = ResourceAccess.build_accessor(self.w_buffer, self.offset + offset, self.stride, layout)</span>
<span class="c1">#         return self._cached[offset]</span>
<span class="c1">#</span>
<span class="c1">#     def _set_subelement(self, offset, layout, value):</span>
<span class="c1">#         assert not layout.is_array and not layout.is_structure</span>
<span class="c1">#         t = self._get_subelement(offset, layout)</span>
<span class="c1">#         # if isinstance(value, _torch.Tensor):  # and value.shape == t.shape:</span>
<span class="c1">#         #    assert value.device.type == &#39;cpu&#39;</span>
<span class="c1">#         if _np.isscalar(value):</span>
<span class="c1">#             t[:] = struct.pack(layout.scalar_format, value)</span>
<span class="c1">#         else:</span>
<span class="c1">#             t[:] = memoryview(_np.asarray(value)).cast(&#39;B&#39;)</span>
<span class="c1">#         # else:</span>
<span class="c1">#         #     t[:] = value</span>
<span class="c1">#         #     # _torch.fill_(t, value)</span>
<span class="c1">#</span>
<span class="c1">#     def __getattr__(self, item):</span>
<span class="c1">#         assert self.layout.is_structure</span>
<span class="c1">#         offset, layout = self.layout.fields_layout(item)</span>
<span class="c1">#         return self._get_subelement(offset, layout)</span>
<span class="c1">#</span>
<span class="c1">#     def __setattr__(self, key, value):</span>
<span class="c1">#         assert self.layout.is_structure</span>
<span class="c1">#         offset, layout = self.layout.fields_layout(key)</span>
<span class="c1">#         self._set_subelement(offset, layout, value)</span>
<span class="c1">#</span>
<span class="c1">#     def __getitem__(self, item):</span>
<span class="c1">#         assert isinstance(item, int), &#39;Can not index with slice or anything else.&#39;</span>
<span class="c1">#         if self.is_structured_buffer:</span>
<span class="c1">#             return ResourceAccess(self.w_buffer.buffer_slice(item*self.stride, (item+1)*self.stride), 0, self.stride, self.layout)</span>
<span class="c1">#         size = self.layout.element_layout.aligned_size</span>
<span class="c1">#         offset = size * item</span>
<span class="c1">#         return self._get_subelement(offset, self.layout.element_layout)</span>
<span class="c1">#</span>
<span class="c1">#     def __setitem__(self, key, value):</span>
<span class="c1">#         assert isinstance(key, int), &#39;Can not index with slice or anything else&#39;</span>
<span class="c1">#         assert not self.is_structured_buffer</span>
<span class="c1">#         assert not self.layout.is_structure</span>
<span class="c1">#         size = self.layout.element_layout.aligned_size</span>
<span class="c1">#         offset = size * key</span>
<span class="c1">#         return self._set_subelement(offset, self.layout.element_layout, value)</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># class _LayoutBufferBase(Buffer):</span>
<span class="c1">#</span>
<span class="c1">#     def __init__(self, device: &#39;DeviceManager&#39;, w_buffer: ResourceWrapper, layout: Layout, is_structured_buffer: bool):</span>
<span class="c1">#         super(_LayoutBufferBase, self).__init__(device, w_buffer)</span>
<span class="c1">#         self.layout = layout</span>
<span class="c1">#         self.is_structured_buffer = is_structured_buffer</span>
<span class="c1">#         self.__map_staging = None</span>
<span class="c1">#         self.__cache_accessor = None</span>
<span class="c1">#         self.__maps = 0</span>
<span class="c1">#         self.__is_dynamic = True</span>
<span class="c1">#</span>
<span class="c1">#     def make_dynamic(self, value=True):</span>
<span class="c1">#         self.__is_dynamic = value</span>
<span class="c1">#         return self</span>
<span class="c1">#</span>
<span class="c1">#     def __enter__(self):</span>
<span class="c1">#         self.__maps += 1</span>
<span class="c1">#         if self.__cache_accessor is None:</span>
<span class="c1">#             if self.w_resource.resource_data.is_cpu_visible: #support_direct_tensor_map():</span>
<span class="c1">#                 self.__map_staging = self.w_resource</span>
<span class="c1">#             else:</span>
<span class="c1">#                 self.__map_staging = self.device.w_device.create_buffer(self.w_resource.get_size(), BufferUsage.STAGING, MemoryLocation.CPU)</span>
<span class="c1">#             self.__cache_accessor = ResourceAccess.build_accessor(self.__map_staging, 0, self.layout.aligned_size, self.layout, self.is_structured_buffer)</span>
<span class="c1">#         if self.__maps == 1:</span>
<span class="c1">#             self.__map_staging.load(self.device.w_device, self.w_resource)</span>
<span class="c1">#         return self.__cache_accessor</span>
<span class="c1">#</span>
<span class="c1">#     def __exit__(self, exc_type, exc_val, exc_tb):</span>
<span class="c1">#         self.__maps -= 1</span>
<span class="c1">#         if not self.w_resource.resource_data.is_cpu_visible: #support_direct_tensor_map():</span>
<span class="c1">#             if self.__maps == 0:</span>
<span class="c1">#                 self.__map_staging.save(self.device.w_device, self.w_resource)</span>
<span class="c1">#         if not self.__is_dynamic:</span>
<span class="c1">#             self.__map_staging = None</span>
<span class="c1">#             self.__cache_accessor = None</span>
<span class="c1">#</span>
<span class="c1">#     def get_access(self):</span>
<span class="c1">#         assert self.w_resource.resource_data.is_cpu_visible</span>
<span class="c1">#         if self.__cache_accessor is None:</span>
<span class="c1">#             self.__cache_accessor = ResourceAccess.build_accessor(self.w_resource, 0, self.layout.aligned_size, self.layout, self.is_structured_buffer)</span>
<span class="c1">#         return self.__cache_accessor</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># class UniformBuffer(_LayoutBufferBase):</span>
<span class="c1">#     def __init__(self, device: &#39;DeviceManager&#39;, w_buffer: ResourceWrapper, layout: Layout):</span>
<span class="c1">#         super(UniformBuffer, self).__init__(device, w_buffer, layout, False)</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># class StructuredBuffer(_LayoutBufferBase):</span>
<span class="c1">#     def __init__(self, device: &#39;DeviceManager&#39;, w_buffer: ResourceWrapper, layout: Layout):</span>
<span class="c1">#         super(StructuredBuffer, self).__init__(device, w_buffer, layout, True)</span>


<span class="c1"># class ObjectBuffer(Buffer):</span>
<span class="c1">#     def __init__(self, device: &#39;DeviceManager&#39;, w_buffer: ResourceWrapper, layout: Layout):</span>
<span class="c1">#         super(ObjectBuffer, self).__init__(device, w_buffer)</span>
<span class="c1">#         self.layout = layout</span>
<span class="c1">#         self.__map_staging = None</span>
<span class="c1">#         self.__cache_accessor = None</span>
<span class="c1">#         self.__maps = 0</span>
<span class="c1">#         self.__is_dynamic = True</span>


<div class="viewcode-block" id="Image">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.Image">[docs]</a>
<span class="k">class</span> <span class="nc">Image</span><span class="p">(</span><span class="n">Resource</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    TODO: NOT IDEAL DESIGN</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="Image.compute_dimension">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.Image.compute_dimension">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">compute_dimension</span><span class="p">(</span><span class="n">width</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">height</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">depth</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">mip_level</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">width</span> <span class="o">//</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">mip_level</span><span class="p">)),</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">height</span> <span class="o">//</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">mip_level</span><span class="p">)),</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">depth</span> <span class="o">//</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">mip_level</span><span class="p">))</span></div>


<div class="viewcode-block" id="Image.__init__">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.Image.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">w_image</span><span class="p">:</span> <span class="n">_internal</span><span class="o">.</span><span class="n">ResourceWrapper</span><span class="p">,</span> <span class="n">texel_layout</span><span class="p">:</span> <span class="n">Layout</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">w_image</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">compute_dimension</span><span class="p">(</span>
            <span class="n">w_image</span><span class="o">.</span><span class="n">resource_data</span><span class="o">.</span><span class="n">vk_description</span><span class="o">.</span><span class="n">extent</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
            <span class="n">w_image</span><span class="o">.</span><span class="n">resource_data</span><span class="o">.</span><span class="n">vk_description</span><span class="o">.</span><span class="n">extent</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
            <span class="n">w_image</span><span class="o">.</span><span class="n">resource_data</span><span class="o">.</span><span class="n">vk_description</span><span class="o">.</span><span class="n">extent</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span>
            <span class="n">w_image</span><span class="o">.</span><span class="n">current_slice</span><span class="p">[</span><span class="s2">&quot;mip_start&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layout</span> <span class="o">=</span> <span class="n">texel_layout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache_size</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Image.get_image_dimension">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.Image.get_image_dimension">[docs]</a>
    <span class="k">def</span> <span class="nf">get_image_dimension</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="nb">type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_resource</span><span class="o">.</span><span class="n">resource_data</span><span class="o">.</span><span class="n">vk_description</span><span class="o">.</span><span class="n">imageType</span>
        <span class="k">return</span> <span class="nb">type</span> <span class="o">+</span> <span class="mi">1</span></div>


<div class="viewcode-block" id="Image.get_mip_count">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.Image.get_mip_count">[docs]</a>
    <span class="k">def</span> <span class="nf">get_mip_count</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_resource</span><span class="o">.</span><span class="n">current_slice</span><span class="p">[</span><span class="s2">&quot;mip_count&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="Image.get_array_count">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.Image.get_array_count">[docs]</a>
    <span class="k">def</span> <span class="nf">get_array_count</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_resource</span><span class="o">.</span><span class="n">current_slice</span><span class="p">[</span><span class="s2">&quot;array_count&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="Image.slice_mips">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.Image.slice_mips">[docs]</a>
    <span class="k">def</span> <span class="nf">slice_mips</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mip_start</span><span class="p">,</span> <span class="n">mip_count</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Image</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_resource</span><span class="o">.</span><span class="n">slice_mips</span><span class="p">(</span><span class="n">mip_start</span><span class="p">,</span> <span class="n">mip_count</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">)</span></div>


<div class="viewcode-block" id="Image.slice_array">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.Image.slice_array">[docs]</a>
    <span class="k">def</span> <span class="nf">slice_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array_start</span><span class="p">,</span> <span class="n">array_count</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Image</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_resource</span><span class="o">.</span><span class="n">slice_array</span><span class="p">(</span><span class="n">array_start</span><span class="p">,</span> <span class="n">array_count</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">)</span></div>


<div class="viewcode-block" id="Image.subresource">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.Image.subresource">[docs]</a>
    <span class="k">def</span> <span class="nf">subresource</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mip</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">layer</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Image</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_resource</span><span class="o">.</span><span class="n">subresource</span><span class="p">(</span><span class="n">mip</span><span class="p">,</span> <span class="n">layer</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">)</span></div>


<div class="viewcode-block" id="Image.as_readonly">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.Image.as_readonly">[docs]</a>
    <span class="k">def</span> <span class="nf">as_readonly</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Image</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_resource</span><span class="o">.</span><span class="n">as_readonly</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">)</span></div>


    <span class="nd">@lazy_constant</span>
    <span class="k">def</span> <span class="nf">size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_resource</span><span class="o">.</span><span class="n">size</span>

<div class="viewcode-block" id="Image.element_size">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.Image.element_size">[docs]</a>
    <span class="k">def</span> <span class="nf">element_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">aligned_size</span></div>


<div class="viewcode-block" id="Image.numel">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.Image.numel">[docs]</a>
    <span class="k">def</span> <span class="nf">numel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">()</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">element_size</span><span class="p">()</span></div>


<div class="viewcode-block" id="Image.subresource_footprint">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.Image.subresource_footprint">[docs]</a>
    <span class="k">def</span> <span class="nf">subresource_footprint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mip</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">layer</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_resource</span><span class="o">.</span><span class="n">get_subresource_footprint</span><span class="p">(</span><span class="n">mip</span><span class="p">,</span> <span class="n">layer</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="GeometryCollection">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.GeometryCollection">[docs]</a>
<span class="k">class</span> <span class="nc">GeometryCollection</span><span class="p">:</span>

<div class="viewcode-block" id="GeometryCollection.__init__">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.GeometryCollection.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="p">:</span> <span class="n">_internal</span><span class="o">.</span><span class="n">DeviceWrapper</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_device</span> <span class="o">=</span> <span class="n">device</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">descriptions</span> <span class="o">=</span> <span class="p">[]</span></div>


    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_device</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">descriptions</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="GeometryCollection.get_collection_type">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.GeometryCollection.get_collection_type">[docs]</a>
    <span class="k">def</span> <span class="nf">get_collection_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ADSNodeType</span><span class="p">:</span>
        <span class="k">pass</span></div>
</div>



<div class="viewcode-block" id="TriangleCollection">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.TriangleCollection">[docs]</a>
<span class="k">class</span> <span class="nc">TriangleCollection</span><span class="p">(</span><span class="n">GeometryCollection</span><span class="p">):</span>

<div class="viewcode-block" id="TriangleCollection.__init__">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.TriangleCollection.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="p">:</span> <span class="n">_internal</span><span class="o">.</span><span class="n">DeviceWrapper</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">device</span><span class="p">)</span></div>


<div class="viewcode-block" id="TriangleCollection.append">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.TriangleCollection.append">[docs]</a>
    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vertices</span><span class="p">:</span> <span class="n">Buffer</span><span class="p">,</span>
               <span class="n">indices</span><span class="p">:</span> <span class="n">Buffer</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
               <span class="n">transform</span><span class="p">:</span> <span class="n">Buffer</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">descriptions</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">vertices</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">transform</span><span class="p">))</span></div>


<div class="viewcode-block" id="TriangleCollection.get_collection_type">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.TriangleCollection.get_collection_type">[docs]</a>
    <span class="k">def</span> <span class="nf">get_collection_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ADSNodeType</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ADSNodeType</span><span class="o">.</span><span class="n">TRIANGLES</span>  <span class="c1"># Triangles</span></div>
</div>



<div class="viewcode-block" id="AABBCollection">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.AABBCollection">[docs]</a>
<span class="k">class</span> <span class="nc">AABBCollection</span><span class="p">(</span><span class="n">GeometryCollection</span><span class="p">):</span>
<div class="viewcode-block" id="AABBCollection.__init__">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.AABBCollection.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="p">:</span> <span class="n">_internal</span><span class="o">.</span><span class="n">DeviceWrapper</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">device</span><span class="p">)</span></div>


<div class="viewcode-block" id="AABBCollection.append">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.AABBCollection.append">[docs]</a>
    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aabb</span><span class="p">:</span> <span class="n">Buffer</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">descriptions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aabb</span><span class="p">)</span></div>


<div class="viewcode-block" id="AABBCollection.get_collection_type">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.AABBCollection.get_collection_type">[docs]</a>
    <span class="k">def</span> <span class="nf">get_collection_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ADSNodeType</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ADSNodeType</span><span class="o">.</span><span class="n">AABB</span>  <span class="c1"># AABB</span></div>
</div>



<div class="viewcode-block" id="ADS">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.ADS">[docs]</a>
<span class="k">class</span> <span class="nc">ADS</span><span class="p">(</span><span class="n">Resource</span><span class="p">):</span>
<div class="viewcode-block" id="ADS.__init__">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.ADS.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">w_resource</span><span class="p">:</span> <span class="n">_internal</span><span class="o">.</span><span class="n">ResourceWrapper</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span> <span class="n">scratch_size</span><span class="p">,</span>
                 <span class="n">info</span><span class="p">:</span> <span class="n">_typing</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span> <span class="n">ranges</span><span class="p">,</span> <span class="n">instance_buffer</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">w_resource</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ads</span> <span class="o">=</span> <span class="n">w_resource</span><span class="o">.</span><span class="n">resource_data</span><span class="o">.</span><span class="n">ads</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ads_info</span> <span class="o">=</span> <span class="n">info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handle</span> <span class="o">=</span> <span class="n">handle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scratch_size</span> <span class="o">=</span> <span class="n">scratch_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ranges</span> <span class="o">=</span> <span class="n">ranges</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instance_buffer</span> <span class="o">=</span> <span class="n">instance_buffer</span></div>
</div>



<div class="viewcode-block" id="RTProgram">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.RTProgram">[docs]</a>
<span class="k">class</span> <span class="nc">RTProgram</span><span class="p">:</span>

<div class="viewcode-block" id="RTProgram.__init__">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.RTProgram.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline</span><span class="p">:</span> <span class="s1">&#39;Pipeline&#39;</span><span class="p">,</span>
                 <span class="n">w_shader_table</span><span class="p">:</span> <span class="n">_internal</span><span class="o">.</span><span class="n">ResourceWrapper</span><span class="p">,</span>
                 <span class="n">miss_offset</span><span class="p">,</span>
                 <span class="n">hit_offset</span><span class="p">,</span>
                 <span class="n">callable_offset</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span> <span class="o">=</span> <span class="n">pipeline</span>
        <span class="n">prop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">w_pipeline</span><span class="o">.</span><span class="n">w_device</span><span class="o">.</span><span class="n">raytracing_properties</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shader_handle_stride</span> <span class="o">=</span> <span class="n">prop</span><span class="o">.</span><span class="n">shaderGroupHandleSize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_table</span> <span class="o">=</span> <span class="n">w_shader_table</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__map_w_table</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__map_w_table_tensor</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># self.raygen_slice = w_shader_table.slice_buffer(0, self.shader_handle_stride)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">miss_slice</span> <span class="o">=</span> <span class="n">w_shader_table</span><span class="o">.</span><span class="n">slice_buffer</span><span class="p">(</span><span class="n">miss_offset</span><span class="p">,</span> <span class="n">hit_offset</span> <span class="o">-</span> <span class="n">miss_offset</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hitgroup_slice</span> <span class="o">=</span> <span class="n">w_shader_table</span><span class="o">.</span><span class="n">slice_buffer</span><span class="p">(</span><span class="n">hit_offset</span><span class="p">,</span> <span class="n">callable_offset</span> <span class="o">-</span> <span class="n">hit_offset</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callable_slice</span> <span class="o">=</span> <span class="n">w_shader_table</span><span class="o">.</span><span class="n">slice_buffer</span><span class="p">(</span><span class="n">callable_offset</span><span class="p">,</span> <span class="n">w_shader_table</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="n">callable_offset</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">miss_offset</span> <span class="o">=</span> <span class="n">miss_offset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hit_offset</span> <span class="o">=</span> <span class="n">hit_offset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callable_offset</span> <span class="o">=</span> <span class="n">callable_offset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_program</span> <span class="o">=</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="RTProgram.select_generation">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.RTProgram.select_generation">[docs]</a>
    <span class="k">def</span> <span class="nf">select_generation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">main_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_program</span> <span class="o">=</span> <span class="n">main_index</span></div>


<div class="viewcode-block" id="RTProgram.active_raygen_slice">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.RTProgram.active_raygen_slice">[docs]</a>
    <span class="k">def</span> <span class="nf">active_raygen_slice</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_program</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">shader_handle_stride</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_table</span><span class="o">.</span><span class="n">slice_buffer</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shader_handle_stride</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_table</span><span class="o">.</span><span class="n">support_direct_tensor_map</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__map_w_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_table</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__map_w_table_tensor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__map_w_table</span><span class="o">.</span><span class="n">as_tensor</span><span class="p">(</span><span class="n">_torch</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__map_w_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">w_pipeline</span><span class="o">.</span><span class="n">w_device</span><span class="o">.</span><span class="n">create_buffer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w_table</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">BufferUsage</span><span class="o">.</span><span class="n">STAGING</span><span class="p">,</span> <span class="n">MemoryLocation</span><span class="o">.</span><span class="n">CPU</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__map_w_table</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">w_pipeline</span><span class="o">.</span><span class="n">w_device</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_table</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__map_w_table_tensor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__map_w_table</span><span class="o">.</span><span class="n">as_tensor</span><span class="p">(</span><span class="n">_torch</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_table</span><span class="o">.</span><span class="n">support_direct_tensor_map</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__map_w_table</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">w_pipeline</span><span class="o">.</span><span class="n">w_device</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_table</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__map_w_table</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__map_w_table_tensor</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_table</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raygen_slice</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">miss_slice</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hitgroup_slice</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callable_slice</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="RTProgram.set_generation">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.RTProgram.set_generation">[docs]</a>
    <span class="k">def</span> <span class="nf">set_generation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gen_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">shader_group</span><span class="p">:</span> <span class="n">ShaderHandler</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">__map_w_table</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Program need to updated inside a context, use with program...&#39;</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">gen_index</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">shader_handle_stride</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__map_w_table_tensor</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">shader_handle_stride</span><span class="p">]</span> <span class="o">=</span> <span class="n">_torch</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">shader_group</span><span class="o">.</span><span class="n">handle</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">_torch</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span></div>


<div class="viewcode-block" id="RTProgram.set_miss">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.RTProgram.set_miss">[docs]</a>
    <span class="k">def</span> <span class="nf">set_miss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">miss_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">shader_group</span><span class="p">:</span> <span class="n">ShaderHandler</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">__map_w_table</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Program need to updated inside a context, use with program...&#39;</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">miss_offset</span> <span class="o">+</span> <span class="n">miss_index</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">shader_handle_stride</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__map_w_table_tensor</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">shader_handle_stride</span><span class="p">]</span> <span class="o">=</span> <span class="n">_torch</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">shader_group</span><span class="o">.</span><span class="n">handle</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">_torch</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span></div>


<div class="viewcode-block" id="RTProgram.set_hit_group">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.RTProgram.set_hit_group">[docs]</a>
    <span class="k">def</span> <span class="nf">set_hit_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hit_group_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">shader_group</span><span class="p">:</span> <span class="n">ShaderHandler</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">__map_w_table</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Program need to updated inside a context, use with program...&#39;</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hit_offset</span> <span class="o">+</span> <span class="n">hit_group_index</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">shader_handle_stride</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__map_w_table_tensor</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">shader_handle_stride</span><span class="p">]</span> <span class="o">=</span> <span class="n">_torch</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">shader_group</span><span class="o">.</span><span class="n">handle</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">_torch</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span></div>


<div class="viewcode-block" id="RTProgram.set_callable">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.RTProgram.set_callable">[docs]</a>
    <span class="k">def</span> <span class="nf">set_callable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callable_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">shader_group</span><span class="p">:</span> <span class="n">ShaderHandler</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">__map_w_table</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Program need to updated inside a context, use with program...&#39;</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">callable_offset</span> <span class="o">+</span> <span class="n">callable_index</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">shader_handle_stride</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__map_w_table_tensor</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">shader_handle_stride</span><span class="p">]</span> <span class="o">=</span> <span class="n">_torch</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">shader_group</span><span class="o">.</span><span class="n">handle</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">_torch</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="DescriptorSet">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.DescriptorSet">[docs]</a>
<span class="k">class</span> <span class="nc">DescriptorSet</span><span class="p">:</span>
<div class="viewcode-block" id="DescriptorSet.__init__">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.DescriptorSet.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w_ds</span><span class="p">:</span> <span class="n">_internal</span><span class="o">.</span><span class="n">DescriptorSetWrapper</span><span class="p">,</span> <span class="n">layout_reference_names</span><span class="p">:</span> <span class="n">_typing</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">_typing</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_ds</span> <span class="o">=</span> <span class="n">w_ds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layout_reference_name</span> <span class="o">=</span> <span class="n">layout_reference_names</span></div>


<div class="viewcode-block" id="DescriptorSet.update">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.DescriptorSet.update">[docs]</a>
    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">bindings</span><span class="p">:</span> <span class="n">_typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="s1">&#39;Resource&#39;</span><span class="p">,</span> <span class="n">_typing</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="s1">&#39;Resource&#39;</span><span class="p">],</span> <span class="n">_typing</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="s1">&#39;Resource&#39;</span><span class="p">,</span> <span class="s1">&#39;Sampler&#39;</span><span class="p">]]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates the descriptors for bindings in the descriptor set.</span>
<span class="sd">        Notice that grouping bindings updates in a single call might lead to better performance.</span>

<span class="sd">        Example</span>
<span class="sd">        -------</span>
<span class="sd">        &gt;&gt;&gt; pipeline : Pipeline = ...</span>
<span class="sd">        &gt;&gt;&gt; pipeline.layout(set=0, binding=0, transforms=DescriptorType.UNIFORM_BUFFER)</span>
<span class="sd">        &gt;&gt;&gt; pipeline.layout(set=0, binding=1, environment=DescriptorType.SAMPLED_IMAGE)</span>
<span class="sd">        &gt;&gt;&gt; ...</span>
<span class="sd">        &gt;&gt;&gt; pipeline.close()</span>
<span class="sd">        &gt;&gt;&gt; dss = pipeline.create_descriptor_set_collection(set=0, count=1)</span>
<span class="sd">        &gt;&gt;&gt; ds = dss[0]  # peek the only descriptor set in the collection</span>
<span class="sd">        &gt;&gt;&gt; ds.update(  # write resources descriptors to the slots named within pipeline.layout</span>
<span class="sd">        &gt;&gt;&gt;     transforms=my_transforms_buffer,</span>
<span class="sd">        &gt;&gt;&gt;     environment=my_environment_image</span>
<span class="sd">        &gt;&gt;&gt; )</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">convert_to_wrapped</span><span class="p">(</span><span class="n">r</span><span class="p">:</span> <span class="n">_typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="s1">&#39;Resource&#39;</span><span class="p">,</span> <span class="n">_typing</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="s1">&#39;Resource&#39;</span><span class="p">],</span> <span class="n">_typing</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="s1">&#39;Resource&#39;</span><span class="p">,</span> <span class="s1">&#39;Sampler&#39;</span><span class="p">]]):</span>
            <span class="k">if</span> <span class="n">r</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">r</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">convert_to_wrapped</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># sampler element in the tuple is already the wrapper version</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">convert_to_wrapped</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">r</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">w_resource</span>
        <span class="n">to_update</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">bindings</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">assert</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layout_reference_name</span>
            <span class="nb">set</span><span class="p">,</span> <span class="n">binding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layout_reference_name</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">assert</span> <span class="nb">set</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_ds</span><span class="o">.</span><span class="n">set</span>
            <span class="n">to_update</span><span class="p">[</span><span class="n">binding</span><span class="p">]</span> <span class="o">=</span> <span class="n">convert_to_wrapped</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_ds</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">to_update</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="DescriptorSetCollection">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.DescriptorSetCollection">[docs]</a>
<span class="k">class</span> <span class="nc">DescriptorSetCollection</span><span class="p">:</span>
<div class="viewcode-block" id="DescriptorSetCollection.__init__">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.DescriptorSetCollection.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w_dsc</span><span class="p">:</span> <span class="n">_internal</span><span class="o">.</span><span class="n">DescriptorSetCollectionWrapper</span><span class="p">,</span> <span class="n">layout_reference_names</span><span class="p">:</span> <span class="n">_typing</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">_typing</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_dsc</span> <span class="o">=</span> <span class="n">w_dsc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layout_reference_names</span> <span class="o">=</span> <span class="n">layout_reference_names</span></div>


    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w_dsc</span><span class="o">.</span><span class="n">desc_sets_wrappers</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">DescriptorSet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w_dsc</span><span class="o">.</span><span class="n">desc_sets_wrappers</span><span class="p">[</span><span class="n">item</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">layout_reference_names</span><span class="p">)</span></div>




<div class="viewcode-block" id="Pipeline">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.Pipeline">[docs]</a>
<span class="k">class</span> <span class="nc">Pipeline</span><span class="p">:</span>
<div class="viewcode-block" id="Pipeline.__init__">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.Pipeline.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w_pipeline</span><span class="p">:</span> <span class="n">_internal</span><span class="o">.</span><span class="n">PipelineWrapper</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_pipeline</span> <span class="o">=</span> <span class="n">w_pipeline</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layout_reference_names</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># maps name to layout (set, binding)</span></div>


<div class="viewcode-block" id="Pipeline.is_closed">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.Pipeline.is_closed">[docs]</a>
    <span class="k">def</span> <span class="nf">is_closed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_pipeline</span><span class="o">.</span><span class="n">initialized</span></div>


<div class="viewcode-block" id="Pipeline.close">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.Pipeline.close">[docs]</a>
    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_pipeline</span><span class="o">.</span><span class="n">_build</span><span class="p">()</span></div>


    <span class="k">class</span> <span class="nc">_ShaderStageContext</span><span class="p">:</span>

        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline</span><span class="p">,</span> <span class="o">*</span><span class="n">new_stages</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span> <span class="o">=</span> <span class="n">pipeline</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">new_stages</span> <span class="o">=</span> <span class="n">new_stages</span>

        <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">w_pipeline</span><span class="o">.</span><span class="n">push_active_stages</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">new_stages</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span>

        <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">w_pipeline</span><span class="o">.</span><span class="n">pop_active_stages</span><span class="p">()</span>

<div class="viewcode-block" id="Pipeline.shader_stages">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.Pipeline.shader_stages">[docs]</a>
    <span class="k">def</span> <span class="nf">shader_stages</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">shader_stages</span><span class="p">:</span> <span class="n">ShaderStage</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Activates temporarily a set of shader stages.</span>
<span class="sd">        To be used in a context scope. e.g.,</span>
<span class="sd">        &gt;&gt;&gt; pipeline: Pipeline = ...</span>
<span class="sd">        &gt;&gt;&gt; # here pipeline has all stages active</span>
<span class="sd">        &gt;&gt;&gt; with pipeline.shader_stages(ShaderStage.VERTEX, ShaderStage.FRAGMENT):</span>
<span class="sd">        &gt;&gt;&gt; ... # settings requiring only VS and FS stages active</span>
<span class="sd">        &gt;&gt;&gt; # here pipeline has all stages active again</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">shader_stages</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;At least one shader stage should be active&#39;</span>
        <span class="k">return</span> <span class="n">Pipeline</span><span class="o">.</span><span class="n">_ShaderStageContext</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">shader_stages</span><span class="p">)</span></div>


<div class="viewcode-block" id="Pipeline.layout">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.Pipeline.layout">[docs]</a>
    <span class="k">def</span> <span class="nf">layout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
               <span class="nb">set</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
               <span class="n">binding</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
               <span class="n">array_size</span><span class="p">:</span> <span class="n">_typing</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
               <span class="n">is_variable</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
               <span class="o">**</span><span class="n">bind_declaration</span><span class="p">:</span> <span class="n">DescriptorType</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Declares a part of the pipeline layout.</span>
<span class="sd">        set: specify the set number this bind belongs to.</span>
<span class="sd">        binding: specify the binding slot.</span>
<span class="sd">        array_size: Number of resources bound as an array.</span>
<span class="sd">        is_variable: If true, the bound array is not fixed although count is used as upper bound.</span>
<span class="sd">        bind_declaration: A single key-value pair indicating the reference name and the descriptor type,</span>
<span class="sd">        Example:</span>
<span class="sd">        &gt;&gt;&gt; pipeline: Pipeline = ...</span>
<span class="sd">        &gt;&gt;&gt; pipeline.layout(set=0, binding=0, camera_transforms=DescriptorType.UNIFORM_BUFFER)</span>
<span class="sd">        &gt;&gt;&gt; pipeline.layout(set=1, binding=0, model_transform=DescriptorType.UNIFORM_BUFFER)</span>
<span class="sd">        &gt;&gt;&gt; pipeline.layout(set=1, binding=1, array_size=10, model_textures=DescriptorType.SAMPLED_IMAGE)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">bind_declaration</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;One and only one bind declaration must be provided.&#39;</span>
        <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">bind_declaration</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
        <span class="k">if</span> <span class="n">is_variable</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">array_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Only arrays can be unbound size. In that case, array_size must be specified as upper bound.&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">array_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">array_size</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># used as count for single descriptors</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">DescriptorType</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layout_reference_names</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;The name </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1"> is already used in the pipeline layout&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layout_reference_names</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">set</span><span class="p">,</span> <span class="n">binding</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_pipeline</span><span class="o">.</span><span class="n">layout</span><span class="p">(</span><span class="nb">set</span><span class="o">=</span><span class="nb">set</span><span class="p">,</span> <span class="n">binding</span><span class="o">=</span><span class="n">binding</span><span class="p">,</span> <span class="n">descriptor_type</span><span class="o">=</span><span class="n">v</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">array_size</span><span class="p">,</span> <span class="n">is_variable</span><span class="o">=</span><span class="n">is_variable</span><span class="p">)</span></div>


<div class="viewcode-block" id="Pipeline.load_shader">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.Pipeline.load_shader">[docs]</a>
    <span class="k">def</span> <span class="nf">load_shader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">specialization</span><span class="p">,</span> <span class="n">main_function</span> <span class="o">=</span> <span class="s1">&#39;main&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_pipeline</span><span class="o">.</span><span class="n">load_shader</span><span class="p">(</span><span class="n">_internal</span><span class="o">.</span><span class="n">ShaderStageWrapper</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span>
            <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">w_pipeline</span><span class="o">.</span><span class="n">w_device</span><span class="p">,</span>
            <span class="n">main_function</span><span class="o">=</span><span class="n">main_function</span><span class="p">,</span>
            <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span>
            <span class="n">specialization</span><span class="o">=</span><span class="n">specialization</span>
        <span class="p">))</span></div>


<div class="viewcode-block" id="Pipeline.load_shader_from_source">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.Pipeline.load_shader_from_source">[docs]</a>
    <span class="k">def</span> <span class="nf">load_shader_from_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="o">*</span><span class="n">specialization</span><span class="p">,</span> <span class="n">main_function</span> <span class="o">=</span> <span class="s1">&#39;main&#39;</span><span class="p">,</span> <span class="n">include_dirs</span> <span class="o">=</span> <span class="p">[]):</span>
        <span class="n">stage_prefix</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">ShaderStage</span><span class="o">.</span><span class="n">VERTEX</span><span class="p">:</span> <span class="s1">&#39;vert&#39;</span><span class="p">,</span>
            <span class="n">ShaderStage</span><span class="o">.</span><span class="n">FRAGMENT</span><span class="p">:</span> <span class="s1">&#39;frag&#39;</span><span class="p">,</span>
            <span class="n">ShaderStage</span><span class="o">.</span><span class="n">COMPUTE</span><span class="p">:</span> <span class="s1">&#39;comp&#39;</span><span class="p">,</span>
            <span class="n">ShaderStage</span><span class="o">.</span><span class="n">RT_GENERATION</span><span class="p">:</span> <span class="s1">&#39;rgen&#39;</span><span class="p">,</span>
            <span class="n">ShaderStage</span><span class="o">.</span><span class="n">RT_MISS</span><span class="p">:</span> <span class="s1">&#39;rmiss&#39;</span><span class="p">,</span>
            <span class="n">ShaderStage</span><span class="o">.</span><span class="n">RT_ANY_HIT</span><span class="p">:</span> <span class="s1">&#39;rahit&#39;</span><span class="p">,</span>
            <span class="n">ShaderStage</span><span class="o">.</span><span class="n">RT_INTERSECTION_HIT</span><span class="p">:</span> <span class="s1">&#39;rint&#39;</span><span class="p">,</span>
            <span class="n">ShaderStage</span><span class="o">.</span><span class="n">RT_CLOSEST_HIT</span><span class="p">:</span> <span class="s1">&#39;rchit&#39;</span><span class="p">,</span>
            <span class="n">ShaderStage</span><span class="o">.</span><span class="n">RT_CALLABLE</span><span class="p">:</span> <span class="s1">&#39;rcall&#39;</span><span class="p">,</span>
        <span class="p">}[</span><span class="bp">self</span><span class="o">.</span><span class="n">w_pipeline</span><span class="o">.</span><span class="n">get_single_active_shader_stage</span><span class="p">()]</span>
        <span class="n">shader_id</span>  <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="c1"># try:</span>
        <span class="n">binary_code</span> <span class="o">=</span> <span class="n">compile_shader_source</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">stage_prefix</span><span class="p">,</span> <span class="n">include_dirs</span><span class="p">)</span>
        <span class="n">shader_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_pipeline</span><span class="o">.</span><span class="n">load_shader</span><span class="p">(</span><span class="n">_internal</span><span class="o">.</span><span class="n">ShaderStageWrapper</span><span class="o">.</span><span class="n">from_binary</span><span class="p">(</span>
            <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">w_pipeline</span><span class="o">.</span><span class="n">w_device</span><span class="p">,</span>
            <span class="n">main_function</span><span class="o">=</span><span class="n">main_function</span><span class="p">,</span>
            <span class="n">bytecode</span><span class="o">=</span><span class="n">binary_code</span><span class="p">,</span>
            <span class="n">specialization</span><span class="o">=</span><span class="n">specialization</span>
        <span class="p">))</span>
        <span class="c1"># except:</span>
        <span class="c1">#     pass</span>

        <span class="k">if</span> <span class="n">shader_id</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Error compiling code&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">shader_id</span></div>


<div class="viewcode-block" id="Pipeline.create_descriptor_set_collection">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.Pipeline.create_descriptor_set_collection">[docs]</a>
    <span class="k">def</span> <span class="nf">create_descriptor_set_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">set</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">count</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">DescriptorSetCollection</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">w_pipeline</span><span class="o">.</span><span class="n">create_descriptor_set_collection</span><span class="p">(</span><span class="nb">set</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">variable_size</span><span class="o">=</span><span class="n">count</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">layout_reference_names</span>
        <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="GraphicsPipeline">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.GraphicsPipeline">[docs]</a>
<span class="k">class</span> <span class="nc">GraphicsPipeline</span><span class="p">(</span><span class="n">Pipeline</span><span class="p">):</span>
<div class="viewcode-block" id="GraphicsPipeline.__init__">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.GraphicsPipeline.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w_pipeline</span><span class="p">:</span> <span class="n">_internal</span><span class="o">.</span><span class="n">PipelineWrapper</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">w_pipeline</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attach_reference_names</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># maps name to attach slot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vertex_reference_names</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># maps name to vertex attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vertex_bindings</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># maps bindings to dict[attribute_name, offset]</span></div>


<div class="viewcode-block" id="GraphicsPipeline.attach">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.GraphicsPipeline.attach">[docs]</a>
    <span class="k">def</span> <span class="nf">attach</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slot</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="o">**</span><span class="n">attach_declaration</span><span class="p">:</span> <span class="n">Format</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">attach_declaration</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">attach_declaration</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
        <span class="k">assert</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attach_reference_names</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">Format</span><span class="p">),</span> <span class="s1">&#39;Attachment declaration must be a Format&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_pipeline</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">slot</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">v</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attach_reference_names</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">slot</span></div>


<div class="viewcode-block" id="GraphicsPipeline.vertex">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.GraphicsPipeline.vertex">[docs]</a>
    <span class="k">def</span> <span class="nf">vertex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">location</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="o">**</span><span class="n">attribute_declaration</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">attribute_declaration</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">attribute_declaration</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
        <span class="k">assert</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vertex_reference_names</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">Format</span><span class="p">),</span> <span class="s1">&#39;Vertex attribute declaration must be a Format&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_pipeline</span><span class="o">.</span><span class="n">vertex</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vertex_reference_names</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span></div>


<div class="viewcode-block" id="GraphicsPipeline.vertex_binding">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.GraphicsPipeline.vertex_binding">[docs]</a>
    <span class="k">def</span> <span class="nf">vertex_binding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">binding</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">stride</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="o">**</span><span class="n">attribute_offset_map</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">binding</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vertex_bindings</span><span class="p">,</span> <span class="s1">&#39;Vertex-buffer binding slot already set&#39;</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vertex_reference_names</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">attribute_offset_map</span><span class="p">),</span> <span class="s1">&#39;Vertex-buffer binding refers to a vertex attribute has not declared.&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vertex_bindings</span><span class="p">[</span><span class="n">binding</span><span class="p">]</span> <span class="o">=</span> <span class="n">attribute_offset_map</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_pipeline</span><span class="o">.</span><span class="n">vertex_binding</span><span class="p">(</span><span class="n">binding</span><span class="p">,</span> <span class="n">stride</span><span class="p">,</span> <span class="p">{</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vertex_reference_names</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span> <span class="n">offset</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">offset</span> <span class="ow">in</span> <span class="n">attribute_offset_map</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">})</span></div>


<div class="viewcode-block" id="GraphicsPipeline.create_framebuffer">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.GraphicsPipeline.create_framebuffer">[docs]</a>
    <span class="k">def</span> <span class="nf">create_framebuffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">width</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">height</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">layers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">bindings</span><span class="p">:</span> <span class="n">_typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="s1">&#39;Image&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">FrameBuffer</span><span class="p">:</span>
        <span class="n">max_slot</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attach_reference_names</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="k">else</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attach_reference_names</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">attachments</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">max_slot</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">bindings</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">attachments</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">attach_reference_names</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">v</span><span class="o">.</span><span class="n">w_resource</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_pipeline</span><span class="o">.</span><span class="n">create_framebuffer</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">layers</span><span class="p">,</span> <span class="n">attachments</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="RaytracingPipeline">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.RaytracingPipeline">[docs]</a>
<span class="k">class</span> <span class="nc">RaytracingPipeline</span><span class="p">(</span><span class="n">Pipeline</span><span class="p">):</span>
<div class="viewcode-block" id="RaytracingPipeline.__init__">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.RaytracingPipeline.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w_pipeline</span><span class="p">:</span> <span class="n">_internal</span><span class="o">.</span><span class="n">PipelineWrapper</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">w_pipeline</span><span class="p">)</span></div>


<div class="viewcode-block" id="RaytracingPipeline.create_rt_hit_group">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.RaytracingPipeline.create_rt_hit_group">[docs]</a>
    <span class="k">def</span> <span class="nf">create_rt_hit_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">closest_hit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">any_hit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">intersection</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_pipeline</span><span class="o">.</span><span class="n">create_hit_group</span><span class="p">(</span><span class="n">closest_hit</span><span class="p">,</span> <span class="n">any_hit</span><span class="p">,</span> <span class="n">intersection</span><span class="p">)</span></div>


<div class="viewcode-block" id="RaytracingPipeline.create_rt_gen_group">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.RaytracingPipeline.create_rt_gen_group">[docs]</a>
    <span class="k">def</span> <span class="nf">create_rt_gen_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">generation_shader_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_pipeline</span><span class="o">.</span><span class="n">create_general_group</span><span class="p">(</span><span class="n">generation_shader_index</span><span class="p">)</span></div>


<div class="viewcode-block" id="RaytracingPipeline.create_rt_miss_group">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.RaytracingPipeline.create_rt_miss_group">[docs]</a>
    <span class="k">def</span> <span class="nf">create_rt_miss_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">miss_shader_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_pipeline</span><span class="o">.</span><span class="n">create_general_group</span><span class="p">(</span><span class="n">miss_shader_index</span><span class="p">)</span></div>


<div class="viewcode-block" id="RaytracingPipeline.create_rt_callable_group">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.RaytracingPipeline.create_rt_callable_group">[docs]</a>
    <span class="k">def</span> <span class="nf">create_rt_callable_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callable_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_pipeline</span><span class="o">.</span><span class="n">create_general_group</span><span class="p">(</span><span class="n">callable_index</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_get_aligned_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">align</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">size</span> <span class="o">+</span> <span class="n">align</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">align</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>

<div class="viewcode-block" id="RaytracingPipeline.create_rt_program">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.RaytracingPipeline.create_rt_program">[docs]</a>
    <span class="k">def</span> <span class="nf">create_rt_program</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_raygen_shader</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_miss_shader</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">max_hit_groups</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">max_callable</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RTProgram</span><span class="p">:</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_closed</span><span class="p">(),</span> <span class="s1">&#39;Can not create programs from a pipeline is still open. Please close the pipeline first.&#39;</span>

        <span class="n">shaderHandlerSize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_pipeline</span><span class="o">.</span><span class="n">w_device</span><span class="o">.</span><span class="n">raytracing_properties</span><span class="o">.</span><span class="n">shaderGroupHandleSize</span>
        <span class="n">groupAlignment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_pipeline</span><span class="o">.</span><span class="n">w_device</span><span class="o">.</span><span class="n">raytracing_properties</span><span class="o">.</span><span class="n">shaderGroupBaseAlignment</span>

        <span class="n">raygen_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_aligned_size</span><span class="p">(</span><span class="n">shaderHandlerSize</span> <span class="o">*</span> <span class="n">max_raygen_shader</span><span class="p">,</span> <span class="n">groupAlignment</span><span class="p">)</span>
        <span class="n">raymiss_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_aligned_size</span><span class="p">(</span><span class="n">shaderHandlerSize</span> <span class="o">*</span> <span class="n">max_miss_shader</span><span class="p">,</span> <span class="n">groupAlignment</span><span class="p">)</span>
        <span class="n">rayhit_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_aligned_size</span><span class="p">(</span><span class="n">shaderHandlerSize</span> <span class="o">*</span> <span class="n">max_hit_groups</span><span class="p">,</span> <span class="n">groupAlignment</span><span class="p">)</span>
        <span class="n">raycall_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_aligned_size</span><span class="p">(</span><span class="n">shaderHandlerSize</span> <span class="o">*</span> <span class="n">max_callable</span><span class="p">,</span> <span class="n">groupAlignment</span><span class="p">)</span>

        <span class="n">w_buffer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_pipeline</span><span class="o">.</span><span class="n">w_device</span><span class="o">.</span><span class="n">create_buffer</span><span class="p">(</span>
            <span class="n">raygen_size</span> <span class="o">+</span> <span class="n">raymiss_size</span> <span class="o">+</span> <span class="n">rayhit_size</span> <span class="o">+</span> <span class="n">raycall_size</span><span class="p">,</span>
            <span class="n">usage</span><span class="o">=</span><span class="n">BufferUsage</span><span class="o">.</span><span class="n">SHADER_TABLE</span><span class="p">,</span>
            <span class="n">memory</span><span class="o">=</span><span class="n">MemoryLocation</span><span class="o">.</span><span class="n">CPU</span><span class="p">)</span><span class="c1"># .clear(self.w_pipeline.w_device)</span>
        <span class="k">return</span> <span class="n">RTProgram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w_buffer</span><span class="p">,</span> <span class="n">raygen_size</span><span class="p">,</span> <span class="n">raygen_size</span> <span class="o">+</span> <span class="n">raymiss_size</span><span class="p">,</span> <span class="n">raygen_size</span> <span class="o">+</span> <span class="n">raymiss_size</span> <span class="o">+</span> <span class="n">rayhit_size</span><span class="p">)</span></div>


<div class="viewcode-block" id="RaytracingPipeline.stack_size">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.RaytracingPipeline.stack_size">[docs]</a>
    <span class="k">def</span> <span class="nf">stack_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">depth</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_pipeline</span><span class="o">.</span><span class="n">set_max_recursion</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="CommandManager">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.CommandManager">[docs]</a>
<span class="k">class</span> <span class="nc">CommandManager</span><span class="p">:</span>

<div class="viewcode-block" id="CommandManager.__init__">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.CommandManager.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">w_cmdList</span><span class="p">:</span> <span class="n">_internal</span><span class="o">.</span><span class="n">CommandBufferWrapper</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_cmdList</span> <span class="o">=</span> <span class="n">w_cmdList</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span></div>


    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_cmdList</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="CommandManager.get_queue_required">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.CommandManager.get_queue_required">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_queue_required</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="CommandManager.freeze">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.CommandManager.freeze">[docs]</a>
    <span class="k">def</span> <span class="nf">freeze</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_cmdList</span><span class="o">.</span><span class="n">freeze</span><span class="p">()</span></div>


<div class="viewcode-block" id="CommandManager.is_frozen">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.CommandManager.is_frozen">[docs]</a>
    <span class="k">def</span> <span class="nf">is_frozen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_cmdList</span><span class="o">.</span><span class="n">is_frozen</span><span class="p">()</span></div>


<div class="viewcode-block" id="CommandManager.is_closed">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.CommandManager.is_closed">[docs]</a>
    <span class="k">def</span> <span class="nf">is_closed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_cmdList</span><span class="o">.</span><span class="n">is_closed</span><span class="p">()</span></div>


    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_cmdList</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_cmdList</span><span class="o">.</span><span class="n">flush_and_wait</span><span class="p">()</span>
        <span class="c1"># self.device.safe_dispatch_function(lambda: self.w_cmdList.flush_and_wait())</span>

<div class="viewcode-block" id="CommandManager.use">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.CommandManager.use">[docs]</a>
    <span class="k">def</span> <span class="nf">use</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">:</span> <span class="n">Image</span><span class="p">,</span> <span class="n">image_usage</span><span class="p">:</span> <span class="n">ImageUsage</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_cmdList</span><span class="o">.</span><span class="n">use_image_as</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">w_resource</span><span class="p">,</span> <span class="n">image_usage</span><span class="p">)</span></div>


<div class="viewcode-block" id="CommandManager.image_barrier">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.CommandManager.image_barrier">[docs]</a>
    <span class="k">def</span> <span class="nf">image_barrier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">:</span> <span class="n">Image</span><span class="p">,</span> <span class="n">image_usage</span><span class="p">:</span> <span class="n">ImageUsage</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_cmdList</span><span class="o">.</span><span class="n">transition_image_layout</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">w_resource</span><span class="p">,</span> <span class="n">image_usage</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="CopyManager">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.CopyManager">[docs]</a>
<span class="k">class</span> <span class="nc">CopyManager</span><span class="p">(</span><span class="n">CommandManager</span><span class="p">):</span>
<div class="viewcode-block" id="CopyManager.__init__">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.CopyManager.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">w_cmdList</span><span class="p">:</span> <span class="n">_internal</span><span class="o">.</span><span class="n">CommandBufferWrapper</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">w_cmdList</span><span class="p">)</span></div>


<div class="viewcode-block" id="CopyManager.get_queue_required">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.CopyManager.get_queue_required">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_queue_required</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">QueueType</span><span class="o">.</span><span class="n">COPY</span></div>


<div class="viewcode-block" id="CopyManager.copy">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.CopyManager.copy">[docs]</a>
    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src_resource</span><span class="p">,</span> <span class="n">dst_resource</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">src_resource</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">dst_resource</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_cmdList</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">src_resource</span><span class="o">.</span><span class="n">w_resource</span><span class="p">,</span> <span class="n">dst_resource</span><span class="o">.</span><span class="n">w_resource</span><span class="p">)</span></div>
</div>


    <span class="c1"># def copy_image(self, src_image: Image, dst_image: Image):</span>
    <span class="c1">#     self.w_cmdList.copy_image(src_image.w_resource, dst_image.w_resource)</span>
    <span class="c1">#</span>
    <span class="c1"># def copy_buffer_to_image(self, src_buffer: Buffer, dst_image: Image):</span>
    <span class="c1">#     self.w_cmdList.copy_buffer_to_image(src_buffer.w_resource, dst_image.w_resource)</span>


<div class="viewcode-block" id="ComputeManager">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.ComputeManager">[docs]</a>
<span class="k">class</span> <span class="nc">ComputeManager</span><span class="p">(</span><span class="n">CopyManager</span><span class="p">):</span>
<div class="viewcode-block" id="ComputeManager.__init__">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.ComputeManager.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">w_cmdList</span><span class="p">:</span> <span class="n">_internal</span><span class="o">.</span><span class="n">CommandBufferWrapper</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">w_cmdList</span><span class="p">)</span></div>


<div class="viewcode-block" id="ComputeManager.get_queue_required">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.ComputeManager.get_queue_required">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_queue_required</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">QueueType</span><span class="o">.</span><span class="n">COMPUTE</span></div>


<div class="viewcode-block" id="ComputeManager.clear_color">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.ComputeManager.clear_color">[docs]</a>
    <span class="k">def</span> <span class="nf">clear_color</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">:</span> <span class="n">Image</span><span class="p">,</span> <span class="n">color</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_cmdList</span><span class="o">.</span><span class="n">clear_color</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">w_resource</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span></div>


<div class="viewcode-block" id="ComputeManager.clear_depth_stencil">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.ComputeManager.clear_depth_stencil">[docs]</a>
    <span class="k">def</span> <span class="nf">clear_depth_stencil</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">:</span> <span class="n">Image</span><span class="p">,</span> <span class="n">depth</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">stencil</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_cmdList</span><span class="o">.</span><span class="n">clear_depth_stencil</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">w_resource</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">stencil</span><span class="p">)</span></div>


<div class="viewcode-block" id="ComputeManager.clear_buffer">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.ComputeManager.clear_buffer">[docs]</a>
    <span class="k">def</span> <span class="nf">clear_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buffer</span><span class="p">:</span> <span class="n">Buffer</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_cmdList</span><span class="o">.</span><span class="n">clear_buffer</span><span class="p">(</span><span class="n">buffer</span><span class="o">.</span><span class="n">w_resource</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>


<div class="viewcode-block" id="ComputeManager.set_pipeline">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.ComputeManager.set_pipeline">[docs]</a>
    <span class="k">def</span> <span class="nf">set_pipeline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline</span><span class="p">:</span> <span class="n">Pipeline</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">is_closed</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Error, can not set a pipeline has not been closed.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_cmdList</span><span class="o">.</span><span class="n">set_pipeline</span><span class="p">(</span><span class="n">pipeline</span><span class="o">=</span><span class="n">pipeline</span><span class="o">.</span><span class="n">w_pipeline</span><span class="p">)</span></div>


<div class="viewcode-block" id="ComputeManager.bind">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.ComputeManager.bind">[docs]</a>
    <span class="k">def</span> <span class="nf">bind</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">:</span> <span class="n">DescriptorSet</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_cmdList</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">w_ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">w_ds</span><span class="p">)</span></div>


<div class="viewcode-block" id="ComputeManager.update_sets">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.ComputeManager.update_sets">[docs]</a>
    <span class="k">def</span> <span class="nf">update_sets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">sets</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sets</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">w_cmdList</span><span class="o">.</span><span class="n">update_bindings_level</span><span class="p">(</span><span class="n">s</span><span class="p">)</span></div>


<div class="viewcode-block" id="ComputeManager.update_constants">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.ComputeManager.update_constants">[docs]</a>
    <span class="k">def</span> <span class="nf">update_constants</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">fields</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_cmdList</span><span class="o">.</span><span class="n">update_constants</span><span class="p">(</span><span class="o">**</span><span class="n">fields</span><span class="p">)</span></div>


<div class="viewcode-block" id="ComputeManager.dispatch_groups">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.ComputeManager.dispatch_groups">[docs]</a>
    <span class="k">def</span> <span class="nf">dispatch_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">groups_x</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">groups_y</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">groups_z</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_cmdList</span><span class="o">.</span><span class="n">dispatch_groups</span><span class="p">(</span><span class="n">groups_x</span><span class="p">,</span> <span class="n">groups_y</span><span class="p">,</span> <span class="n">groups_z</span><span class="p">)</span></div>


<div class="viewcode-block" id="ComputeManager.dispatch_threads">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.ComputeManager.dispatch_threads">[docs]</a>
    <span class="k">def</span> <span class="nf">dispatch_threads</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim_x</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">dim_y</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">dim_z</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">group_size_x</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">group_size_y</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">group_size_z</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dispatch_groups</span><span class="p">((</span><span class="n">dim_x</span> <span class="o">+</span> <span class="n">group_size_x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="n">group_size_x</span><span class="p">,</span> <span class="p">(</span><span class="n">dim_y</span> <span class="o">+</span> <span class="n">group_size_y</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="n">group_size_y</span><span class="p">,</span> <span class="p">(</span><span class="n">dim_z</span> <span class="o">+</span> <span class="n">group_size_z</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="n">group_size_z</span><span class="p">)</span></div>


<div class="viewcode-block" id="ComputeManager.dispatch_threads_1D">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.ComputeManager.dispatch_threads_1D">[docs]</a>
    <span class="k">def</span> <span class="nf">dispatch_threads_1D</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim_x</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">group_size_x</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">math</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dispatch_groups</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">dim_x</span> <span class="o">/</span> <span class="n">group_size_x</span><span class="p">))</span></div>


<div class="viewcode-block" id="ComputeManager.dispatch_threads_2D">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.ComputeManager.dispatch_threads_2D">[docs]</a>
    <span class="k">def</span> <span class="nf">dispatch_threads_2D</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim_x</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">dim_y</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">group_size_x</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span> <span class="n">group_size_y</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">math</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dispatch_groups</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">dim_x</span> <span class="o">/</span> <span class="n">group_size_x</span><span class="p">),</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">dim_y</span> <span class="o">/</span> <span class="n">group_size_y</span><span class="p">))</span></div>
</div>



<div class="viewcode-block" id="GraphicsManager">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.GraphicsManager">[docs]</a>
<span class="k">class</span> <span class="nc">GraphicsManager</span><span class="p">(</span><span class="n">ComputeManager</span><span class="p">):</span>
<div class="viewcode-block" id="GraphicsManager.__init__">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.GraphicsManager.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">w_cmdList</span><span class="p">:</span> <span class="n">_internal</span><span class="o">.</span><span class="n">CommandBufferWrapper</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">w_cmdList</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_framebuffer</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="GraphicsManager.set_framebuffer">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.GraphicsManager.set_framebuffer">[docs]</a>
    <span class="k">def</span> <span class="nf">set_framebuffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">framebuffer</span><span class="p">:</span> <span class="n">FrameBuffer</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_cmdList</span><span class="o">.</span><span class="n">set_framebuffer</span><span class="p">(</span><span class="n">framebuffer</span><span class="p">)</span></div>


<div class="viewcode-block" id="GraphicsManager.get_queue_required">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.GraphicsManager.get_queue_required">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_queue_required</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">QueueType</span><span class="o">.</span><span class="n">GRAPHICS</span></div>


<div class="viewcode-block" id="GraphicsManager.blit_image">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.GraphicsManager.blit_image">[docs]</a>
    <span class="k">def</span> <span class="nf">blit_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src_image</span><span class="p">:</span> <span class="n">Image</span><span class="p">,</span> <span class="n">dst_image</span><span class="p">:</span> <span class="n">Image</span><span class="p">,</span> <span class="nb">filter</span><span class="p">:</span> <span class="n">Filter</span> <span class="o">=</span> <span class="n">Filter</span><span class="o">.</span><span class="n">POINT</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_cmdList</span><span class="o">.</span><span class="n">blit_image</span><span class="p">(</span><span class="n">src_image</span><span class="o">.</span><span class="n">w_resource</span><span class="p">,</span> <span class="n">dst_image</span><span class="o">.</span><span class="n">w_resource</span><span class="p">,</span> <span class="nb">filter</span><span class="p">)</span></div>


<div class="viewcode-block" id="GraphicsManager.dispatch_primitives">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.GraphicsManager.dispatch_primitives">[docs]</a>
    <span class="k">def</span> <span class="nf">dispatch_primitives</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vertices</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">instances</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">vertex_start</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">instance_start</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_cmdList</span><span class="o">.</span><span class="n">dispatch_primitives</span><span class="p">(</span>
            <span class="n">vertices</span><span class="p">,</span> <span class="n">instances</span><span class="p">,</span> <span class="n">vertex_start</span><span class="p">,</span> <span class="n">instance_start</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="GraphicsManager.dispatch_indexed_primitives">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.GraphicsManager.dispatch_indexed_primitives">[docs]</a>
    <span class="k">def</span> <span class="nf">dispatch_indexed_primitives</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">instances</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">first_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">vertex_offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">first_instance</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_cmdList</span><span class="o">.</span><span class="n">dispatch_indexed_primitives</span><span class="p">(</span>
            <span class="n">indices</span><span class="p">,</span> <span class="n">instances</span><span class="p">,</span> <span class="n">first_index</span><span class="p">,</span> <span class="n">vertex_offset</span><span class="p">,</span> <span class="n">first_instance</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="GraphicsManager.bind_vertex_buffer">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.GraphicsManager.bind_vertex_buffer">[docs]</a>
    <span class="k">def</span> <span class="nf">bind_vertex_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">binding</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">vertex_buffer</span><span class="p">:</span> <span class="n">Buffer</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_cmdList</span><span class="o">.</span><span class="n">bind_vertex_buffer</span><span class="p">(</span><span class="n">binding</span><span class="p">,</span> <span class="n">vertex_buffer</span><span class="o">.</span><span class="n">w_resource</span><span class="p">)</span></div>


<div class="viewcode-block" id="GraphicsManager.bind_index_buffer">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.GraphicsManager.bind_index_buffer">[docs]</a>
    <span class="k">def</span> <span class="nf">bind_index_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index_buffer</span><span class="p">:</span> <span class="n">Buffer</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_cmdList</span><span class="o">.</span><span class="n">bind_index_buffer</span><span class="p">(</span><span class="n">index_buffer</span><span class="o">.</span><span class="n">w_resource</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="RaytracingManager">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.RaytracingManager">[docs]</a>
<span class="k">class</span> <span class="nc">RaytracingManager</span><span class="p">(</span><span class="n">GraphicsManager</span><span class="p">):</span>
<div class="viewcode-block" id="RaytracingManager.__init__">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.RaytracingManager.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">w_cmdList</span><span class="p">:</span> <span class="n">_internal</span><span class="o">.</span><span class="n">CommandBufferWrapper</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">w_cmdList</span><span class="p">)</span></div>


<div class="viewcode-block" id="RaytracingManager.get_queue_required">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.RaytracingManager.get_queue_required">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_queue_required</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">QueueType</span><span class="o">.</span><span class="n">RAYTRACING</span></div>


<div class="viewcode-block" id="RaytracingManager.build_ads">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.RaytracingManager.build_ads">[docs]</a>
    <span class="k">def</span> <span class="nf">build_ads</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ads</span><span class="p">:</span> <span class="n">ADS</span><span class="p">,</span> <span class="n">scratch_buffer</span><span class="p">:</span> <span class="n">Buffer</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_cmdList</span><span class="o">.</span><span class="n">build_ads</span><span class="p">(</span>
            <span class="n">ads</span><span class="o">.</span><span class="n">w_resource</span><span class="p">,</span>
            <span class="n">ads</span><span class="o">.</span><span class="n">ads_info</span><span class="p">,</span>
            <span class="n">ads</span><span class="o">.</span><span class="n">ranges</span><span class="p">,</span>
            <span class="n">scratch_buffer</span><span class="o">.</span><span class="n">w_resource</span><span class="p">)</span></div>


<div class="viewcode-block" id="RaytracingManager.update_ads">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.RaytracingManager.update_ads">[docs]</a>
    <span class="k">def</span> <span class="nf">update_ads</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ads</span><span class="p">:</span> <span class="n">ADS</span><span class="p">,</span> <span class="n">scratch_buffer</span><span class="p">:</span> <span class="n">Buffer</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_cmdList</span><span class="o">.</span><span class="n">update_ads</span><span class="p">(</span>
            <span class="n">ads</span><span class="o">.</span><span class="n">w_resource</span><span class="p">,</span>
            <span class="n">ads</span><span class="o">.</span><span class="n">ads_info</span><span class="p">,</span>
            <span class="n">ads</span><span class="o">.</span><span class="n">ranges</span><span class="p">,</span>
            <span class="n">scratch_buffer</span><span class="o">.</span><span class="n">w_resource</span><span class="p">)</span></div>


<div class="viewcode-block" id="RaytracingManager.dispatch_rays">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.RaytracingManager.dispatch_rays">[docs]</a>
    <span class="k">def</span> <span class="nf">dispatch_rays</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">program</span><span class="p">:</span> <span class="n">RTProgram</span><span class="p">,</span> <span class="n">dim_x</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">dim_y</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">dim_z</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_cmdList</span><span class="o">.</span><span class="n">dispatch_rays</span><span class="p">(</span>
            <span class="n">program</span><span class="o">.</span><span class="n">active_raygen_slice</span><span class="p">(),</span> <span class="n">program</span><span class="o">.</span><span class="n">miss_slice</span><span class="p">,</span> <span class="n">program</span><span class="o">.</span><span class="n">hitgroup_slice</span><span class="p">,</span> <span class="n">program</span><span class="o">.</span><span class="n">callable_slice</span><span class="p">,</span>
            <span class="n">dim_x</span><span class="p">,</span> <span class="n">dim_y</span><span class="p">,</span> <span class="n">dim_z</span>
        <span class="p">)</span></div>
</div>



<span class="k">class</span> <span class="nc">Caps</span><span class="p">:</span>
    <span class="n">ray_tracing</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">zero_copy_buffer_map</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">zero_copy_torch_map</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">cooperative_matrices</span> <span class="o">=</span> <span class="kc">False</span>


<span class="c1"># class GPUWrapping:</span>
<span class="c1">#     def __init__(self, device: &#39;DeviceManager&#39;):</span>
<span class="c1">#         self.device = device</span>
<span class="c1">#         self.wrapped_objs = { }  # maps obj with [gpu_ptr, mode, backend_resource, owner]</span>
<span class="c1">#</span>
<span class="c1">#     def resolve_ptr(self, obj, mode: str) -&gt; int:</span>
<span class="c1">#         if obj is None:</span>
<span class="c1">#             return 0</span>
<span class="c1">#         if obj in self.wrapped_objs:</span>
<span class="c1">#             ptr, current_mode, buffer, data = self.wrapped_objs[obj]</span>
<span class="c1">#             if current_mode == mode:</span>
<span class="c1">#                 return ptr</span>
<span class="c1">#             if mode == &#39;in&#39;:</span>
<span class="c1">#                 buffer.load(data)</span>
<span class="c1">#             self.wrapped_objs[obj][1] = &#39;inout&#39;</span>
<span class="c1">#             return ptr</span>
<span class="c1">#         if isinstance(obj, Buffer):  # buffer</span>
<span class="c1">#             return obj.device_ptr()</span>
<span class="c1">#         if isinstance(obj, ViewTensor):  # tensor with memory in vulkan memory</span>
<span class="c1">#             if isinstance(obj.memory_owner, VulkanMemory):</span>
<span class="c1">#                 return self.device.torch_ptr_to_device_ptr(obj)</span>
<span class="c1">#                 # memory = obj.memory_owner</span>
<span class="c1">#                 # return memory.cuda_to_device_ptr(obj.data_ptr())</span>
<span class="c1">#         if isinstance(obj, _torch.Tensor):</span>
<span class="c1">#             if obj.device == __TORCH_DEVICE__ and support().zero_copy_torch_map and obj.is_contiguous():  # No need to vulkanize</span>
<span class="c1">#                 return obj.data_ptr()</span>
<span class="c1">#             else:</span>
<span class="c1">#                 print(f&#39;Backing {obj.is_contiguous()}&#39;)</span>
<span class="c1">#                 backend_tensor = tensor_like(obj)</span>
<span class="c1">#                 memory = backend_tensor.memory_owner</span>
<span class="c1">#                 if mode == &#39;in&#39; or mode == &#39;inout&#39;:</span>
<span class="c1">#                     if mode == &#39;inout&#39;:</span>
<span class="c1">#                         assert obj.is_contiguous(), &#39;Can not copy out non-contiguous tensors&#39;</span>
<span class="c1">#                     backend_tensor.copy_(obj.contiguous())</span>
<span class="c1">#                 # self.wrapped_objs[obj] = [memory.cuda_to_device_ptr(obj.data_ptr()), mode, backend_tensor, obj]</span>
<span class="c1">#                 self.wrapped_objs[obj] = [backend_tensor.data_ptr(), mode, backend_tensor, obj]</span>
<span class="c1">#                 return self.wrapped_objs[obj][0]</span>
<span class="c1">#         raise Exception(f&#39;Invalid object type {type(obj)} for wrap&#39;)</span>
<span class="c1">#</span>
<span class="c1">#     def release(self):</span>
<span class="c1">#         if self.wrapped_objs is not None:</span>
<span class="c1">#             for ptr, mode, backup, obj in self.wrapped_objs.values():</span>
<span class="c1">#                 if mode == &#39;out&#39; or mode == &#39;inout&#39;:</span>
<span class="c1">#                     obj.copy_(backup)</span>
<span class="c1">#         self.wrapped_objs = None</span>
<span class="c1">#</span>
<span class="c1">#     # def _wrap_objs(self):</span>
<span class="c1">#     #     l = list(self._wrapping_objs.values())</span>
<span class="c1">#     #     l.sort(key=lambda t: t[1])  #sort by ptr</span>
<span class="c1">#     #     i = 0</span>
<span class="c1">#     #     while i &lt; len(l):</span>
<span class="c1">#     #         start_ptr = l[i][1]</span>
<span class="c1">#     #         end_ptr = start_ptr + l[i][2]</span>
<span class="c1">#     #         j = i + 1</span>
<span class="c1">#     #         while j &lt; len(l) and l[j][1] &lt;= end_ptr:</span>
<span class="c1">#     #             end_ptr = max(end_ptr, l[j][1]+l[j][2])</span>
<span class="c1">#     #             j+=1</span>
<span class="c1">#     #         full_buffer = self.device.create_buffer(end_ptr - start_ptr, usage=BufferUsage.STAGING, memory=MemoryLocation.GPU)</span>
<span class="c1">#     #         for x in range(i, j):</span>
<span class="c1">#     #             current_slice = full_buffer.slice(l[x][1] - start_ptr, l[x][2])</span>
<span class="c1">#     #             self.wrapped_objs[l[x][3]] = (current_slice.device_ptr(), l[x][0], current_slice, l[x][3])</span>
<span class="c1">#     #             if l[x][0] == &#39;in&#39; or l[x][0] == &#39;inout&#39;:</span>
<span class="c1">#     #                 current_slice.load(l[x][3])  # update gpu resource with wrapped data</span>
<span class="c1">#     #         i = j</span>
<span class="c1">#     #     self.state = 1</span>
<span class="c1">#     #     self._wrapping_objs = None</span>
<span class="c1">#</span>
<span class="c1">#     def __del__(self):</span>
<span class="c1">#         self.release()</span>
<span class="c1">#</span>
<span class="c1">#     # def get_gpu_ptr(self, obj):</span>
<span class="c1">#     #     assert self.state != 2, &#39;Can not retrieve pointers from objects already unwrapped&#39;</span>
<span class="c1">#     #     if self.state == 0:</span>
<span class="c1">#     #         self._wrap_objs()</span>
<span class="c1">#     #     if obj is None:</span>
<span class="c1">#     #         return 0</span>
<span class="c1">#     #     assert obj in self.wrapped_objs, &#39;Some of the objects were not previously wrapped.&#39;</span>
<span class="c1">#     #     return self.wrapped_objs[obj][0]</span>
<span class="c1">#     #     # return _torch.tensor(ptrs.astype(_np.int64))  # using np to cast uint64 to int64, only int64 supported in _torch.</span>


<span class="c1"># class WrappedGPUPtr:</span>
<span class="c1">#     def __init__(self, device: &#39;DeviceManager&#39;, objs: Tuple[Union[_torch.Tensor, Buffer],...], mode: Literal[&#39;in&#39;, &#39;inout&#39;, &#39;out&#39;]=&#39;in&#39;):</span>
<span class="c1">#         self.device = device</span>
<span class="c1">#         self.objs = objs</span>
<span class="c1">#         self.mode = mode</span>
<span class="c1">#         self.ptrs = _np.zeros((len(objs), 1), dtype=_np.uint64)</span>
<span class="c1">#         self.owners = [None]*len(objs)</span>
<span class="c1">#</span>
<span class="c1">#     def _wrap(self, obj) -&gt; Tuple[int, Any]:</span>
<span class="c1">#         if obj is None:</span>
<span class="c1">#             return 0, None</span>
<span class="c1">#         if isinstance(obj, Buffer):</span>
<span class="c1">#             return obj.device_ptr(), obj</span>
<span class="c1">#         if isinstance(obj, ViewTensor):</span>
<span class="c1">#             if isinstance(obj.memory_owner, VulkanMemory):</span>
<span class="c1">#                 memory = obj.memory_owner</span>
<span class="c1">#                 return memory.cuda_to_device_ptr(obj.data_ptr()), obj</span>
<span class="c1">#         if isinstance(obj, _torch.Tensor):</span>
<span class="c1">#             if obj.is_cuda and os.name == &#39;nt&#39;:  # No need to vulkanize</span>
<span class="c1">#                 return obj.data_ptr(), obj</span>
<span class="c1">#             back_buffer = self.device.create_buffer_like(obj, memory=MemoryLocation.GPU)</span>
<span class="c1">#             if self.mode == &#39;inout&#39; or self.mode == &#39;in&#39;:</span>
<span class="c1">#                 self.device.copy(back_buffer, obj)</span>
<span class="c1">#             return back_buffer.device_ptr(), back_buffer</span>
<span class="c1">#         raise Exception(f&#39;Invalid object type {type(obj)} for wrap&#39;)</span>
<span class="c1">#</span>
<span class="c1">#     def _unwrap(self, obj, owner):</span>
<span class="c1">#         if obj is owner:</span>
<span class="c1">#             return</span>
<span class="c1">#         if self.mode == &#39;inout&#39; or self.mode == &#39;out&#39;:</span>
<span class="c1">#             owner.save(obj)</span>
<span class="c1">#</span>
<span class="c1">#     def __enter__(self):</span>
<span class="c1">#         for i, obj in enumerate(self.objs):</span>
<span class="c1">#             self.ptrs[i], self.owners[i] = self._wrap(obj)</span>
<span class="c1">#         return _torch.from_numpy(self.ptrs.astype(_np.int64))</span>
<span class="c1">#</span>
<span class="c1">#     def __exit__(self, exc_type, exc_val, exc_tb):</span>
<span class="c1">#         for i, obj in enumerate(self.objs):</span>
<span class="c1">#             self._unwrap(obj, self.owners[i])</span>
<span class="c1">#             self.ptrs[i] = 0</span>
<span class="c1">#             self.owners[i] = None</span>

<div class="viewcode-block" id="GPUPtr">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.GPUPtr">[docs]</a>
<span class="k">class</span> <span class="nc">GPUPtr</span><span class="p">:</span>

<div class="viewcode-block" id="GPUPtr.__init__">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.GPUPtr.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device_ptr</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">_typing</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span> <span class="n">is_direct</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device_ptr</span> <span class="o">=</span> <span class="n">device_ptr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_direct</span> <span class="o">=</span> <span class="n">is_direct</span></div>


<div class="viewcode-block" id="GPUPtr.flush">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.GPUPtr.flush">[docs]</a>
    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>


<div class="viewcode-block" id="GPUPtr.invalidate">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.GPUPtr.invalidate">[docs]</a>
    <span class="k">def</span> <span class="nf">invalidate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>


<div class="viewcode-block" id="GPUPtr.mark_as_dirty">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.GPUPtr.mark_as_dirty">[docs]</a>
    <span class="k">def</span> <span class="nf">mark_as_dirty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>


<div class="viewcode-block" id="GPUPtr.update_mode">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.GPUPtr.update_mode">[docs]</a>
    <span class="k">def</span> <span class="nf">update_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">additional_mode</span><span class="p">:</span> <span class="n">_typing</span><span class="o">.</span><span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="s1">&#39;out&#39;</span><span class="p">,</span> <span class="s1">&#39;inout&#39;</span><span class="p">]):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>
</div>



<span class="k">class</span> <span class="nc">DirectGPUPtr</span><span class="p">(</span><span class="n">GPUPtr</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device_ptr</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">_typing</span><span class="o">.</span><span class="n">Any</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DirectGPUPtr</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">device_ptr</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>

    <span class="n">__NULL__</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">null</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">DirectGPUPtr</span><span class="o">.</span><span class="n">__NULL__</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">DirectGPUPtr</span><span class="o">.</span><span class="n">__NULL__</span> <span class="o">=</span> <span class="n">DirectGPUPtr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">DirectGPUPtr</span><span class="o">.</span><span class="n">__NULL__</span>

    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">invalidate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">mark_as_dirty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">update_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">additional_mode</span><span class="p">:</span> <span class="n">_typing</span><span class="o">.</span><span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="s1">&#39;out&#39;</span><span class="p">,</span> <span class="s1">&#39;inout&#39;</span><span class="p">]):</span>
        <span class="k">pass</span>


<span class="k">class</span> <span class="nc">WrappedTensorPtr</span><span class="p">(</span><span class="n">GPUPtr</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">_typing</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="n">_torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">ViewTensor</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="n">_typing</span><span class="o">.</span><span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="s1">&#39;out&#39;</span><span class="p">,</span> <span class="s1">&#39;inout&#39;</span><span class="p">]):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">WrappedTensorPtr</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">memory_owner</span><span class="o">.</span><span class="n">device_ptr</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">is_direct</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cpu_tensor</span> <span class="o">=</span> <span class="n">t</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gpu_backend</span> <span class="o">=</span> <span class="n">v</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;in&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;inout&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gpu_version</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gpu_version</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">_version</span>
        <span class="c1"># self.mark_as_dirty()  # automatic assumed dirty after map since common use is to call invalidate after submit.</span>

    <span class="k">def</span> <span class="nf">update_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">additional_mode</span><span class="p">:</span> <span class="n">_typing</span><span class="o">.</span><span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="s1">&#39;out&#39;</span><span class="p">,</span> <span class="s1">&#39;inout&#39;</span><span class="p">]):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">additional_mode</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;inout&#39;</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">additional_mode</span> <span class="o">==</span> <span class="s1">&#39;in&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;inout&#39;</span>

    <span class="c1"># def __del__(self):</span>
    <span class="c1">#     if self.mode == &#39;out&#39; or self.mode == &#39;inout&#39;:</span>
    <span class="c1">#         self.mark_as_dirty()</span>
    <span class="c1">#         self.invalidate()</span>

    <span class="k">def</span> <span class="nf">mark_as_dirty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;out&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;inout&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gpu_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpu_tensor</span><span class="o">.</span><span class="n">_version</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;out&#39;</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gpu_version</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpu_tensor</span><span class="o">.</span><span class="n">_version</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gpu_backend</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cpu_tensor</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gpu_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpu_tensor</span><span class="o">.</span><span class="n">_version</span>
            <span class="c1"># print(f&quot;[UPDATED] shape {self.cpu_tensor.shape} to {self.gpu_version}&quot;)</span>

    <span class="k">def</span> <span class="nf">invalidate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;in&#39;</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gpu_version</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpu_tensor</span><span class="o">.</span><span class="n">_version</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cpu_tensor</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gpu_backend</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gpu_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpu_tensor</span><span class="o">.</span><span class="n">_version</span>


<span class="k">class</span> <span class="nc">_GPUWrappingManager</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="p">:</span> <span class="s1">&#39;DeviceManager&#39;</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">weakref</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hashed_wraps</span> <span class="p">:</span> <span class="n">_typing</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="n">_typing</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">weakref</span><span class="o">.</span><span class="n">WeakSet</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10013</span>

    <span class="k">def</span> <span class="nf">wrap_gpu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="n">_typing</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="n">_typing</span><span class="o">.</span><span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="s1">&#39;out&#39;</span><span class="p">,</span> <span class="s1">&#39;inout&#39;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">GPUPtr</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">os</span>
        <span class="kn">import</span> <span class="nn">weakref</span>
        <span class="kn">import</span> <span class="nn">torch.cuda</span>
        <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">DirectGPUPtr</span><span class="o">.</span><span class="n">null</span><span class="p">()</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">t</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="s1">&#39;__bindable__&#39;</span><span class="p">):</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">__bindable__</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">Buffer</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">DirectGPUPtr</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">device_ptr</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">ViewTensor</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">memory_owner</span><span class="p">,</span> <span class="n">VulkanMemory</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">DirectGPUPtr</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">memory_owner</span><span class="o">.</span><span class="n">cuda_to_device_ptr</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">data_ptr</span><span class="p">()),</span> <span class="n">obj</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">_torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;Type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="si">}</span><span class="s1"> can not be wrapped on the GPU&#39;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;nt&#39;</span> <span class="ow">and</span> <span class="n">_torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="ow">and</span> <span class="n">t</span><span class="o">.</span><span class="n">is_contiguous</span><span class="p">()</span> <span class="ow">and</span> <span class="n">t</span><span class="o">.</span><span class="n">is_cuda</span><span class="p">:</span>
           <span class="k">return</span> <span class="n">DirectGPUPtr</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">data_ptr</span><span class="p">(),</span> <span class="n">t</span><span class="p">)</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">data_ptr</span><span class="p">()</span> <span class="o">^</span> <span class="n">t</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="c1">#id(t)</span>
        <span class="n">entry</span> <span class="o">=</span> <span class="n">code</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hashed_wraps</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hashed_wraps</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hashed_wraps</span><span class="p">[</span><span class="n">entry</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">w</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">data_ptr</span><span class="p">()</span> <span class="o">==</span> <span class="n">t</span><span class="o">.</span><span class="n">data_ptr</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">__TRACE_WRAP__</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[WARNING] Collision </span><span class="si">{</span><span class="n">t</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> with mode </span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2"> from mode </span><span class="si">{</span><span class="n">w</span><span class="o">.</span><span class="n">mode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">w</span><span class="o">.</span><span class="n">update_mode</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
                    <span class="c1"># w.flush()</span>
                    <span class="k">return</span> <span class="n">w</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hashed_wraps</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hashed_wraps</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakSet</span><span class="p">()</span>
        <span class="kn">import</span> <span class="nn">gc</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">()</span><span class="o">.</span><span class="n">create_tensor</span><span class="p">(</span><span class="o">*</span><span class="n">t</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">WrappedTensorPtr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">__TRACE_WRAP__</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[WARNING] wrapped tensor of </span><span class="si">{</span><span class="n">t</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> elements&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hashed_wraps</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">w</span>


<span class="c1"># class GPUWrap:</span>
<span class="c1">#     @staticmethod</span>
<span class="c1">#     def _wrap_obj(obj: Any) -&gt; (int, Union[Buffer, ViewTensor]):</span>
<span class="c1">#         if isinstance(obj, Buffer):</span>
<span class="c1">#             return obj.device_ptr, None</span>
<span class="c1">#         if isinstance(obj, ViewTensor):</span>
<span class="c1">#             return obj.memory_owner.device_ptr, None</span>
<span class="c1">#         if isinstance(obj, _torch.Tensor):</span>
<span class="c1">#             b = buffer_like(obj, MemoryLocation.GPU)</span>
<span class="c1">#             return b.device_ptr, b</span>
<span class="c1">#         raise Exception(f&#39;Not supported wrapping {type(obj)}&#39;)</span>
<span class="c1">#</span>
<span class="c1">#     def __init__(self, obj: Any):</span>
<span class="c1">#         self.obj = obj</span>
<span class="c1">#         self.ptr, self._backing = GPUWrap._wrap_obj(obj)</span>
<span class="c1">#</span>
<span class="c1">#     def push(self):</span>
<span class="c1">#         if self._backing is None:</span>
<span class="c1">#             return</span>
<span class="c1">#         self._backing.load(self.obj)</span>
<span class="c1">#</span>
<span class="c1">#     def pull(self):</span>
<span class="c1">#         if self._backing is None:</span>
<span class="c1">#             return</span>
<span class="c1">#         self._backing.save(self.obj)</span>


<div class="viewcode-block" id="Window">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.Window">[docs]</a>
<span class="k">class</span> <span class="nc">Window</span><span class="p">:</span>

<div class="viewcode-block" id="Window.__init__">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.Window.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="p">:</span> <span class="s1">&#39;DeviceManager&#39;</span><span class="p">,</span> <span class="n">w_window</span><span class="p">:</span> <span class="n">_internal</span><span class="o">.</span><span class="n">WindowWrapper</span><span class="p">,</span> <span class="nb">format</span><span class="p">:</span> <span class="n">Format</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_window</span> <span class="o">=</span> <span class="n">w_window</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stats_fps</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stats_spf</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_time_enter</span>  <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rt_present</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">w_window</span><span class="o">.</span><span class="n">render_target</span><span class="p">,</span> <span class="n">Layout</span><span class="o">.</span><span class="n">from_format</span><span class="p">(</span><span class="n">Format</span><span class="o">.</span><span class="n">PRESENTER</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_image</span> <span class="o">=</span> <span class="n">device</span><span class="o">.</span><span class="n">create_image</span><span class="p">(</span><span class="n">image_type</span><span class="o">=</span><span class="n">ImageType</span><span class="o">.</span><span class="n">TEXTURE_2D</span><span class="p">,</span> <span class="n">is_cube</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">image_format</span><span class="o">=</span><span class="nb">format</span><span class="p">,</span>
                            <span class="n">width</span><span class="o">=</span><span class="n">w_window</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">w_window</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">mips</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">layers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                            <span class="n">usage</span><span class="o">=</span><span class="n">ImageUsage</span><span class="o">.</span><span class="n">TRANSFER</span><span class="p">,</span> <span class="n">memory</span><span class="o">=</span><span class="n">MemoryLocation</span><span class="o">.</span><span class="n">GPU</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span> <span class="o">=</span> <span class="n">device</span><span class="o">.</span><span class="n">create_buffer</span><span class="p">(</span><span class="n">w_window</span><span class="o">.</span><span class="n">width</span> <span class="o">*</span> <span class="n">w_window</span><span class="o">.</span><span class="n">height</span> <span class="o">*</span> <span class="n">Layout</span><span class="o">.</span><span class="n">from_format</span><span class="p">(</span><span class="nb">format</span><span class="p">)</span><span class="o">.</span><span class="n">aligned_size</span><span class="p">,</span>
                                            <span class="n">BufferUsage</span><span class="o">.</span><span class="n">STORAGE</span><span class="p">,</span> <span class="n">MemoryLocation</span><span class="o">.</span><span class="n">GPU</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_staging</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">w_resource</span><span class="o">.</span><span class="n">support_direct_tensor_map</span> <span class="k">else</span> \
                            <span class="n">device</span><span class="o">.</span><span class="n">create_buffer</span><span class="p">(</span><span class="n">w_window</span><span class="o">.</span><span class="n">width</span> <span class="o">*</span> <span class="n">w_window</span><span class="o">.</span><span class="n">height</span> <span class="o">*</span> <span class="n">Layout</span><span class="o">.</span><span class="n">from_format</span><span class="p">(</span><span class="nb">format</span><span class="p">)</span><span class="o">.</span><span class="n">aligned_size</span><span class="p">,</span>
                                            <span class="n">BufferUsage</span><span class="o">.</span><span class="n">STAGING</span><span class="p">,</span> <span class="n">MemoryLocation</span><span class="o">.</span><span class="n">CPU</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tensor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_staging</span><span class="o">.</span><span class="n">w_resource</span><span class="o">.</span><span class="n">as_tensor</span><span class="p">(</span><span class="n">_torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">w_window</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="n">w_window</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># create managers for Tensor-&gt;Present, Buffer-&gt;Present, Image-&gt;Present</span>

        <span class="c1"># image -&gt; present</span>
        <span class="n">man</span> <span class="o">=</span> <span class="n">device</span><span class="o">.</span><span class="n">get_graphics</span><span class="p">()</span>
        <span class="n">man</span><span class="o">.</span><span class="n">blit_image</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rt_present</span><span class="p">)</span>
        <span class="n">man</span><span class="o">.</span><span class="n">freeze</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_present_image_man</span> <span class="o">=</span> <span class="n">man</span>

        <span class="n">man</span> <span class="o">=</span> <span class="n">device</span><span class="o">.</span><span class="n">get_graphics</span><span class="p">()</span>
        <span class="n">man</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">)</span>
        <span class="n">man</span><span class="o">.</span><span class="n">blit_image</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rt_present</span><span class="p">)</span>
        <span class="n">man</span><span class="o">.</span><span class="n">freeze</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_present_buffer_man</span> <span class="o">=</span> <span class="n">man</span>

        <span class="n">man</span> <span class="o">=</span> <span class="n">device</span><span class="o">.</span><span class="n">get_graphics</span><span class="p">()</span>
        <span class="n">man</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_staging</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">)</span>
        <span class="n">man</span><span class="o">.</span><span class="n">blit_image</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rt_present</span><span class="p">)</span>
        <span class="n">man</span><span class="o">.</span><span class="n">freeze</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_present_tensor_man</span> <span class="o">=</span> <span class="n">man</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">backbuffer_images</span> <span class="o">=</span> <span class="p">{</span> <span class="p">}</span>  <span class="c1"># map from name to (vulkan backbuffer image, same but as opengl image) used to draw tensors and textures in imgui through an opengl texture</span></div>


<div class="viewcode-block" id="Window.ClientContext">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.Window.ClientContext">[docs]</a>
    <span class="k">class</span> <span class="nc">ClientContext</span><span class="p">:</span>
<div class="viewcode-block" id="Window.ClientContext.__init__">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.Window.ClientContext.__init__">[docs]</a>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">window</span><span class="p">:</span> <span class="s1">&#39;Window&#39;</span><span class="p">,</span> <span class="nb">map</span><span class="p">:</span> <span class="n">_typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="n">Image</span><span class="p">,</span> <span class="n">Buffer</span><span class="p">,</span> <span class="n">_torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="n">man</span><span class="p">:</span> <span class="n">_typing</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">GraphicsManager</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">window</span> <span class="o">=</span> <span class="n">window</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">w_window</span> <span class="o">=</span> <span class="n">window</span><span class="o">.</span><span class="n">w_window</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">map</span> <span class="o">=</span> <span class="nb">map</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">man</span> <span class="o">=</span> <span class="n">man</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_timer</span> <span class="o">=</span> <span class="mi">0</span></div>


        <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="kn">import</span> <span class="nn">time</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">w_window</span><span class="o">.</span><span class="n">_begin_frame</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_timer</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span>

        <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
            <span class="kn">import</span> <span class="nn">time</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timer</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">man</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">submit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">man</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">w_window</span><span class="o">.</span><span class="n">_end_frame</span><span class="p">()</span>
            <span class="n">fps</span> <span class="o">=</span> <span class="mi">1000</span> <span class="k">if</span> <span class="n">d</span> <span class="o">&lt;=</span> <span class="mf">0.001</span> <span class="k">else</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">d</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="o">.</span><span class="n">_stats_fps</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="o">.</span><span class="n">_stats_fps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="o">.</span><span class="n">_stats_fps</span> <span class="o">*</span> <span class="mf">0.9</span> <span class="o">+</span> <span class="n">fps</span> <span class="o">*</span> <span class="mf">0.1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="o">.</span><span class="n">_stats_spf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="o">.</span><span class="n">_stats_spf</span> <span class="o">*</span> <span class="mf">0.9</span> <span class="o">+</span> <span class="n">d</span> <span class="o">*</span> <span class="mf">0.1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="o">.</span><span class="n">_stats_fps</span> <span class="o">=</span> <span class="n">fps</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="o">.</span><span class="n">_stats_spf</span> <span class="o">=</span> <span class="n">d</span></div>



<div class="viewcode-block" id="Window.render_target">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.Window.render_target">[docs]</a>
    <span class="k">def</span> <span class="nf">render_target</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Window</span><span class="o">.</span><span class="n">ClientContext</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="nb">map</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_rt_present</span><span class="p">,</span> <span class="n">man</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></div>


<div class="viewcode-block" id="Window.image">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.Window.image">[docs]</a>
    <span class="k">def</span> <span class="nf">image</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Window</span><span class="o">.</span><span class="n">ClientContext</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="nb">map</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">,</span> <span class="n">man</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_present_image_man</span><span class="p">)</span></div>


<div class="viewcode-block" id="Window.buffer">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.Window.buffer">[docs]</a>
    <span class="k">def</span> <span class="nf">buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Window</span><span class="o">.</span><span class="n">ClientContext</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="nb">map</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="p">,</span> <span class="n">man</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_present_buffer_man</span><span class="p">)</span></div>


<div class="viewcode-block" id="Window.tensor">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.Window.tensor">[docs]</a>
    <span class="k">def</span> <span class="nf">tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Window</span><span class="o">.</span><span class="n">ClientContext</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="nb">map</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_tensor</span><span class="p">,</span> <span class="n">man</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_present_tensor_man</span><span class="p">)</span></div>


<div class="viewcode-block" id="Window.show_tensor">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.Window.show_tensor">[docs]</a>
    <span class="k">def</span> <span class="nf">show_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="n">_torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">width</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">height</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">cmap</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;viridis&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">backbuffer_images</span><span class="p">:</span>
            <span class="n">backbuffer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">create_image</span><span class="p">(</span><span class="n">image_type</span><span class="o">=</span><span class="n">ImageType</span><span class="o">.</span><span class="n">TEXTURE_2D</span><span class="p">,</span> <span class="n">is_cube</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">image_format</span><span class="o">=</span><span class="n">Format</span><span class="o">.</span><span class="n">VEC4</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">height</span><span class="p">,</span>
                                     <span class="n">depth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">mips</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">layers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">usage</span><span class="o">=</span><span class="n">ImageUsage</span><span class="o">.</span><span class="n">STORAGE</span><span class="p">)</span>
            <span class="n">opengl_backbuffer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">w_device</span><span class="o">.</span><span class="n">create_opengl_texture_from_vk</span><span class="p">(</span><span class="n">backbuffer</span><span class="o">.</span><span class="n">w_resource</span><span class="o">.</span><span class="n">resource_data</span><span class="p">)</span>
            <span class="n">tensor_data_uniform</span> <span class="o">=</span> <span class="n">object_buffer</span><span class="p">(</span><span class="n">Layout</span><span class="o">.</span><span class="n">from_structure</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;std430&#39;</span><span class="p">,</span>
                                                                      <span class="n">tensor_data</span><span class="o">=</span><span class="n">_torch</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span>
                                                                      <span class="n">width</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                                                                      <span class="n">height</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                                                                      <span class="n">components</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                                                                      <span class="nb">type</span><span class="o">=</span><span class="nb">int</span>
                                                                      <span class="p">))</span>
            <span class="n">color_map_data</span> <span class="o">=</span> <span class="n">object_buffer</span><span class="p">(</span><span class="n">Layout</span><span class="o">.</span><span class="n">from_structure</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;std430&#39;</span><span class="p">,</span>
                                                                 <span class="n">map_colors</span><span class="o">=</span><span class="p">[</span><span class="mi">17</span><span class="p">,</span> <span class="n">vec4</span><span class="p">]</span>
                                                                 <span class="p">))</span>

            <span class="n">pipeline</span> <span class="o">=</span> <span class="n">pipeline_compute</span><span class="p">()</span>
            <span class="n">pipeline</span><span class="o">.</span><span class="n">load_shader_from_source</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">#version 460</span>
<span class="s2">#extension GL_EXT_scalar_block_layout : require</span>
<span class="s2">#extension GL_EXT_buffer_reference2: require</span>
<span class="s2">#extension GL_ARB_gpu_shader_int64 : require</span>
<span class="s2">#extension GL_EXT_control_flow_attributes : require</span>

<span class="s2">layout (local_size_x = 32, local_size_y = 32, local_size_z = 1) in;</span>

<span class="s2">layout(set=0, binding=0, rgba8) uniform image2D _out;</span>
<span class="s2">layout(set=0, binding=1, std430) uniform TensorData{</span>
<span class="s2">    uint64_t tensor_data;</span>
<span class="s2">    int width;</span>
<span class="s2">    int height;</span>
<span class="s2">    int components; // 1 - 4  (if 1 then map is applied)</span>
<span class="s2">    int type; // 0 - int, 1 - float  (if int it is assumed to be 0..255)</span>
<span class="s2">};</span>

<span class="s2">layout(set=0, binding=2, std430) uniform ColorMapData{</span>
<span class="s2">    vec4 map_colors[17];</span>
<span class="s2">};</span>

<span class="s2">layout(buffer_reference, scalar, buffer_reference_align=4) buffer int_ptr { int data[]; };</span>
<span class="s2">layout(buffer_reference, scalar, buffer_reference_align=4) buffer float_ptr { float data[]; };</span>

<span class="s2">vec4 compute_color(vec2 c)</span>
<span class="s2">{</span>
<span class="s2">    int px = clamp(int(c.x * width), 0, width - 1);</span>
<span class="s2">    int py = clamp(int((1 - c.y) * height), 0, height - 1);</span>
<span class="s2">    int pixel_offset = py * width + px;</span>
<span class="s2">    int byte_offset = pixel_offset * components * 4;</span>
<span class="s2">    vec4 color = vec4(1.0);</span>
<span class="s2">    if (type == 0) // int</span>
<span class="s2">    {</span>
<span class="s2">        int_ptr pixel_buffer = int_ptr(tensor_data + byte_offset);</span>
<span class="s2">        [[unroll]]</span>
<span class="s2">        for (int i=0; i&lt;components; i++)</span>
<span class="s2">            color[i] = pixel_buffer.data[i] / 255.0;</span>
<span class="s2">    }</span>
<span class="s2">    else {</span>
<span class="s2">        float_ptr pixel_buffer = float_ptr(tensor_data + byte_offset);</span>
<span class="s2">        [[unroll]]</span>
<span class="s2">        for (int i=0; i&lt;components; i++)</span>
<span class="s2">            color[i] = pixel_buffer.data[i];</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    if (components == 1) // use color maps</span>
<span class="s2">    {</span>
<span class="s2">        float alpha = color.x * 16;</span>
<span class="s2">        int cm_index = clamp(int(alpha), 0, 15);</span>
<span class="s2">        alpha = fract(alpha);</span>
<span class="s2">        color = mix (map_colors[cm_index], map_colors[cm_index + 1], alpha);</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    return color;</span>
<span class="s2">}</span>

<span class="s2">void main() {</span>
<span class="s2">    ivec2 index = ivec2(gl_GlobalInvocationID.xy);</span>
<span class="s2">    ivec2 dim = imageSize(_out);</span>
<span class="s2">    if (any(greaterThanEqual(index, dim)))</span>
<span class="s2">    return;</span>

<span class="s2">    vec2 C = (index + vec2(0.5))/dim;</span>

<span class="s2">    imageStore(_out, index, compute_color(C));</span>
<span class="s2">}</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">)</span>
            <span class="n">pipeline</span><span class="o">.</span><span class="n">bind_storage_image</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">backbuffer</span><span class="p">)</span>
            <span class="n">pipeline</span><span class="o">.</span><span class="n">bind_uniform</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">tensor_data_uniform</span><span class="p">)</span>
            <span class="n">pipeline</span><span class="o">.</span><span class="n">bind_uniform</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">color_map_data</span><span class="p">)</span>
            <span class="n">pipeline</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">man</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_compute</span><span class="p">()</span>
            <span class="n">man</span><span class="o">.</span><span class="n">set_pipeline</span><span class="p">(</span><span class="n">pipeline</span><span class="p">)</span>
            <span class="n">man</span><span class="o">.</span><span class="n">dispatch_threads_2D</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
            <span class="n">man</span><span class="o">.</span><span class="n">freeze</span><span class="p">()</span>
            <span class="n">last_used_cmap</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">backbuffer_images</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">man</span><span class="o">=</span><span class="n">man</span><span class="p">,</span>
                <span class="n">tensor_data_uniform</span><span class="o">=</span><span class="n">tensor_data_uniform</span><span class="p">,</span>
                <span class="n">color_map_data</span><span class="o">=</span><span class="n">color_map_data</span><span class="p">,</span>
                <span class="n">opengl_backbuffer</span><span class="o">=</span><span class="n">opengl_backbuffer</span><span class="p">,</span>
                <span class="n">last_used_cmap</span><span class="o">=</span><span class="n">last_used_cmap</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cached_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backbuffer_images</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="n">man</span> <span class="o">=</span> <span class="n">cached_data</span><span class="p">[</span><span class="s1">&#39;man&#39;</span><span class="p">]</span>
            <span class="n">tensor_data_uniform</span> <span class="o">=</span> <span class="n">cached_data</span><span class="p">[</span><span class="s1">&#39;tensor_data_uniform&#39;</span><span class="p">]</span>
            <span class="n">color_map_data</span> <span class="o">=</span> <span class="n">cached_data</span><span class="p">[</span><span class="s1">&#39;color_map_data&#39;</span><span class="p">]</span>
            <span class="n">opengl_backbuffer</span> <span class="o">=</span> <span class="n">cached_data</span><span class="p">[</span><span class="s1">&#39;opengl_backbuffer&#39;</span><span class="p">]</span>
            <span class="n">last_used_cmap</span> <span class="o">=</span> <span class="n">cached_data</span><span class="p">[</span><span class="s1">&#39;last_used_cmap&#39;</span><span class="p">]</span>
        <span class="c1"># update uniforms</span>
        <span class="k">with</span> <span class="n">tensor_data_uniform</span> <span class="k">as</span> <span class="n">b</span><span class="p">:</span>
            <span class="n">b</span><span class="o">.</span><span class="n">tensor_data</span> <span class="o">=</span> <span class="n">wrap_gpu</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="n">b</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">b</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">b</span><span class="o">.</span><span class="n">components</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">b</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">_torch</span><span class="o">.</span><span class="n">int32</span> <span class="k">else</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">last_used_cmap</span> <span class="o">!=</span> <span class="n">cmap</span><span class="p">:</span>  <span class="c1"># update colormap</span>
            <span class="kn">import</span> <span class="nn">matplotlib</span>
            <span class="n">cmap</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">cmap</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">color_map_data</span> <span class="k">as</span> <span class="n">c</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">17</span><span class="p">):</span>
                    <span class="n">alpha</span> <span class="o">=</span> <span class="n">i</span> <span class="o">/</span> <span class="mf">16.0</span>
                    <span class="n">color_tuple</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">map_colors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">vec4</span><span class="p">(</span><span class="o">*</span><span class="n">color_tuple</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">backbuffer_images</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;last_used_cmap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmap</span>

        <span class="n">submit</span><span class="p">(</span><span class="n">man</span><span class="p">)</span>  <span class="c1"># draw tensor into backbuffer</span>

        <span class="k">if</span> <span class="n">__GUI_AVAILABLE__</span><span class="p">:</span>
            <span class="n">imgui</span><span class="o">.</span><span class="n">image</span><span class="p">(</span><span class="n">opengl_backbuffer</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span></div>








    <span class="c1"># def __enter__(self):</span>
    <span class="c1">#     self._last_time_enter = time.perf_counter()</span>
    <span class="c1">#     w_resource = self.w_window._begin_frame()</span>
    <span class="c1">#     return Image(self.device, w_resource, self.texel_layout)</span>
    <span class="c1">#</span>
    <span class="c1"># def __exit__(self, exc_type, exc_val, exc_tb):</span>
    <span class="c1">#     if rt is not rt_present:</span>
    <span class="c1">#         ResourceData.blit(_self, rt.resource_data, rt.current_slice, rt_present.resource_data,</span>
    <span class="c1">#                           rt_present.current_slice)</span>
    <span class="c1">#     self.w_window._end_frame()</span>
    <span class="c1">#     d = time.perf_counter() - self._last_time_enter</span>
    <span class="c1">#     fps = 1000 if d &lt;= 0.001 else 1/d</span>
    <span class="c1">#     if self._stats_fps &gt; 0:</span>
    <span class="c1">#         self._stats_fps = self._stats_fps * 0.9 + fps * 0.1</span>
    <span class="c1">#     else:</span>
    <span class="c1">#         self._stats_fps = fps</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">fps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stats_fps</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">spf</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stats_spf</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_closed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_window</span><span class="o">.</span><span class="n">is_closed</span><span class="p">()</span>

<div class="viewcode-block" id="Window.label_text">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.Window.label_text">[docs]</a>
    <span class="k">def</span> <span class="nf">label_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">__GUI_AVAILABLE__</span><span class="p">,</span> <span class="s1">&#39;No GUI available. consider install imgui&#39;</span>
        <span class="k">return</span> <span class="n">imgui</span><span class="o">.</span><span class="n">label_text</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">__GUI_AVAILABLE__</span><span class="p">,</span> <span class="s1">&#39;No GUI available. consider install imgui&#39;</span>
        <span class="k">return</span> <span class="n">imgui</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">item</span><span class="p">]</span></div>



<span class="k">def</span> <span class="nf">_thread_safe_call</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">eval</span><span class="p">():</span>
            <span class="n">f</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">safe_dispatch_function</span><span class="p">(</span><span class="nb">eval</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wrapper</span>


<span class="k">class</span> <span class="nc">DeviceManager</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">threading</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_state</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__copying_on_the_gpu</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__queue</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__loop_process</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__allow_cross_thread_without_looping</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__caps</span> <span class="o">=</span> <span class="n">Caps</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__wrapping</span> <span class="o">=</span> <span class="n">_GPUWrappingManager</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">wrap_gpu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">_typing</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="n">_typing</span><span class="o">.</span><span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="s1">&#39;out&#39;</span><span class="p">,</span> <span class="s1">&#39;inout&#39;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">GPUPtr</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__wrapping</span><span class="o">.</span><span class="n">wrap_gpu</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">allow_cross_threading</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__allow_cross_thread_without_looping</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;[WARNING] Allow access from other threads is dangerous. Think in wrapping the concurrent process in a loop&quot;</span><span class="p">)</span>

    <span class="n">__event__</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
    <span class="n">__locker__</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">safe_dispatch_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">threading</span>
        <span class="k">if</span> <span class="n">threading</span><span class="o">.</span><span class="n">current_thread</span><span class="p">()</span> <span class="o">==</span> <span class="n">threading</span><span class="o">.</span><span class="n">main_thread</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">__allow_cross_thread_without_looping</span><span class="p">:</span>
            <span class="n">function</span><span class="p">()</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__queue</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Can not dispatch cross-thread function without looping&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">__locker__</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__queue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">function</span><span class="p">)</span>
        <span class="n">DeviceManager</span><span class="o">.</span><span class="n">__event__</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="c1"># print(len(self.__queue))</span>

    <span class="k">def</span> <span class="nf">execute_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">main_process</span><span class="p">:</span> <span class="n">_typing</span><span class="o">.</span><span class="n">Callable</span><span class="p">[[</span><span class="n">_typing</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">_typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]],</span> <span class="nb">bool</span><span class="p">],</span> <span class="o">*</span><span class="n">process</span><span class="p">:</span> <span class="n">_typing</span><span class="o">.</span><span class="n">Callable</span><span class="p">[[</span><span class="n">_typing</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">_typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]],</span> <span class="kc">None</span><span class="p">],</span> <span class="n">context</span><span class="p">:</span> <span class="n">_typing</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">_typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">threading</span>
        <span class="k">assert</span> <span class="n">threading</span><span class="o">.</span><span class="n">current_thread</span><span class="p">()</span> <span class="o">==</span> <span class="n">threading</span><span class="o">.</span><span class="n">main_thread</span><span class="p">(),</span> <span class="s2">&quot;execution of main process can only be triggered from main thread!&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__loop_process</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__loop_process</span><span class="p">:</span>
                <span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>  <span class="c1"># wait for an unfinished loop first</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__queue</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># start dispatch queue</span>
        <span class="n">context_args</span> <span class="o">=</span> <span class="p">()</span> <span class="k">if</span> <span class="n">context</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">(</span><span class="n">context</span><span class="p">,)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__loop_process</span> <span class="o">=</span> <span class="p">[</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">p</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">context_args</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">process</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__loop_process</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">main_alive</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">while</span> <span class="n">main_alive</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">is_alive</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__loop_process</span><span class="p">):</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">__locker__</span><span class="p">:</span>
                <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__queue</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># consume all pending dispatched include</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__queue</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">f</span><span class="p">()</span>
            <span class="n">DeviceManager</span><span class="o">.</span><span class="n">__event__</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
            <span class="n">DeviceManager</span><span class="o">.</span><span class="n">__event__</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="n">main_alive</span> <span class="o">=</span> <span class="n">main_process</span><span class="p">(</span><span class="o">*</span><span class="n">context_args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__queue</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">release</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__copying_on_the_gpu</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_device</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">w_device</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_device</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">support</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Caps</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__caps</span>

    <span class="k">def</span> <span class="nf">__bind__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w_device</span><span class="p">:</span> <span class="n">_internal</span><span class="o">.</span><span class="n">DeviceWrapper</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_device</span> <span class="o">=</span> <span class="n">w_device</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__caps</span><span class="o">.</span><span class="n">cooperative_matrices</span> <span class="o">=</span> <span class="n">w_device</span><span class="o">.</span><span class="n">support_cooperative_matrices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__caps</span><span class="o">.</span><span class="n">ray_tracing</span> <span class="o">=</span> <span class="n">w_device</span><span class="o">.</span><span class="n">support_raytracing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__caps</span><span class="o">.</span><span class="n">zero_copy_buffer_map</span> <span class="o">=</span> <span class="n">w_device</span><span class="o">.</span><span class="n">support_buffer_map</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__caps</span><span class="o">.</span><span class="n">zero_copy_torch_map</span> <span class="o">=</span> <span class="n">w_device</span><span class="o">.</span><span class="n">support_torch_map</span>

    <span class="k">def</span> <span class="nf">load_technique</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">technique</span><span class="p">):</span>
        <span class="n">technique</span><span class="o">.</span><span class="n">__bind__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w_device</span><span class="p">)</span>
        <span class="n">technique</span><span class="o">.</span><span class="n">__setup__</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">technique</span>

    <span class="k">def</span> <span class="nf">dispatch_technique</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">technique</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">technique</span><span class="o">.</span><span class="n">w_device</span><span class="p">,</span> <span class="s2">&quot;Technique is not bound to a device, you must load the technique in some point before dispatching&quot;</span>
        <span class="n">technique</span><span class="o">.</span><span class="n">__dispatch__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">set_debug_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_device</span><span class="o">.</span><span class="n">set_debug_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">torch_ptr_to_device_ptr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="n">_torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_device</span><span class="o">.</span><span class="n">torch_ptr_to_device_ptr</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">shape</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">_torch</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">memory</span><span class="p">:</span> <span class="n">MemoryLocation</span> <span class="o">=</span> <span class="n">MemoryLocation</span><span class="o">.</span><span class="n">GPU</span><span class="p">):</span>
        <span class="c1"># return _torch.zeros(*shape, dtype=dtype, device=&#39;cpu&#39; if memory == MemoryLocation.CPU else &#39;cuda&#39;)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_device</span><span class="o">.</span><span class="n">create_tensor</span><span class="p">(</span><span class="o">*</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">memory</span><span class="o">=</span><span class="n">memory</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_tensor_like</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="n">_torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">memory</span> <span class="o">=</span> <span class="n">MemoryLocation</span><span class="o">.</span><span class="n">CPU</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;cpu&#39;</span> <span class="k">else</span> <span class="n">MemoryLocation</span><span class="o">.</span><span class="n">GPU</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_tensor</span><span class="p">(</span><span class="o">*</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">memory</span><span class="o">=</span><span class="n">memory</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_buffer_like</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="n">_typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="n">_torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Resource</span><span class="p">],</span> <span class="n">memory</span><span class="p">:</span> <span class="n">MemoryLocation</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">math</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">_torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_buffer</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">t</span><span class="o">.</span><span class="n">element_size</span><span class="p">(),</span> <span class="n">usage</span><span class="o">=</span><span class="n">BufferUsage</span><span class="o">.</span><span class="n">STAGING</span><span class="p">,</span> <span class="n">memory</span><span class="o">=</span><span class="n">memory</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_buffer</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">w_resource</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">usage</span><span class="o">=</span><span class="n">BufferUsage</span><span class="o">.</span><span class="n">STAGING</span><span class="p">,</span> <span class="n">memory</span><span class="o">=</span><span class="n">memory</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">usage</span><span class="p">:</span> <span class="n">BufferUsage</span> <span class="o">=</span> <span class="n">BufferUsage</span><span class="o">.</span><span class="n">STORAGE</span><span class="p">,</span> <span class="n">memory</span><span class="p">:</span> <span class="n">MemoryLocation</span> <span class="o">=</span> <span class="n">MemoryLocation</span><span class="o">.</span><span class="n">GPU</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Buffer</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_device</span><span class="o">.</span><span class="n">create_buffer</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">usage</span><span class="p">,</span> <span class="n">memory</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">create_structured_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">count</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">element_description</span><span class="p">:</span> <span class="n">_typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">type</span><span class="p">,</span> <span class="n">_torch</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">Layout</span><span class="p">,</span> <span class="n">_typing</span><span class="o">.</span><span class="n">List</span><span class="p">,</span> <span class="n">_typing</span><span class="o">.</span><span class="n">Dict</span><span class="p">],</span>
                      <span class="n">usage</span><span class="p">:</span> <span class="n">BufferUsage</span> <span class="o">=</span> <span class="n">BufferUsage</span><span class="o">.</span><span class="n">STORAGE</span><span class="p">,</span> <span class="n">memory</span><span class="p">:</span> <span class="n">MemoryLocation</span> <span class="o">=</span> <span class="n">MemoryLocation</span><span class="o">.</span><span class="n">GPU</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StructuredBuffer</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element_description</span><span class="p">,</span> <span class="n">Layout</span><span class="p">):</span>
            <span class="n">element_description</span> <span class="o">=</span> <span class="n">Layout</span><span class="o">.</span><span class="n">from_description</span><span class="p">(</span><span class="n">LayoutAlignment</span><span class="o">.</span><span class="n">SCALAR</span><span class="p">,</span> <span class="n">element_description</span><span class="p">)</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">element_description</span><span class="o">.</span><span class="n">aligned_size</span> <span class="o">*</span> <span class="n">count</span>
        <span class="k">return</span> <span class="n">StructuredBuffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_device</span><span class="o">.</span><span class="n">create_buffer</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">usage</span><span class="p">,</span> <span class="n">memory</span><span class="p">),</span> <span class="n">element_description</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_object_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element_description</span><span class="p">:</span> <span class="n">_typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">type</span><span class="p">,</span> <span class="n">_torch</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">Layout</span><span class="p">,</span> <span class="n">_typing</span><span class="o">.</span><span class="n">List</span><span class="p">,</span> <span class="n">_typing</span><span class="o">.</span><span class="n">Dict</span><span class="p">],</span>
                             <span class="n">usage</span><span class="p">:</span> <span class="n">BufferUsage</span> <span class="o">=</span> <span class="n">BufferUsage</span><span class="o">.</span><span class="n">STORAGE</span><span class="p">,</span> <span class="n">memory</span><span class="p">:</span> <span class="n">MemoryLocation</span> <span class="o">=</span> <span class="n">MemoryLocation</span><span class="o">.</span><span class="n">GPU</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element_description</span><span class="p">,</span> <span class="n">Layout</span><span class="p">):</span>
            <span class="n">element_description</span> <span class="o">=</span> <span class="n">Layout</span><span class="o">.</span><span class="n">from_description</span><span class="p">(</span><span class="n">element_description</span><span class="p">)</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">element_description</span><span class="o">.</span><span class="n">aligned_size</span>
        <span class="k">return</span> <span class="n">ObjectBuffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_device</span><span class="o">.</span><span class="n">create_buffer</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">usage</span><span class="p">,</span> <span class="n">memory</span><span class="p">),</span> <span class="n">element_description</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_type</span><span class="p">:</span> <span class="n">ImageType</span><span class="p">,</span> <span class="n">is_cube</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">image_format</span><span class="p">:</span> <span class="n">Format</span><span class="p">,</span>
                     <span class="n">width</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">height</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">depth</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                     <span class="n">mips</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">layers</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                     <span class="n">usage</span><span class="p">:</span> <span class="n">ImageUsage</span> <span class="o">=</span> <span class="n">ImageUsage</span><span class="o">.</span><span class="n">SAMPLED</span><span class="p">,</span> <span class="n">memory</span><span class="p">:</span> <span class="n">MemoryLocation</span> <span class="o">=</span> <span class="n">MemoryLocation</span><span class="o">.</span><span class="n">GPU</span><span class="p">):</span>
        <span class="n">texel_layout</span> <span class="o">=</span> <span class="n">Layout</span><span class="o">.</span><span class="n">from_format</span><span class="p">(</span><span class="n">image_format</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_device</span><span class="o">.</span><span class="n">create_image</span><span class="p">(</span>
            <span class="n">image_type</span><span class="p">,</span> <span class="n">image_format</span><span class="p">,</span> <span class="n">is_cube</span><span class="p">,</span> <span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">depth</span><span class="p">),</span> <span class="n">mips</span><span class="p">,</span> <span class="n">layers</span><span class="p">,</span> <span class="n">usage</span><span class="p">,</span> <span class="n">memory</span>
        <span class="p">),</span> <span class="n">texel_layout</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_triangle_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TriangleCollection</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">TriangleCollection</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">w_device</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_aabb_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AABBCollection</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">AABBCollection</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">w_device</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_geometry_ads</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collection</span><span class="p">:</span> <span class="n">GeometryCollection</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ADS</span><span class="p">:</span>
        <span class="n">ads</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">ranges</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span> <span class="n">scratch_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_device</span><span class="o">.</span><span class="n">create_ads</span><span class="p">(</span>
            <span class="n">geometry_type</span><span class="o">=</span><span class="n">collection</span><span class="o">.</span><span class="n">get_collection_type</span><span class="p">(),</span>
            <span class="n">descriptions</span><span class="o">=</span><span class="p">[</span>
                <span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">w_resource</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">aligned_size</span><span class="p">,</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">i</span><span class="o">.</span><span class="n">w_resource</span><span class="p">,</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">t</span><span class="o">.</span><span class="n">w_resource</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">collection</span><span class="o">.</span><span class="n">descriptions</span>
            <span class="p">]</span> <span class="k">if</span> <span class="n">collection</span><span class="o">.</span><span class="n">get_collection_type</span><span class="p">()</span> <span class="o">==</span> <span class="n">ADSNodeType</span><span class="o">.</span><span class="n">TRIANGLES</span> <span class="k">else</span> <span class="p">[</span>
                <span class="n">aabb</span><span class="o">.</span><span class="n">w_resource</span> <span class="k">for</span> <span class="n">aabb</span> <span class="ow">in</span> <span class="n">collection</span><span class="o">.</span><span class="n">descriptions</span>  <span class="c1"># AABBs are described using the buffer only</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">ADS</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ads</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span> <span class="n">scratch_size</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">ranges</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_scene_ads</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance_buffer</span><span class="p">:</span> <span class="n">Buffer</span><span class="p">):</span>
        <span class="n">ads</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">ranges</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span> <span class="n">scratch_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_device</span><span class="o">.</span><span class="n">create_ads</span><span class="p">(</span>
            <span class="n">geometry_type</span><span class="o">=</span><span class="n">ADSNodeType</span><span class="o">.</span><span class="n">INSTANCE</span><span class="p">,</span>
            <span class="n">descriptions</span><span class="o">=</span><span class="p">[</span>
                <span class="n">instance_buffer</span><span class="o">.</span><span class="n">w_resource</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">ADS</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ads</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span> <span class="n">scratch_size</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">ranges</span><span class="p">,</span> <span class="n">instance_buffer</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_instance_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instances</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">memory</span><span class="p">:</span> <span class="n">MemoryLocation</span> <span class="o">=</span> <span class="n">MemoryLocation</span><span class="o">.</span><span class="n">GPU</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StructuredBuffer</span><span class="p">:</span>
        <span class="n">instance_layout</span> <span class="o">=</span> <span class="n">Layout</span><span class="o">.</span><span class="n">from_instance</span><span class="p">()</span>
        <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_structured_buffer</span><span class="p">(</span><span class="n">instances</span><span class="p">,</span> <span class="n">element_description</span><span class="o">=</span><span class="n">instance_layout</span><span class="p">,</span> <span class="n">usage</span><span class="o">=</span><span class="n">BufferUsage</span><span class="o">.</span><span class="n">RAYTRACING_RESOURCE</span><span class="p">,</span> <span class="n">memory</span><span class="o">=</span><span class="n">memory</span><span class="p">)</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="c1"># Load default values for b</span>
        <span class="k">with</span> <span class="n">b</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">clear</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
            <span class="n">t</span><span class="o">.</span><span class="n">transform</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">t</span><span class="o">.</span><span class="n">transform</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">t</span><span class="o">.</span><span class="n">transform</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">t</span><span class="o">.</span><span class="n">mask8_idx24</span> <span class="o">=</span> <span class="n">asint32</span><span class="p">(</span><span class="mh">0xFF000000</span><span class="p">)</span>
            <span class="c1"># t.flags = 0</span>
        <span class="k">return</span> <span class="n">b</span>

    <span class="k">def</span> <span class="nf">create_sampler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                       <span class="n">mag_filter</span><span class="p">:</span> <span class="n">Filter</span> <span class="o">=</span> <span class="n">Filter</span><span class="o">.</span><span class="n">POINT</span><span class="p">,</span>
                       <span class="n">min_filter</span><span class="p">:</span> <span class="n">Filter</span> <span class="o">=</span> <span class="n">Filter</span><span class="o">.</span><span class="n">POINT</span><span class="p">,</span>
                       <span class="n">mipmap_mode</span><span class="p">:</span> <span class="n">MipMapMode</span> <span class="o">=</span> <span class="n">MipMapMode</span><span class="o">.</span><span class="n">POINT</span><span class="p">,</span>
                       <span class="n">address_U</span><span class="p">:</span> <span class="n">AddressMode</span> <span class="o">=</span> <span class="n">AddressMode</span><span class="o">.</span><span class="n">REPEAT</span><span class="p">,</span>
                       <span class="n">address_V</span><span class="p">:</span> <span class="n">AddressMode</span> <span class="o">=</span> <span class="n">AddressMode</span><span class="o">.</span><span class="n">REPEAT</span><span class="p">,</span>
                       <span class="n">address_W</span><span class="p">:</span> <span class="n">AddressMode</span> <span class="o">=</span> <span class="n">AddressMode</span><span class="o">.</span><span class="n">REPEAT</span><span class="p">,</span>
                       <span class="n">mip_LOD_bias</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
                       <span class="n">enable_anisotropy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                       <span class="n">max_anisotropy</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
                       <span class="n">enable_compare</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                       <span class="n">compare_op</span><span class="p">:</span> <span class="n">CompareOp</span> <span class="o">=</span> <span class="n">CompareOp</span><span class="o">.</span><span class="n">NEVER</span><span class="p">,</span>
                       <span class="n">min_LOD</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
                       <span class="n">max_LOD</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
                       <span class="n">border_color</span><span class="p">:</span> <span class="n">BorderColor</span> <span class="o">=</span> <span class="n">BorderColor</span><span class="o">.</span><span class="n">TRANSPARENT_BLACK_FLOAT</span><span class="p">,</span>
                       <span class="n">use_unnormalized_coordinates</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
                       <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sampler</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_device</span><span class="o">.</span><span class="n">create_sampler</span><span class="p">(</span><span class="n">mag_filter</span><span class="p">,</span> <span class="n">min_filter</span><span class="p">,</span> <span class="n">mipmap_mode</span><span class="p">,</span>
                                            <span class="n">address_U</span><span class="p">,</span> <span class="n">address_V</span><span class="p">,</span> <span class="n">address_W</span><span class="p">,</span>
                                            <span class="n">mip_LOD_bias</span><span class="p">,</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">enable_anisotropy</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
                                            <span class="n">max_anisotropy</span><span class="p">,</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">enable_compare</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
                                            <span class="n">compare_op</span><span class="p">,</span> <span class="n">min_LOD</span><span class="p">,</span> <span class="n">max_LOD</span><span class="p">,</span>
                                            <span class="n">border_color</span><span class="p">,</span>
                                            <span class="mi">1</span> <span class="k">if</span> <span class="n">use_unnormalized_coordinates</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_compute_pipeline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Pipeline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w_device</span><span class="o">.</span><span class="n">create_pipeline</span><span class="p">(</span>
            <span class="n">pipeline_type</span><span class="o">=</span><span class="n">PipelineType</span><span class="o">.</span><span class="n">COMPUTE</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">create_graphics_pipeline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">GraphicsPipeline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w_device</span><span class="o">.</span><span class="n">create_pipeline</span><span class="p">(</span>
            <span class="n">pipeline_type</span><span class="o">=</span><span class="n">PipelineType</span><span class="o">.</span><span class="n">GRAPHICS</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">create_raytracing_pipeline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">RaytracingPipeline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w_device</span><span class="o">.</span><span class="n">create_pipeline</span><span class="p">(</span>
            <span class="n">pipeline_type</span><span class="o">=</span><span class="n">PipelineType</span><span class="o">.</span><span class="n">RAYTRACING</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">create_window</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">width</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">height</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">format</span><span class="p">:</span> <span class="n">Format</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Window</span><span class="p">:</span>
        <span class="n">w_window</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_device</span><span class="o">.</span><span class="n">create_window</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Window</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w_window</span><span class="p">,</span> <span class="nb">format</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_queue_manager</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queue</span><span class="p">:</span> <span class="n">QueueType</span><span class="p">):</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_device</span><span class="o">.</span><span class="n">create_cmdList</span><span class="p">(</span><span class="n">queue</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">c</span>

    <span class="k">def</span> <span class="nf">get_graphics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GraphicsManager</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">GraphicsManager</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_queue_manager</span><span class="p">(</span><span class="n">QueueType</span><span class="o">.</span><span class="n">GRAPHICS</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_compute</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ComputeManager</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ComputeManager</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_queue_manager</span><span class="p">(</span><span class="n">QueueType</span><span class="o">.</span><span class="n">COMPUTE</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_raytracing</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RaytracingManager</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">RaytracingManager</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_queue_manager</span><span class="p">(</span><span class="n">QueueType</span><span class="o">.</span><span class="n">RAYTRACING</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CopyManager</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">CopyManager</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_queue_manager</span><span class="p">(</span><span class="n">QueueType</span><span class="o">.</span><span class="n">COPY</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">submit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">man</span><span class="p">:</span> <span class="n">CommandManager</span><span class="p">,</span> <span class="n">wait</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">man</span><span class="o">.</span><span class="n">is_frozen</span><span class="p">(),</span> <span class="s2">&quot;Only frozen managers can be submitted&quot;</span>
        <span class="k">if</span> <span class="n">wait</span><span class="p">:</span>
            <span class="n">man</span><span class="o">.</span><span class="n">w_cmdList</span><span class="o">.</span><span class="n">flush_and_wait</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">man</span><span class="o">.</span><span class="n">w_cmdList</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_device</span><span class="o">.</span><span class="n">flush_pending_and_wait</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dst</span><span class="p">:</span> <span class="n">_typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="n">_torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Resource</span><span class="p">],</span> <span class="n">src</span><span class="p">:</span> <span class="n">_typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="n">_torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Resource</span><span class="p">]):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">Resource</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">dst</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">Resource</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">src</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span>
        <span class="n">dst</span> <span class="o">=</span> <span class="n">ViewTensor</span><span class="o">.</span><span class="n">reinterpret</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">_torch</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="n">src</span> <span class="o">=</span> <span class="n">ViewTensor</span><span class="o">.</span><span class="n">reinterpret</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">_torch</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dst</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">src</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
            <span class="n">dst</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dst</span><span class="o">.</span><span class="n">is_contiguous</span><span class="p">():</span>
            <span class="n">dst</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">*</span><span class="n">src</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">src</span><span class="o">.</span><span class="n">is_contiguous</span><span class="p">(),</span> <span class="s1">&#39;If shapes are not equal, then one of the two tensor has to be contiguous&#39;</span>
        <span class="n">dst</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">*</span><span class="n">dst</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>

    <span class="c1"># def map_gpu(self, *objs: Union[_torch.Tensor, Buffer], mode: Literal[&#39;in&#39;, &#39;inout&#39;, &#39;out&#39;]=&#39;in&#39;):</span>
    <span class="c1">#     return DeviceManager.WrappedGPUPtr(self, objs, mode)</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__previous_device</span> <span class="o">=</span> <span class="n">__ACTIVE_DEVICE__</span>
        <span class="k">return</span> <span class="n">device_manager</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">device_manager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__previous_device</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">NoneDeviceManager</span><span class="p">(</span><span class="n">DeviceManager</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_raise_access_error</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_typing</span><span class="o">.</span><span class="n">Any</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;No active device, use create_device&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">submit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">man</span><span class="p">:</span> <span class="n">CommandManager</span><span class="p">,</span> <span class="n">wait</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raise_access_error</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">torch_ptr_to_device_ptr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="n">_torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raise_access_error</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__bind__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w_device</span><span class="p">:</span> <span class="n">_internal</span><span class="o">.</span><span class="n">DeviceWrapper</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raise_access_error</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">get_compute</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ComputeManager</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raise_access_error</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CopyManager</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raise_access_error</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_graphics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GraphicsManager</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raise_access_error</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_raytracing</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RaytracingManager</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raise_access_error</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">create_triangle_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TriangleCollection</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raise_access_error</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">create_compute_pipeline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raise_access_error</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">create_graphics_pipeline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raise_access_error</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">create_scene_ads</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance_buffer</span><span class="p">:</span> <span class="n">Buffer</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raise_access_error</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">create_raytracing_pipeline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raise_access_error</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">create_aabb_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AABBCollection</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raise_access_error</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">create_geometry_ads</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collection</span><span class="p">:</span> <span class="n">GeometryCollection</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ADS</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raise_access_error</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">create_tensor_like</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="n">_torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raise_access_error</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">create_window</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">width</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">height</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">format</span><span class="p">:</span> <span class="n">Format</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Window</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raise_access_error</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">create_buffer_like</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="n">_typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="n">_torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Resource</span><span class="p">],</span> <span class="n">memory</span><span class="p">:</span> <span class="n">MemoryLocation</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raise_access_error</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">create_instance_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instances</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">memory</span><span class="p">:</span> <span class="n">MemoryLocation</span> <span class="o">=</span> <span class="n">MemoryLocation</span><span class="o">.</span><span class="n">GPU</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StructuredBuffer</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raise_access_error</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">create_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">shape</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">_torch</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">memory</span><span class="p">:</span> <span class="n">MemoryLocation</span> <span class="o">=</span> <span class="n">MemoryLocation</span><span class="o">.</span><span class="n">GPU</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raise_access_error</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">create_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">usage</span><span class="p">:</span> <span class="n">BufferUsage</span> <span class="o">=</span> <span class="n">BufferUsage</span><span class="o">.</span><span class="n">STORAGE</span><span class="p">,</span> <span class="n">memory</span><span class="p">:</span> <span class="n">MemoryLocation</span> <span class="o">=</span> <span class="n">MemoryLocation</span><span class="o">.</span><span class="n">GPU</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Buffer</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raise_access_error</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">create_object_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element_description</span><span class="p">:</span> <span class="n">_typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">type</span><span class="p">,</span> <span class="n">_torch</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">Layout</span><span class="p">,</span> <span class="n">_typing</span><span class="o">.</span><span class="n">List</span><span class="p">,</span> <span class="n">_typing</span><span class="o">.</span><span class="n">Dict</span><span class="p">],</span>
                             <span class="n">usage</span><span class="p">:</span> <span class="n">BufferUsage</span> <span class="o">=</span> <span class="n">BufferUsage</span><span class="o">.</span><span class="n">STORAGE</span><span class="p">,</span> <span class="n">memory</span><span class="p">:</span> <span class="n">MemoryLocation</span> <span class="o">=</span> <span class="n">MemoryLocation</span><span class="o">.</span><span class="n">GPU</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raise_access_error</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">create_structured_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">count</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">element_description</span><span class="p">:</span> <span class="n">_typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">type</span><span class="p">,</span> <span class="n">_torch</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">Layout</span><span class="p">,</span> <span class="n">_typing</span><span class="o">.</span><span class="n">List</span><span class="p">,</span> <span class="n">_typing</span><span class="o">.</span><span class="n">Dict</span><span class="p">],</span>
                      <span class="n">usage</span><span class="p">:</span> <span class="n">BufferUsage</span> <span class="o">=</span> <span class="n">BufferUsage</span><span class="o">.</span><span class="n">STORAGE</span><span class="p">,</span> <span class="n">memory</span><span class="p">:</span> <span class="n">MemoryLocation</span> <span class="o">=</span> <span class="n">MemoryLocation</span><span class="o">.</span><span class="n">GPU</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StructuredBuffer</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raise_access_error</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">create_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_type</span><span class="p">:</span> <span class="n">ImageType</span><span class="p">,</span> <span class="n">is_cube</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">image_format</span><span class="p">:</span> <span class="n">Format</span><span class="p">,</span>
                     <span class="n">width</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">height</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">depth</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                     <span class="n">mips</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">layers</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                     <span class="n">usage</span><span class="p">:</span> <span class="n">ImageUsage</span> <span class="o">=</span> <span class="n">ImageUsage</span><span class="o">.</span><span class="n">SAMPLED</span><span class="p">,</span> <span class="n">memory</span><span class="p">:</span> <span class="n">MemoryLocation</span> <span class="o">=</span> <span class="n">MemoryLocation</span><span class="o">.</span><span class="n">GPU</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raise_access_error</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">create_sampler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                       <span class="n">mag_filter</span><span class="p">:</span> <span class="n">Filter</span> <span class="o">=</span> <span class="n">Filter</span><span class="o">.</span><span class="n">POINT</span><span class="p">,</span>
                       <span class="n">min_filter</span><span class="p">:</span> <span class="n">Filter</span> <span class="o">=</span> <span class="n">Filter</span><span class="o">.</span><span class="n">POINT</span><span class="p">,</span>
                       <span class="n">mipmap_mode</span><span class="p">:</span> <span class="n">MipMapMode</span> <span class="o">=</span> <span class="n">MipMapMode</span><span class="o">.</span><span class="n">POINT</span><span class="p">,</span>
                       <span class="n">address_U</span><span class="p">:</span> <span class="n">AddressMode</span> <span class="o">=</span> <span class="n">AddressMode</span><span class="o">.</span><span class="n">REPEAT</span><span class="p">,</span>
                       <span class="n">address_V</span><span class="p">:</span> <span class="n">AddressMode</span> <span class="o">=</span> <span class="n">AddressMode</span><span class="o">.</span><span class="n">REPEAT</span><span class="p">,</span>
                       <span class="n">address_W</span><span class="p">:</span> <span class="n">AddressMode</span> <span class="o">=</span> <span class="n">AddressMode</span><span class="o">.</span><span class="n">REPEAT</span><span class="p">,</span>
                       <span class="n">mip_LOD_bias</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
                       <span class="n">enable_anisotropy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                       <span class="n">max_anisotropy</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
                       <span class="n">enable_compare</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                       <span class="n">compare_op</span><span class="p">:</span> <span class="n">CompareOp</span> <span class="o">=</span> <span class="n">CompareOp</span><span class="o">.</span><span class="n">NEVER</span><span class="p">,</span>
                       <span class="n">min_LOD</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
                       <span class="n">max_LOD</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
                       <span class="n">border_color</span><span class="p">:</span> <span class="n">BorderColor</span> <span class="o">=</span> <span class="n">BorderColor</span><span class="o">.</span><span class="n">TRANSPARENT_BLACK_FLOAT</span><span class="p">,</span>
                       <span class="n">use_unnormalized_coordinates</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
                       <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sampler</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raise_access_error</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">wrap_gpu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">_typing</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="n">_typing</span><span class="o">.</span><span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="s1">&#39;out&#39;</span><span class="p">,</span> <span class="s1">&#39;inout&#39;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">GPUPtr</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raise_access_error</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">support</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Caps</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raise_access_error</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">set_debug_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raise_access_error</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">safe_dispatch_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raise_access_error</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">release</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">load_technique</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">technique</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raise_access_error</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raise_access_error</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">execute_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">main_process</span><span class="p">:</span> <span class="n">_typing</span><span class="o">.</span><span class="n">Callable</span><span class="p">[[</span><span class="n">_typing</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">_typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]],</span> <span class="nb">bool</span><span class="p">],</span> <span class="o">*</span><span class="n">process</span><span class="p">:</span> <span class="n">_typing</span><span class="o">.</span><span class="n">Callable</span><span class="p">[[</span><span class="n">_typing</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">_typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]],</span> <span class="kc">None</span><span class="p">],</span> <span class="n">context</span><span class="p">:</span> <span class="n">_typing</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">_typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raise_access_error</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">dispatch_technique</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">technique</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raise_access_error</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dst</span><span class="p">:</span> <span class="n">_typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="n">_torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Resource</span><span class="p">],</span> <span class="n">src</span><span class="p">:</span> <span class="n">_typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="n">_torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Resource</span><span class="p">]):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raise_access_error</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">allow_cross_threading</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raise_access_error</span><span class="p">()</span>


<span class="n">__ACTIVE_DEVICE__</span><span class="p">:</span> <span class="n">DeviceManager</span> <span class="o">=</span> <span class="n">NoneDeviceManager</span><span class="p">()</span>


<div class="viewcode-block" id="device_manager">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.device_manager">[docs]</a>
<span class="k">def</span> <span class="nf">device_manager</span><span class="p">(</span><span class="n">new_device</span><span class="p">:</span> <span class="n">_typing</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">DeviceManager</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DeviceManager</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets or sets the active device used in vulky.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    new_device : Optional[DeviceManager]</span>
<span class="sd">        The device manager to be set as active. Use None if it is only require querying the currently active device.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    DeviceManager</span>
<span class="sd">        The current active device.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">__ACTIVE_DEVICE__</span>
    <span class="k">if</span> <span class="n">new_device</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">__ACTIVE_DEVICE__</span> <span class="o">=</span> <span class="n">new_device</span>
    <span class="k">return</span> <span class="n">__ACTIVE_DEVICE__</span></div>



<div class="viewcode-block" id="create_device">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.create_device">[docs]</a>
<span class="k">def</span> <span class="nf">create_device</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">device</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">set_active</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DeviceManager</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a device manager. This is the core of vulkan graphics call.</span>
<span class="sd">    This method automatically sets created device as active, further actions will use it.</span>
<span class="sd">    To change to other devices use device_manager method. e.g: device_manager(other_device)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    device: int</span>
<span class="sd">        The index of the physical device used to create vulkan device object.</span>
<span class="sd">        Default is `0`</span>
<span class="sd">    debug: bool</span>
<span class="sd">        Sets if the vulkan device will include debug layers.</span>
<span class="sd">        Default is `False`</span>
<span class="sd">    set_active: bool</span>
<span class="sd">        Sets if the created device should be set as active.</span>
<span class="sd">        Default is `True`</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    DeviceManager</span>
<span class="sd">        The created device.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    &gt;&gt;&gt; import vulky as vk</span>
<span class="sd">    &gt;&gt;&gt; vk.create_device()</span>
<span class="sd">    &gt;&gt;&gt; # Do some rendering here in the GPU0</span>
<span class="sd">    &gt;&gt;&gt; vk.quit()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">_internal</span><span class="o">.</span><span class="n">DeviceWrapper</span><span class="p">(</span>
        <span class="n">device_index</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
        <span class="n">enable_validation_layers</span><span class="o">=</span><span class="n">debug</span>
    <span class="p">)</span>
    <span class="n">dev</span> <span class="o">=</span> <span class="n">DeviceManager</span><span class="p">()</span>
    <span class="n">dev</span><span class="o">.</span><span class="n">__bind__</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">device_manager</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="k">if</span> <span class="n">set_active</span> <span class="k">else</span> <span class="n">dev</span></div>



<span class="kn">import</span> <span class="nn">atexit</span>
<div class="viewcode-block" id="quit">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.quit">[docs]</a>
<span class="nd">@atexit</span><span class="o">.</span><span class="n">register</span>
<span class="k">def</span> <span class="nf">quit</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Releases the active device from future usages.</span>
<span class="sd">    Use this function at the end of the program execution to avoid any hanging resources</span>
<span class="sd">    and properly shutdown vulkan objects</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">__ACTIVE_DEVICE__</span>
    <span class="n">__ACTIVE_DEVICE__</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
    <span class="kn">import</span> <span class="nn">gc</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span></div>



<span class="k">class</span> <span class="nc">Technique</span><span class="p">(</span><span class="n">DeviceManager</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__setup__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">__dispatch__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>


<span class="k">def</span> <span class="nf">asint32</span><span class="p">(</span><span class="n">v</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts a python integer to a valid signed int32 value</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">v</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">v</span>
    <span class="k">return</span> <span class="n">_np</span><span class="o">.</span><span class="n">uint32</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

<span class="c1"># def Extends(class_):</span>
<span class="c1">#     def wrapper(function):</span>
<span class="c1">#         setattr(class_, function.__name__, function)</span>
<span class="c1">#</span>
<span class="c1">#     return wrapper</span>


<span class="c1"># import functools</span>
<span class="c1">#</span>
<span class="c1"># __check_active_T = TypeVar(&#39;CheckActiveType&#39;)</span>
<span class="c1">#</span>
<span class="c1"># def _check_active_device(f: __check_active_T) -&gt; __check_active_T:</span>
<span class="c1">#     @functools.wraps(f)</span>
<span class="c1">#     def wrap(*args, **kwargs):</span>
<span class="c1">#         assert __ACTIVE_DEVICE__ is not None, &quot;Create a device, a presenter or set active a device.&quot;</span>
<span class="c1">#         return f(*args, **kwargs)</span>
<span class="c1">#</span>
<span class="c1">#     return wrap</span>


<span class="c1"># @_check_active_device</span>
<div class="viewcode-block" id="window">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.window">[docs]</a>
<span class="k">def</span> <span class="nf">window</span><span class="p">(</span><span class="n">width</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">height</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">format</span><span class="p">:</span> <span class="n">Format</span> <span class="o">=</span> <span class="n">Format</span><span class="o">.</span><span class="n">VEC4</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Window</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a window with specific client size and a format for the background image.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    width : int</span>
<span class="sd">        Defines the width in pixels of the window client area</span>
<span class="sd">    height: int</span>
<span class="sd">        Defines the height in pixels of the window client area</span>
<span class="sd">    format: Format</span>
<span class="sd">        Defines the type of the background image for the window. If used `Format.PRESENTER`</span>
<span class="sd">        the gamma correction is applied automatically.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        The window object already shown.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    &gt;&gt;&gt; window = vk.window(512, 512, vk.Format.VEC4)</span>
<span class="sd">    &gt;&gt;&gt; while not window.is_closed:</span>
<span class="sd">    &gt;&gt;&gt;     # Place some imgui commands here</span>
<span class="sd">    &gt;&gt;&gt;     window.tensor().copy_(torch.rand(512,512,4))  # copies a random tensor to the background</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">__ACTIVE_DEVICE__</span><span class="o">.</span><span class="n">create_window</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="nb">format</span><span class="p">)</span></div>


<span class="c1"># @_check_active_device</span>
<div class="viewcode-block" id="support">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.support">[docs]</a>
<span class="k">def</span> <span class="nf">support</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Caps</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets the set of features supported by the rendering system.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">__ACTIVE_DEVICE__</span><span class="o">.</span><span class="n">support</span><span class="p">()</span></div>


<span class="c1"># @_check_active_device</span>
<div class="viewcode-block" id="tensor_like">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.tensor_like">[docs]</a>
<span class="k">def</span> <span class="nf">tensor_like</span><span class="p">(</span><span class="n">t</span><span class="p">:</span> <span class="n">_torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a tensor in gpu vulkan memory using another tensor as reference.</span>
<span class="sd">    This tensor grants a zero_copy access from vulkan when used.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    &gt;&gt;&gt; t = vk.tensor_like(torch.rand(2, 3))</span>
<span class="sd">    &gt;&gt;&gt; print(t)</span>
<span class="sd">    tensor([[0.0, 0.0, 0.0],[0.0, 0.0, 0.0]], device=&#39;cuda&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">__ACTIVE_DEVICE__</span><span class="o">.</span><span class="n">create_tensor_like</span><span class="p">(</span><span class="n">t</span><span class="p">)</span></div>


<span class="c1"># @_check_active_device</span>
<div class="viewcode-block" id="tensor">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.tensor">[docs]</a>
<span class="k">def</span> <span class="nf">tensor</span><span class="p">(</span><span class="o">*</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">_torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a tensor using a specific shape and type with compatible memory with vulkan, cupy and numpy tensors.</span>
<span class="sd">    The underlying buffer is created with possible usage to transfer to/from, storage binding and gpu addressing.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    &gt;&gt;&gt; t = vk.tensor(2, 3)</span>
<span class="sd">    &gt;&gt;&gt; print(t)</span>
<span class="sd">    tensor([[0.0, 0.0, 0.0],[0.0, 0.0, 0.0]], device=&#39;cuda&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">__ACTIVE_DEVICE__</span><span class="o">.</span><span class="n">create_tensor</span><span class="p">(</span><span class="o">*</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span></div>

    <span class="c1"># return __ACTIVE_DEVICE__.create_tensor_buffer(*shape, dtype=dtype, memory=memory, clear=clear).as_tensor()</span>

<span class="c1"># @_check_active_device</span>
<div class="viewcode-block" id="tensor_copy">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.tensor_copy">[docs]</a>
<span class="k">def</span> <span class="nf">tensor_copy</span><span class="p">(</span><span class="n">t</span><span class="p">:</span> <span class="n">_torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ViewTensor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a clone of a tensor in a memory that is compatible with current vulkan device.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    &gt;&gt;&gt; t = torch.randn(2, 3)</span>
<span class="sd">    &gt;&gt;&gt; t_vk = vk.tensor_copy(t)</span>
<span class="sd">    &gt;&gt;&gt; print(t)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">vk_t</span> <span class="o">=</span> <span class="n">tensor</span><span class="p">(</span><span class="o">*</span><span class="n">t</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">vk_t</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">vk_t</span></div>


<span class="c1"># @_check_active_device</span>
<div class="viewcode-block" id="pipeline_raytracing">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.pipeline_raytracing">[docs]</a>
<span class="k">def</span> <span class="nf">pipeline_raytracing</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">RaytracingPipeline</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a Pipeline to manage the setup of a raytracing pipeline, resources, include and other attributes.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    &gt;&gt;&gt; pipeline = vk.pipeline_raytracing()</span>
<span class="sd">    &gt;&gt;&gt; with pipeline.shader_stages(vk.ShaderStage.RT_GENERATION):</span>
<span class="sd">    &gt;&gt;&gt;     pipeline.load_shader_from_source(...)</span>
<span class="sd">    &gt;&gt;&gt; pipeline.close()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">__ACTIVE_DEVICE__</span><span class="o">.</span><span class="n">create_raytracing_pipeline</span><span class="p">()</span></div>


<span class="c1"># @_check_active_device</span>
<div class="viewcode-block" id="pipeline_graphics">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.pipeline_graphics">[docs]</a>
<span class="k">def</span> <span class="nf">pipeline_graphics</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">GraphicsPipeline</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a Pipeline to manage the setup of a graphics pipeline, resources, include and other attributes.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    &gt;&gt;&gt; pipeline = vk.pipeline_graphics()</span>
<span class="sd">    &gt;&gt;&gt; pipeline.attach(0, render_target=vk.Format.UINT_RGBA)</span>
<span class="sd">    &gt;&gt;&gt; with pipeline.shader_stages(vk.ShaderStage.VERTEX):</span>
<span class="sd">    &gt;&gt;&gt;     pipeline.load_shader_from_source(...)</span>
<span class="sd">    &gt;&gt;&gt; pipeline.close()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">__ACTIVE_DEVICE__</span><span class="o">.</span><span class="n">create_graphics_pipeline</span><span class="p">()</span></div>


<span class="c1"># @_check_active_device</span>
<div class="viewcode-block" id="pipeline_compute">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.pipeline_compute">[docs]</a>
<span class="k">def</span> <span class="nf">pipeline_compute</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Pipeline</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a Pipeline to manage the setup of a compute pipeline, resources, include and other attributes.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    &gt;&gt;&gt; pipeline = vk.pipeline_compute()</span>
<span class="sd">    &gt;&gt;&gt; pipeline.load_shader_from_source(...)</span>
<span class="sd">    &gt;&gt;&gt; pipeline.close()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">__ACTIVE_DEVICE__</span><span class="o">.</span><span class="n">create_compute_pipeline</span><span class="p">()</span></div>


<span class="c1"># @_check_active_device</span>
<div class="viewcode-block" id="sampler">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.sampler">[docs]</a>
<span class="k">def</span> <span class="nf">sampler</span><span class="p">(</span><span class="n">mag_filter</span><span class="p">:</span> <span class="n">Filter</span> <span class="o">=</span> <span class="n">Filter</span><span class="o">.</span><span class="n">POINT</span><span class="p">,</span>
            <span class="n">min_filter</span><span class="p">:</span> <span class="n">Filter</span> <span class="o">=</span> <span class="n">Filter</span><span class="o">.</span><span class="n">POINT</span><span class="p">,</span>
            <span class="n">mipmap_mode</span><span class="p">:</span> <span class="n">MipMapMode</span> <span class="o">=</span> <span class="n">MipMapMode</span><span class="o">.</span><span class="n">POINT</span><span class="p">,</span>
            <span class="n">address_U</span><span class="p">:</span> <span class="n">AddressMode</span> <span class="o">=</span> <span class="n">AddressMode</span><span class="o">.</span><span class="n">REPEAT</span><span class="p">,</span>
            <span class="n">address_V</span><span class="p">:</span> <span class="n">AddressMode</span> <span class="o">=</span> <span class="n">AddressMode</span><span class="o">.</span><span class="n">REPEAT</span><span class="p">,</span>
            <span class="n">address_W</span><span class="p">:</span> <span class="n">AddressMode</span> <span class="o">=</span> <span class="n">AddressMode</span><span class="o">.</span><span class="n">REPEAT</span><span class="p">,</span>
            <span class="n">mip_LOD_bias</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="n">enable_anisotropy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">max_anisotropy</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="n">enable_compare</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">compare_op</span><span class="p">:</span> <span class="n">CompareOp</span> <span class="o">=</span> <span class="n">CompareOp</span><span class="o">.</span><span class="n">NEVER</span><span class="p">,</span>
            <span class="n">min_LOD</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="n">max_LOD</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="n">border_color</span><span class="p">:</span> <span class="n">BorderColor</span> <span class="o">=</span> <span class="n">BorderColor</span><span class="o">.</span><span class="n">TRANSPARENT_BLACK_FLOAT</span><span class="p">,</span>
            <span class="n">use_unnormalized_coordinates</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sampler</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a sampler that can be used to bind texture objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">__ACTIVE_DEVICE__</span><span class="o">.</span><span class="n">create_sampler</span><span class="p">(</span>
        <span class="n">mag_filter</span><span class="p">,</span> <span class="n">min_filter</span><span class="p">,</span> <span class="n">mipmap_mode</span><span class="p">,</span> <span class="n">address_U</span><span class="p">,</span> <span class="n">address_V</span><span class="p">,</span> <span class="n">address_W</span><span class="p">,</span> <span class="n">mip_LOD_bias</span><span class="p">,</span> <span class="n">enable_anisotropy</span><span class="p">,</span>
        <span class="n">max_anisotropy</span><span class="p">,</span>
        <span class="n">enable_compare</span><span class="p">,</span> <span class="n">compare_op</span><span class="p">,</span> <span class="n">min_LOD</span><span class="p">,</span> <span class="n">max_LOD</span><span class="p">,</span> <span class="n">border_color</span><span class="p">,</span> <span class="n">use_unnormalized_coordinates</span>
    <span class="p">)</span></div>


<span class="c1"># @_check_active_device</span>
<div class="viewcode-block" id="sampler_linear">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.sampler_linear">[docs]</a>
<span class="k">def</span> <span class="nf">sampler_linear</span><span class="p">(</span><span class="n">address_U</span><span class="p">:</span> <span class="n">AddressMode</span> <span class="o">=</span> <span class="n">AddressMode</span><span class="o">.</span><span class="n">REPEAT</span><span class="p">,</span>
                  <span class="n">address_V</span><span class="p">:</span> <span class="n">AddressMode</span> <span class="o">=</span> <span class="n">AddressMode</span><span class="o">.</span><span class="n">REPEAT</span><span class="p">,</span>
                  <span class="n">address_W</span><span class="p">:</span> <span class="n">AddressMode</span> <span class="o">=</span> <span class="n">AddressMode</span><span class="o">.</span><span class="n">REPEAT</span><span class="p">,</span>
                  <span class="n">mip_LOD_bias</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
                  <span class="n">enable_anisotropy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                  <span class="n">max_anisotropy</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
                  <span class="n">enable_compare</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                  <span class="n">compare_op</span><span class="p">:</span> <span class="n">CompareOp</span> <span class="o">=</span> <span class="n">CompareOp</span><span class="o">.</span><span class="n">NEVER</span><span class="p">,</span>
                  <span class="n">min_LOD</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
                  <span class="n">max_LOD</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1000.0</span><span class="p">,</span>
                  <span class="n">border_color</span><span class="p">:</span> <span class="n">BorderColor</span> <span class="o">=</span> <span class="n">BorderColor</span><span class="o">.</span><span class="n">TRANSPARENT_BLACK_FLOAT</span><span class="p">,</span>
                  <span class="n">use_unnormalized_coordinates</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
                  <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sampler</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a linear sampler that can be used to bind texture objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">__ACTIVE_DEVICE__</span><span class="o">.</span><span class="n">create_sampler</span><span class="p">(</span>
        <span class="n">Filter</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">,</span> <span class="n">Filter</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">,</span> <span class="n">MipMapMode</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">,</span> <span class="n">address_U</span><span class="p">,</span> <span class="n">address_V</span><span class="p">,</span> <span class="n">address_W</span><span class="p">,</span> <span class="n">mip_LOD_bias</span><span class="p">,</span> <span class="n">enable_anisotropy</span><span class="p">,</span>
        <span class="n">max_anisotropy</span><span class="p">,</span>
        <span class="n">enable_compare</span><span class="p">,</span> <span class="n">compare_op</span><span class="p">,</span> <span class="n">min_LOD</span><span class="p">,</span> <span class="n">max_LOD</span><span class="p">,</span> <span class="n">border_color</span><span class="p">,</span> <span class="n">use_unnormalized_coordinates</span>
    <span class="p">)</span></div>


<span class="c1"># @_check_active_device</span>
<div class="viewcode-block" id="image_1D">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.image_1D">[docs]</a>
<span class="k">def</span> <span class="nf">image_1D</span><span class="p">(</span><span class="n">image_format</span><span class="p">:</span> <span class="n">Format</span><span class="p">,</span> <span class="n">width</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">mips</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">layers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                     <span class="n">usage</span><span class="p">:</span> <span class="n">ImageUsage</span> <span class="o">=</span> <span class="n">ImageUsage</span><span class="o">.</span><span class="n">SAMPLED</span><span class="p">,</span> <span class="n">memory</span><span class="p">:</span> <span class="n">MemoryLocation</span> <span class="o">=</span> <span class="n">MemoryLocation</span><span class="o">.</span><span class="n">GPU</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Image</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a one-dimensional image object on the GPU. If mips is None, then the maximum possible value is used.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">math</span>
    <span class="k">if</span> <span class="n">mips</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mips</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">__ACTIVE_DEVICE__</span><span class="o">.</span><span class="n">create_image</span><span class="p">(</span><span class="n">ImageType</span><span class="o">.</span><span class="n">TEXTURE_1D</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">image_format</span><span class="p">,</span>
                             <span class="n">width</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mips</span><span class="p">,</span> <span class="n">layers</span><span class="p">,</span> <span class="n">usage</span><span class="p">,</span> <span class="n">memory</span><span class="o">=</span><span class="n">memory</span><span class="p">)</span></div>


<span class="c1"># @_check_active_device</span>
<div class="viewcode-block" id="image_2D">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.image_2D">[docs]</a>
<span class="k">def</span> <span class="nf">image_2D</span><span class="p">(</span><span class="n">image_format</span><span class="p">:</span> <span class="n">Format</span><span class="p">,</span> <span class="n">width</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">height</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">mips</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">layers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                     <span class="n">usage</span><span class="p">:</span> <span class="n">ImageUsage</span> <span class="o">=</span> <span class="n">ImageUsage</span><span class="o">.</span><span class="n">SAMPLED</span><span class="p">,</span> <span class="n">memory</span><span class="p">:</span> <span class="n">MemoryLocation</span> <span class="o">=</span> <span class="n">MemoryLocation</span><span class="o">.</span><span class="n">GPU</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Image</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a two-dimensional image object on the GPU. If mips is None, then the maximum possible value is used.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">math</span>
    <span class="k">if</span> <span class="n">mips</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mips</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">),</span> <span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">__ACTIVE_DEVICE__</span><span class="o">.</span><span class="n">create_image</span><span class="p">(</span><span class="n">ImageType</span><span class="o">.</span><span class="n">TEXTURE_2D</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">image_format</span><span class="p">,</span>
                             <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mips</span><span class="p">,</span> <span class="n">layers</span><span class="p">,</span> <span class="n">usage</span><span class="p">,</span> <span class="n">memory</span><span class="o">=</span><span class="n">memory</span><span class="p">)</span></div>


<span class="c1"># @_check_active_device</span>
<div class="viewcode-block" id="image_3D">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.image_3D">[docs]</a>
<span class="k">def</span> <span class="nf">image_3D</span><span class="p">(</span><span class="n">image_format</span><span class="p">:</span> <span class="n">Format</span><span class="p">,</span> <span class="n">width</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">height</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">depth</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">mips</span> <span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">layers</span> <span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                     <span class="n">usage</span><span class="p">:</span> <span class="n">ImageUsage</span> <span class="o">=</span> <span class="n">ImageUsage</span><span class="o">.</span><span class="n">SAMPLED</span><span class="p">,</span> <span class="n">memory</span><span class="p">:</span> <span class="n">MemoryLocation</span> <span class="o">=</span> <span class="n">MemoryLocation</span><span class="o">.</span><span class="n">GPU</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Image</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a three-dimensional image object on the GPU. If mips is None, then the maximum possible value is used.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">math</span>
    <span class="k">if</span> <span class="n">mips</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mips</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">depth</span><span class="p">),</span> <span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">__ACTIVE_DEVICE__</span><span class="o">.</span><span class="n">create_image</span><span class="p">(</span><span class="n">ImageType</span><span class="o">.</span><span class="n">TEXTURE_3D</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">image_format</span><span class="p">,</span>
                             <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">mips</span><span class="p">,</span> <span class="n">layers</span><span class="p">,</span> <span class="n">usage</span><span class="p">,</span> <span class="n">memory</span><span class="o">=</span><span class="n">memory</span><span class="p">)</span></div>



<div class="viewcode-block" id="external_sync">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.external_sync">[docs]</a>
<span class="k">def</span> <span class="nf">external_sync</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Must be used if a tensor bound to a pipeline depends on some external computation, e.g. CUDA.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    &gt;&gt;&gt; import vulky as vk</span>
<span class="sd">    &gt;&gt;&gt; # ... initialization</span>
<span class="sd">    &gt;&gt;&gt; b = vk.object_buffer(vk.Layout.from_structure(</span>
<span class="sd">    &gt;&gt;&gt;     ptr=torch.int64  # Ptrs in vulkan are identified with int64 type of torch</span>
<span class="sd">    &gt;&gt;&gt; ))</span>
<span class="sd">    &gt;&gt;&gt; t = torch.sigmoid(torch.randn(3, 5, device=&#39;cuda&#39;))</span>
<span class="sd">    &gt;&gt;&gt; vk.external_sync()   # this guarantees that cuda already finished computing tensor content.</span>
<span class="sd">    &gt;&gt;&gt; with b:</span>
<span class="sd">    &gt;&gt;&gt;     b.ptr = vk.wrap_gpu(t, &#39;in&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_internal</span><span class="o">.</span><span class="n">syncronize_external_computation</span><span class="p">()</span></div>



<span class="c1"># @_check_active_device</span>
<div class="viewcode-block" id="image">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.image">[docs]</a>
<span class="k">def</span> <span class="nf">image</span><span class="p">(</span><span class="n">image_type</span><span class="p">:</span> <span class="n">ImageType</span><span class="p">,</span> <span class="n">is_cube</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">image_format</span><span class="p">:</span> <span class="n">Format</span><span class="p">,</span>
                 <span class="n">width</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">height</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">depth</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                 <span class="n">mips</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">layers</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                 <span class="n">usage</span><span class="p">:</span> <span class="n">ImageUsage</span><span class="p">,</span> <span class="n">memory</span><span class="p">:</span> <span class="n">MemoryLocation</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Image</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates an image object on the specified memory (HOST or DEVICE).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">__ACTIVE_DEVICE__</span><span class="o">.</span><span class="n">create_image</span><span class="p">(</span><span class="n">image_type</span><span class="p">,</span> <span class="n">is_cube</span><span class="p">,</span> <span class="n">image_format</span><span class="p">,</span>
                              <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">mips</span><span class="p">,</span> <span class="n">layers</span><span class="p">,</span> <span class="n">usage</span><span class="p">,</span> <span class="n">memory</span><span class="p">)</span></div>


<span class="c1"># @_check_active_device</span>
<div class="viewcode-block" id="render_target">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.render_target">[docs]</a>
<span class="k">def</span> <span class="nf">render_target</span><span class="p">(</span><span class="n">image_format</span><span class="p">:</span> <span class="n">Format</span><span class="p">,</span> <span class="n">width</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">height</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Image</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a two-dimensional image object on the GPU to be used as render target.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">__ACTIVE_DEVICE__</span><span class="o">.</span><span class="n">create_image</span><span class="p">(</span><span class="n">ImageType</span><span class="o">.</span><span class="n">TEXTURE_2D</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">image_format</span><span class="p">,</span>
                             <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ImageUsage</span><span class="o">.</span><span class="n">RENDER_TARGET</span><span class="p">,</span> <span class="n">MemoryLocation</span><span class="o">.</span><span class="n">GPU</span><span class="p">)</span></div>


<span class="c1"># @_check_active_device</span>
<div class="viewcode-block" id="depth_stencil">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.depth_stencil">[docs]</a>
<span class="k">def</span> <span class="nf">depth_stencil</span><span class="p">(</span><span class="n">width</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">height</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Image</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a two-dimensional image object on the GPU to be used as depth stencil buffer.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">__ACTIVE_DEVICE__</span><span class="o">.</span><span class="n">create_image</span><span class="p">(</span><span class="n">ImageType</span><span class="o">.</span><span class="n">TEXTURE_2D</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">Format</span><span class="o">.</span><span class="n">DEPTH_STENCIL</span><span class="p">,</span>
                             <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ImageUsage</span><span class="o">.</span><span class="n">DEPTH_STENCIL</span><span class="p">,</span> <span class="n">MemoryLocation</span><span class="o">.</span><span class="n">GPU</span><span class="p">)</span></div>


<span class="c1"># @_check_active_device</span>
<div class="viewcode-block" id="scratch_buffer">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.scratch_buffer">[docs]</a>
<span class="k">def</span> <span class="nf">scratch_buffer</span><span class="p">(</span><span class="o">*</span><span class="n">adss</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Buffer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a buffer on the GPU to be used as scratch buffer for acceleration-datastructure creation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">scratch_size</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">adss</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">__ACTIVE_DEVICE__</span><span class="o">.</span><span class="n">create_buffer</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">usage</span><span class="o">=</span><span class="n">BufferUsage</span><span class="o">.</span><span class="n">RAYTRACING_ADS</span><span class="p">,</span> <span class="n">memory</span><span class="o">=</span><span class="n">MemoryLocation</span><span class="o">.</span><span class="n">GPU</span><span class="p">)</span></div>


<span class="c1"># @_check_active_device</span>
<div class="viewcode-block" id="instance_buffer">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.instance_buffer">[docs]</a>
<span class="k">def</span> <span class="nf">instance_buffer</span><span class="p">(</span><span class="n">instances</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">memory</span><span class="p">:</span> <span class="n">MemoryLocation</span> <span class="o">=</span> <span class="n">MemoryLocation</span><span class="o">.</span><span class="n">GPU</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StructuredBuffer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a buffer on the GPU to be used to store instances of a scene acceleration-datastructure.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">__ACTIVE_DEVICE__</span><span class="o">.</span><span class="n">create_instance_buffer</span><span class="p">(</span><span class="n">instances</span><span class="p">,</span> <span class="n">memory</span><span class="p">)</span></div>


<span class="c1"># @_check_active_device</span>
<div class="viewcode-block" id="ads_scene">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.ads_scene">[docs]</a>
<span class="k">def</span> <span class="nf">ads_scene</span><span class="p">(</span><span class="n">instance_buffer</span><span class="p">:</span> <span class="n">Buffer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ADS</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates an acceleration data structure for the scene elements (top-level ads).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">__ACTIVE_DEVICE__</span><span class="o">.</span><span class="n">create_scene_ads</span><span class="p">(</span><span class="n">instance_buffer</span><span class="p">)</span></div>


<span class="c1"># @_check_active_device</span>
<div class="viewcode-block" id="ads_model">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.ads_model">[docs]</a>
<span class="k">def</span> <span class="nf">ads_model</span><span class="p">(</span><span class="n">collection</span><span class="p">:</span> <span class="n">GeometryCollection</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ADS</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates an acceleration data structure for a model formed by a set of geometries (bottom-level ads).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">__ACTIVE_DEVICE__</span><span class="o">.</span><span class="n">create_geometry_ads</span><span class="p">(</span><span class="n">collection</span><span class="p">)</span></div>


<span class="c1"># @_check_active_device</span>
<div class="viewcode-block" id="buffer">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.buffer">[docs]</a>
<span class="k">def</span> <span class="nf">buffer</span><span class="p">(</span><span class="n">size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">usage</span><span class="p">:</span> <span class="n">BufferUsage</span><span class="p">,</span> <span class="n">memory</span><span class="p">:</span> <span class="n">MemoryLocation</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Buffer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a buffer for a generic usage. Cuda-visible buffers exposes a cuda_ptr and</span>
<span class="sd">    can be wrap as tensors zero-copy operation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">__ACTIVE_DEVICE__</span><span class="o">.</span><span class="n">create_buffer</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">usage</span><span class="o">=</span><span class="n">usage</span><span class="p">,</span> <span class="n">memory</span><span class="o">=</span><span class="n">memory</span><span class="p">)</span></div>


<span class="c1"># @_check_active_device</span>
<div class="viewcode-block" id="buffer_like">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.buffer_like">[docs]</a>
<span class="k">def</span> <span class="nf">buffer_like</span><span class="p">(</span><span class="n">t</span><span class="p">:</span> <span class="n">_typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="n">_torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Resource</span><span class="p">],</span> <span class="n">memory</span><span class="p">:</span> <span class="n">MemoryLocation</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Buffer</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">__ACTIVE_DEVICE__</span><span class="o">.</span><span class="n">create_buffer_like</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">memory</span><span class="p">)</span></div>


<span class="c1"># @_check_active_device</span>
<span class="k">def</span> <span class="nf">object_buffer</span><span class="p">(</span><span class="n">layout</span><span class="p">:</span> <span class="n">Layout</span><span class="p">,</span> <span class="n">usage</span><span class="p">:</span> <span class="n">BufferUsage</span> <span class="o">=</span> <span class="n">BufferUsage</span><span class="o">.</span><span class="n">UNIFORM</span><span class="p">,</span> <span class="n">memory</span><span class="p">:</span> <span class="n">MemoryLocation</span> <span class="o">=</span> <span class="n">MemoryLocation</span><span class="o">.</span><span class="n">CPU</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ObjectBuffer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a buffer for a uniform store. Uniform CPU data can be updated (cpu version) accessing to the fields.</span>
<span class="sd">    To finally update the resource (in case is allocated on the gpu) use flush_cpu().</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">__ACTIVE_DEVICE__</span><span class="o">.</span><span class="n">create_object_buffer</span><span class="p">(</span><span class="n">element_description</span><span class="o">=</span><span class="n">layout</span><span class="p">,</span> <span class="n">usage</span> <span class="o">=</span> <span class="n">usage</span><span class="p">,</span> <span class="n">memory</span> <span class="o">=</span> <span class="n">memory</span><span class="p">)</span>

<span class="c1"># @_check_active_device</span>
<span class="k">def</span> <span class="nf">structured_buffer</span><span class="p">(</span><span class="n">count</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">element_description</span><span class="p">:</span> <span class="n">_typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">type</span><span class="p">,</span> <span class="n">_torch</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">Layout</span><span class="p">,</span> <span class="n">_typing</span><span class="o">.</span><span class="n">Dict</span><span class="p">,</span> <span class="n">_typing</span><span class="o">.</span><span class="n">List</span><span class="p">],</span>
                             <span class="n">usage</span><span class="p">:</span> <span class="n">BufferUsage</span> <span class="o">=</span> <span class="n">BufferUsage</span><span class="o">.</span><span class="n">STORAGE</span><span class="p">,</span>
                             <span class="n">memory</span><span class="p">:</span> <span class="n">MemoryLocation</span> <span class="o">=</span> <span class="n">MemoryLocation</span><span class="o">.</span><span class="n">GPU</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StructuredBuffer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a buffer for a structured store. Each index is a Uniform that</span>
<span class="sd">    can be updated (cpu version) accessing to the fields.</span>
<span class="sd">    To finally update the resource (in case is allocated on the gpu) use flush_cpu().</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">__ACTIVE_DEVICE__</span><span class="o">.</span><span class="n">create_structured_buffer</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">element_description</span><span class="o">=</span><span class="n">element_description</span><span class="p">,</span> <span class="n">usage</span> <span class="o">=</span> <span class="n">usage</span><span class="p">,</span> <span class="n">memory</span> <span class="o">=</span> <span class="n">memory</span><span class="p">)</span>

<span class="c1"># @_check_active_device</span>
<div class="viewcode-block" id="index_buffer">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.index_buffer">[docs]</a>
<span class="k">def</span> <span class="nf">index_buffer</span><span class="p">(</span><span class="n">count</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                          <span class="n">memory</span><span class="p">:</span> <span class="n">MemoryLocation</span> <span class="o">=</span> <span class="n">MemoryLocation</span><span class="o">.</span><span class="n">GPU</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StructuredBuffer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a buffer for an indices store. Each index is a int32 value that</span>
<span class="sd">    can be updated (cpu version).</span>
<span class="sd">    To finally update the resource (in case is allocated on the gpu) use flush_cpu().</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">__ACTIVE_DEVICE__</span><span class="o">.</span><span class="n">create_structured_buffer</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">element_description</span><span class="o">=</span><span class="n">Layout</span><span class="o">.</span><span class="n">from_description</span><span class="p">(</span><span class="n">LayoutAlignment</span><span class="o">.</span><span class="n">SCALAR</span><span class="p">,</span> <span class="n">_torch</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="n">usage</span> <span class="o">=</span> <span class="n">BufferUsage</span><span class="o">.</span><span class="n">INDEX</span><span class="p">,</span> <span class="n">memory</span> <span class="o">=</span> <span class="n">memory</span><span class="p">)</span></div>


<span class="c1"># @_check_active_device</span>
<div class="viewcode-block" id="vertex_buffer">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.vertex_buffer">[docs]</a>
<span class="k">def</span> <span class="nf">vertex_buffer</span><span class="p">(</span><span class="n">count</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">element_description</span><span class="p">:</span> <span class="n">_typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">type</span><span class="p">,</span> <span class="n">_torch</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">Layout</span><span class="p">,</span> <span class="n">_typing</span><span class="o">.</span><span class="n">Dict</span><span class="p">,</span> <span class="n">_typing</span><span class="o">.</span><span class="n">List</span><span class="p">],</span>
                             <span class="n">memory</span><span class="p">:</span> <span class="n">MemoryLocation</span> <span class="o">=</span> <span class="n">MemoryLocation</span><span class="o">.</span><span class="n">GPU</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StructuredBuffer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a buffer for a structured store. Each index is a Uniform that</span>
<span class="sd">    can be updated (cpu version) accessing to the fields.</span>
<span class="sd">    To finally update the resource (in case is allocated on the gpu) use flush_cpu().</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">__ACTIVE_DEVICE__</span><span class="o">.</span><span class="n">create_structured_buffer</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">element_description</span><span class="o">=</span><span class="n">element_description</span><span class="p">,</span> <span class="n">usage</span> <span class="o">=</span> <span class="n">BufferUsage</span><span class="o">.</span><span class="n">VERTEX</span><span class="p">,</span> <span class="n">memory</span> <span class="o">=</span> <span class="n">memory</span><span class="p">)</span></div>


<span class="c1"># @_check_active_device</span>
<span class="c1"># def wrap_in(*objs: Any) -&gt; DeviceManager.WrappedGPUPtr:</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     Creates an uniform buffer for an int64 ptr store.</span>
<span class="c1">#     Use wrap method to take the ptr from a valid vulkan-compatible object (vulkanized tensors, buffers) or</span>
<span class="c1">#     set directly the ptr field (in that case flush_cpu is necessary).</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     return __ACTIVE_DEVICE__.map_gpu(*objs, mode=&#39;in&#39;)</span>
<span class="c1">#</span>
<span class="c1"># @_check_active_device</span>
<span class="c1"># def wrap_out(*objs: Any) -&gt; DeviceManager.WrappedGPUPtr:</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     Creates an uniform buffer for an int64 ptr store.</span>
<span class="c1">#     Use wrap method to take the ptr from a valid vulkan-compatible object (vulkanized tensors, buffers) or</span>
<span class="c1">#     set directly the ptr field (in that case flush_cpu is necessary).</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     return __ACTIVE_DEVICE__.map_gpu(*objs, mode=&#39;out&#39;)</span>
<span class="c1">#</span>
<span class="c1"># @_check_active_device</span>
<span class="c1"># def wrap_inout(*objs: Any) -&gt; DeviceManager.WrappedGPUPtr:</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     Creates an uniform buffer for an int64 ptr store.</span>
<span class="c1">#     Use wrap method to take the ptr from a valid vulkan-compatible object (vulkanized tensors, buffers) or</span>
<span class="c1">#     set directly the ptr field (in that case flush_cpu is necessary).</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     return __ACTIVE_DEVICE__.map_gpu(*objs, mode=&#39;inout&#39;)</span>

<span class="c1"># @_check_active_device</span>
<div class="viewcode-block" id="triangle_collection">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.triangle_collection">[docs]</a>
<span class="k">def</span> <span class="nf">triangle_collection</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">TriangleCollection</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a collection to store triangle meshes for ray-cast</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">__ACTIVE_DEVICE__</span><span class="o">.</span><span class="n">create_triangle_collection</span><span class="p">()</span></div>


<span class="c1"># @_check_active_device</span>
<div class="viewcode-block" id="aabb_collection">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.aabb_collection">[docs]</a>
<span class="k">def</span> <span class="nf">aabb_collection</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">AABBCollection</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a collection to store boxes for ray-cast</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">__ACTIVE_DEVICE__</span><span class="o">.</span><span class="n">create_aabb_collection</span><span class="p">()</span></div>


<span class="c1"># @_check_active_device</span>
<span class="k">def</span> <span class="nf">flush</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Flushes all pending work of vulkan submissions and wait for completion.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__ACTIVE_DEVICE__</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

<span class="c1"># @_check_active_device</span>
<span class="k">def</span> <span class="nf">torch_ptr_to_device_ptr</span><span class="p">(</span><span class="n">t</span><span class="p">:</span> <span class="n">_torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">__ACTIVE_DEVICE__</span><span class="o">.</span><span class="n">torch_ptr_to_device_ptr</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

<span class="c1"># @_check_active_device</span>
<div class="viewcode-block" id="compute_manager">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.compute_manager">[docs]</a>
<span class="k">def</span> <span class="nf">compute_manager</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">ComputeManager</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets a compute manager object that can be used to populate with compute commands.</span>
<span class="sd">    Using this object as a context will flush automatically the command list at the end.</span>
<span class="sd">    Creating an object and freeze allows to submit several times after creation.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    &gt;&gt;&gt; import vulky as vk</span>
<span class="sd">    &gt;&gt;&gt; # ... device and pipeline creation</span>
<span class="sd">    &gt;&gt;&gt; with vk.compute_manager() as man:</span>
<span class="sd">    &gt;&gt;&gt;     man.set_pipeline(my_compute_pipeline)</span>
<span class="sd">    &gt;&gt;&gt;     man.update_sets(0)</span>
<span class="sd">    &gt;&gt;&gt;     man.dispatch_threads_1D(1024*1024)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">__ACTIVE_DEVICE__</span><span class="o">.</span><span class="n">get_compute</span><span class="p">()</span></div>


<span class="c1"># @_check_active_device</span>
<div class="viewcode-block" id="copy_manager">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.copy_manager">[docs]</a>
<span class="k">def</span> <span class="nf">copy_manager</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">CopyManager</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets a copy manager object that can be used to populate with transfer commands.</span>
<span class="sd">    Using this object as a context will flush automatically the command list at the end.</span>
<span class="sd">    Creating an object and freeze allows to submit several times after creation.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    &gt;&gt;&gt; import vulky as vk</span>
<span class="sd">    &gt;&gt;&gt; # ... device and resources creation</span>
<span class="sd">    &gt;&gt;&gt; with vk.copy_manager() as man:</span>
<span class="sd">    &gt;&gt;&gt;     man.copy(resource_src, resource_dst)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">__ACTIVE_DEVICE__</span><span class="o">.</span><span class="n">get_copy</span><span class="p">()</span></div>


<span class="c1"># @_check_active_device</span>
<div class="viewcode-block" id="graphics_manager">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.graphics_manager">[docs]</a>
<span class="k">def</span> <span class="nf">graphics_manager</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">GraphicsManager</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets a graphics manager object that can be used to populate with graphics commands.</span>
<span class="sd">    Using this object as a context will flush automatically the command list at the end.</span>
<span class="sd">    Creating an object and freeze allows to submit several times after creation.</span>
<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    &gt;&gt;&gt; import vulky as vk</span>
<span class="sd">    &gt;&gt;&gt; # ... device, pipeline, buffers, framebuffers creation</span>
<span class="sd">    &gt;&gt;&gt; with vk.graphics_manager() as man:</span>
<span class="sd">    &gt;&gt;&gt;     man.set_pipeline(my_graphics_pipeline)</span>
<span class="sd">    &gt;&gt;&gt;     man.update_sets(0)</span>
<span class="sd">    &gt;&gt;&gt;     man.set_framebuffer(framebuffer)</span>
<span class="sd">    &gt;&gt;&gt;     man.bind_vertex_buffer(0, vb)</span>
<span class="sd">    &gt;&gt;&gt;     man.dispatch_primitives(6)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">__ACTIVE_DEVICE__</span><span class="o">.</span><span class="n">get_graphics</span><span class="p">()</span></div>


<span class="c1"># @_check_active_device</span>
<div class="viewcode-block" id="raytracing_manager">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.raytracing_manager">[docs]</a>
<span class="k">def</span> <span class="nf">raytracing_manager</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">RaytracingManager</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets a raytracing manager object that can be used to populate with raytracing commands.</span>
<span class="sd">    Using this object as a context will flush automatically the command list at the end.</span>
<span class="sd">    Creating an object and freeze allows to submit several times after creation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">__ACTIVE_DEVICE__</span><span class="o">.</span><span class="n">get_raytracing</span><span class="p">()</span></div>


<span class="c1"># @_check_active_device</span>
<div class="viewcode-block" id="submit">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.submit">[docs]</a>
<span class="k">def</span> <span class="nf">submit</span><span class="p">(</span><span class="n">man</span><span class="p">:</span> <span class="n">CommandManager</span><span class="p">,</span> <span class="n">wait</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Allows to submit the command list save in a manager using freeze.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    &gt;&gt;&gt; man = vk.compute_manager()</span>
<span class="sd">    &gt;&gt;&gt; # fill command list</span>
<span class="sd">    &gt;&gt;&gt; man.freeze()  # can be submitted several times to GPU</span>
<span class="sd">    &gt;&gt;&gt; vk.submit(man)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__ACTIVE_DEVICE__</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">man</span><span class="p">,</span> <span class="n">wait</span><span class="p">)</span></div>


<span class="c1"># @_check_active_device</span>
<span class="k">def</span> <span class="nf">load_technique</span><span class="p">(</span><span class="n">technique</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">__ACTIVE_DEVICE__</span><span class="o">.</span><span class="n">load_technique</span><span class="p">(</span><span class="n">technique</span><span class="p">)</span>

<span class="c1"># @_check_active_device</span>
<span class="k">def</span> <span class="nf">dispatch_technique</span><span class="p">(</span><span class="n">technique</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">__ACTIVE_DEVICE__</span><span class="o">.</span><span class="n">dispatch_technique</span><span class="p">(</span><span class="n">technique</span><span class="p">)</span>

<span class="c1"># @_check_active_device</span>
<div class="viewcode-block" id="execute_loop">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.execute_loop">[docs]</a>
<span class="k">def</span> <span class="nf">execute_loop</span><span class="p">(</span><span class="n">main_process</span><span class="p">:</span> <span class="n">_typing</span><span class="o">.</span><span class="n">Callable</span><span class="p">[[</span><span class="n">_typing</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">_typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]],</span> <span class="nb">bool</span><span class="p">],</span> <span class="o">*</span><span class="n">process</span><span class="p">:</span> <span class="n">_typing</span><span class="o">.</span><span class="n">Callable</span><span class="p">[[</span><span class="n">_typing</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">_typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]],</span> <span class="kc">None</span><span class="p">],</span> <span class="n">context</span><span class="p">:</span> <span class="n">_typing</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">_typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a thread to execute the process safety dispatching vulkan calls in the main thread</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__ACTIVE_DEVICE__</span><span class="o">.</span><span class="n">execute_loop</span><span class="p">(</span><span class="n">main_process</span><span class="p">,</span> <span class="o">*</span><span class="n">process</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span></div>


<span class="c1"># @_check_active_device</span>
<div class="viewcode-block" id="allow_cross_threading">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.allow_cross_threading">[docs]</a>
<span class="k">def</span> <span class="nf">allow_cross_threading</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Allows dispatching cross-threading vulkan calls. The safest way is to include the cross-threading code</span>
<span class="sd">    inside a loop function</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__ACTIVE_DEVICE__</span><span class="o">.</span><span class="n">allow_cross_threading</span><span class="p">()</span></div>


<span class="c1"># @_check_active_device</span>
<div class="viewcode-block" id="set_debug_name">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.set_debug_name">[docs]</a>
<span class="k">def</span> <span class="nf">set_debug_name</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sets the name for the next resource to be created.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    &gt;&gt;&gt; vk.set_debug_name(&#39;my_photons&#39;)</span>
<span class="sd">    &gt;&gt;&gt; photon_map = vk.buffer(...)  # during debug prints, this buffer name is my_photons</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__ACTIVE_DEVICE__</span><span class="o">.</span><span class="n">set_debug_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></div>


<span class="c1"># @_check_active_device</span>
<div class="viewcode-block" id="wrap_gpu">
<a class="viewcode-back" href="../../generated/vulky.html#vulky.wrap_gpu">[docs]</a>
<span class="k">def</span> <span class="nf">wrap_gpu</span><span class="p">(</span><span class="n">t</span><span class="p">:</span> <span class="n">_typing</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="n">_typing</span><span class="o">.</span><span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="s1">&#39;out&#39;</span><span class="p">,</span> <span class="s1">&#39;inout&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;in&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GPUPtr</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wraps an object to be accessible from/to the GPU depending on the mode.</span>
<span class="sd">    Returned object can be assigned to fields of type int64_t and use as reference buffers.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    &gt;&gt;&gt; import vulky as vk</span>
<span class="sd">    &gt;&gt;&gt; # ... initialization</span>
<span class="sd">    &gt;&gt;&gt; b = vk.object_buffer(vk.Layout.from_structure(</span>
<span class="sd">    &gt;&gt;&gt;     ptr=torch.int64  # Ptrs in vulkan are identified with int64 type of torch</span>
<span class="sd">    &gt;&gt;&gt; ))</span>
<span class="sd">    &gt;&gt;&gt; t = torch.zeros(3, 5, device=&#39;cuda&#39;)</span>
<span class="sd">    &gt;&gt;&gt; with b:</span>
<span class="sd">    &gt;&gt;&gt;     b.ptr = vk.wrap_gpu(t, &#39;inout&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">__ACTIVE_DEVICE__</span><span class="o">.</span><span class="n">wrap_gpu</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span></div>



</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Ludwic Leonard.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>